<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小隊戰鬥管理系統</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            padding: 20px;
            overflow-x: hidden;
        }

        /* 頁面切換按鈕 */
        .page-switch {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            display: flex;
            gap: 10px;
        }

        .switch-btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .switch-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        .switch-btn.active {
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
            text-shadow: 0 0 10px #fff;
        }

        /* 頁面容器 */
        .page {
            display: none;
            width: 100%;
        }

        .page.active {
            display: block;
        }

        /* 戰鬥控制面板 */
        .battle-controls {
            position: fixed;
            top: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.9);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 20px;
            width: 300px;
            z-index: 999;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
            max-height: 80vh;
            overflow-y: auto;
        }

        .battle-title {
            color: #00ff88;
            font-size: 1.3em;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ff88;
        }

        .squad-selector {
            margin-bottom: 15px;
        }

        .squad-selector label {
            color: #ffd700;
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .squad-checkboxes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
        }

        .squad-checkbox {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .squad-checkbox:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .squad-checkbox.selected {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
        }

        .squad-checkbox.no-attacks {
            background: rgba(255, 71, 87, 0.2);
            border-color: #ff4757;
            opacity: 0.6;
            cursor: not-allowed;
        }

        .squad-checkbox.no-attacks .squad-label {
            color: #ff4757;
        }

        .squad-checkbox input {
            display: none;
        }

        .squad-label {
            color: #fff;
            font-size: 0.9em;
            margin-bottom: 4px;
            font-weight: bold;
        }

        .squad-points {
            color: #ffd700;
            font-size: 0.8em;
            font-weight: bold;
        }

        .squad-attacks {
            color: #ff6b6b;
            font-size: 0.7em;
            font-weight: bold;
            margin-top: 2px;
        }

        .target-selector {
            margin-bottom: 15px;
        }

        .alien-buttons {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }

        .alien-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            color: #fff;
            padding: 8px 4px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .alien-btn:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
        }

        .alien-btn.selected {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.3);
            color: #ff4757;
        }

        .alien-btn-text {
            font-size: 0.6em;
            color: #ccc;
        }

        .attack-btn {
            width: 100%;
            background: linear-gradient(45deg, #ff4757 0%, #ff3742 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 10px;
            transition: all 0.3s ease;
        }

        .attack-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.5);
        }

        .attack-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
        }

        .battle-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            font-size: 0.9em;
            color: #fff;
        }

        /* 血量調整工具樣式 */
        .hp-adjustment-tool, .attack-count-tool, .points-adjustment-tool, .squad-points-tool {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }

        .hp-adjustment-tool {
            border: 1px solid #ff6b6b;
        }

        .attack-count-tool {
            border: 1px solid #9b59b6;
        }

        .points-adjustment-tool {
            border: 1px solid #ffd700;
        }

        .squad-points-tool {
            border: 1px solid #00ffff;
        }

        .tool-title {
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 10px;
        }

        .hp-adjustment-tool .tool-title {
            color: #ff6b6b;
            text-shadow: 0 0 10px #ff6b6b;
        }

        .attack-count-tool .tool-title {
            color: #9b59b6;
            text-shadow: 0 0 10px #9b59b6;
        }

        .points-adjustment-tool .tool-title {
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .squad-points-tool .tool-title {
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
        }

        .hp-controls, .points-controls, .attack-controls {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .hp-controls label, .points-controls label, .attack-controls label {
            color: #ffd700;
            font-size: 0.9em;
            font-weight: bold;
        }

        .alien-select, .hp-value-input, .points-value-input, .squad-select, .attack-count-input {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 5px;
            color: #fff;
            padding: 8px;
            font-size: 0.9em;
        }

        .alien-select:focus, .hp-value-input:focus, .points-value-input:focus, .squad-select:focus, .attack-count-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 8px rgba(0, 255, 136, 0.5);
        }

        .hp-set-btn, .points-set-btn, .attack-set-btn {
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .hp-set-btn {
            background: linear-gradient(45deg, #ff6b6b 0%, #ff5252 100%);
        }

        .points-set-btn {
            background: linear-gradient(45deg, #ffd700 0%, #ffcc02 100%);
            color: #000;
        }

        .attack-set-btn {
            background: linear-gradient(45deg, #9b59b6 0%, #8e44ad 100%);
        }

        .hp-set-btn:hover, .points-set-btn:hover, .attack-set-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        .quick-hp-buttons, .quick-points-buttons, .quick-attack-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .quick-hp-btn, .quick-points-btn, .quick-attack-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid #666;
            color: #fff;
            padding: 8px 4px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }

        .quick-hp-btn:hover, .quick-points-btn:hover, .quick-attack-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: #00ff88;
        }

        .reset-attacks-section {
            margin-top: 10px;
        }

        .reset-attacks-btn {
            width: 100%;
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .reset-attacks-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }

        .squad-points-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .squad-points-item {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #666;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .squad-points-item:hover {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }

        .squad-points-label {
            color: #00ffff;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .squad-points-value {
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 0 8px #00ffff;
        }

        .squad-points-controls {
            display: flex;
            gap: 10px;
        }

        .reset-squad-points-btn, .add-points-btn {
            flex: 1;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .reset-squad-points-btn {
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }

        .add-points-btn {
            background: linear-gradient(45deg, #00ffff 0%, #00cccc 100%);
            color: #000;
        }

        .reset-squad-points-btn:hover, .add-points-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        }

        /* 小隊管理中的點數顯示和使用 */
        .available-points {
            background: rgba(0, 255, 255, 0.2);
            border: 2px solid #00ffff;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
        }

        .available-points .points-label {
            color: #00ffff;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 0 10px #00ffff;
        }

        .points-value-container {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .points-value-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #00ffff;
            border-radius: 8px;
            color: #fff;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            width: 80px;
            padding: 5px;
            text-shadow: 0 0 10px #00ffff;
            transition: all 0.3s ease;
        }

        .points-value-input:focus {
            outline: none;
            border-color: #00ccff;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.8);
            color: #00ffff;
        }

        .points-set-button {
            background: linear-gradient(45deg, #00ffff 0%, #00cccc 100%);
            color: #000;
            border: none;
            padding: 5px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .points-set-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }

        .point-controls {
            display: flex;
            gap: 5px;
            margin-top: 8px;
            align-items: center;
        }

        .point-btn {
            background: rgba(0, 255, 255, 0.3);
            border: 1px solid #00ffff;
            color: #fff;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 25px;
        }

        .point-btn:hover {
            background: rgba(0, 255, 255, 0.5);
            transform: scale(1.1);
        }

        .point-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .point-input {
            width: 40px;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid #00ffff;
            border-radius: 3px;
            color: #fff;
            text-align: center;
            padding: 2px;
            font-size: 0.8em;
        }

        /* 標題 */
        .main-title {
            text-align: center;
            color: #00ff88;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #00ff88, 0 0 40px #00ff88;
            animation: pulse 2s ease-in-out infinite;
        }

        /* 小隊管理頁面樣式 */
        .squads-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .squad-card {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
            transition: all 0.3s ease;
        }

        .squad-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 40px rgba(0, 255, 136, 0.5);
        }

        .squad-title {
            color: #00ff88;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff88;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .squad-icon {
            font-size: 1.2em;
        }

        .attributes-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .attribute {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 10px;
            transition: all 0.3s ease;
        }

        .attribute:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: #00ff88;
        }

        .attribute-label {
            color: #ffd700;
            font-size: 0.9em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .attribute-icon {
            font-size: 1.2em;
        }

        .attribute-input {
            width: 100%;
            background: transparent;
            border: 2px solid #666;
            border-radius: 5px;
            color: #fff;
            font-size: 1.1em;
            font-weight: bold;
            text-align: center;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .attribute-input:focus {
            outline: none;
            border-color: #00ff88;
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
            color: #00ff88;
        }

        .attribute-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .attribute-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            transition: width 0.5s ease;
            border-radius: 3px;
        }

        .total-points {
            text-align: center;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: #00ffff;
            font-size: 1.1em;
            font-weight: bold;
        }

        .total-value {
            display: inline-block;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00ffff;
            border-radius: 8px;
            padding: 8px 15px;
            margin: 0 5px;
            font-size: 1.3em;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 10px #00ffff;
            min-width: 60px;
        }

        /* 戰場頁面樣式 */
        .battlefield {
            position: relative;
            width: calc(100% - 320px);
            min-height: 100vh;
            margin-left: 320px;
            padding-right: 20px;
        }

        .alien {
            position: absolute;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 5;
        }

        .alien:hover {
            transform: scale(1.1);
            z-index: 6;
        }

        .alien.targeted {
            z-index: 10;
        }

        .alien.targeted .alien-sprite {
            box-shadow: 0 0 50px rgba(255, 71, 87, 1), 0 0 100px rgba(255, 71, 87, 0.8);
            animation: targetPulse 1s ease-in-out infinite;
        }

        @keyframes targetPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .alien-sprite {
            width: 100px;
            height: 100px;
            border-radius: 20%;
            background-color: rgba(255, 255, 255, 0.9);
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.8), 0 0 60px rgba(0, 255, 136, 0.4);
            transition: all 0.3s ease;
            background-size: 80%;
            background-position: center;
            background-repeat: no-repeat;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alien:hover .alien-sprite {
            box-shadow: 0 0 40px rgba(0, 255, 136, 1), 0 0 80px rgba(0, 255, 136, 0.6);
            transform: rotate(5deg);
        }

        .hp-display {
            position: absolute;
            top: 110px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            border: 2px solid #00ff88;
            border-radius: 15px;
            padding: 8px 15px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
            z-index: 5;
        }

        .points-display {
            position: absolute;
            top: 185px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 4px 10px;
            min-width: 90px;
            text-align: center;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
            z-index: 4;
        }

        .points-label {
            color: #ffd700;
            font-size: 0.7em;
            font-weight: bold;
            margin-bottom: 2px;
            text-shadow: 0 0 8px #ffd700;
        }

        .points-input {
            background: transparent;
            border: 1px solid #ffd700;
            border-radius: 3px;
            color: #fff;
            font-size: 0.9em;
            font-weight: bold;
            text-align: center;
            width: 60px;
            outline: none;
            padding: 1px;
            height: 22px;
        }

        .points-input:focus {
            color: #ffd700;
            text-shadow: 0 0 8px #ffd700;
            border-color: #ffed4e;
        }

        .alien-id {
            color: #00ff88;
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
            text-shadow: 0 0 10px #00ff88;
        }

        .hp-input {
            background: transparent;
            border: 1px solid #00ff88;
            border-radius: 5px;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            width: 80px;
            outline: none;
            padding: 2px;
        }

        .hp-input:focus {
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
            border-color: #00ffff;
        }

        .hp-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.5);
        }

        .hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757 0%, #ffa502 50%, #2ed573 100%);
            transition: width 0.5s ease;
            border-radius: 4px;
            box-shadow: 0 0 10px currentColor;
        }

        /* 外星人位置 */
        .alien-1 { top: 10%; left: 8%; }
        .alien-2 { top: 10%; left: 55%; }
        .alien-3 { top: 25%; left: 25%; }
        .alien-4 { top: 25%; left: 70%; }
        .alien-5 { top: 40%; left: 5%; }
        .alien-6 { top: 40%; left: 40%; }
        .alien-7 { top: 55%; left: 15%; }
        .alien-8 { top: 55%; left: 60%; }
        .alien-9 { top: 70%; left: 30%; }
        .alien-10 { top: 70%; left: 75%; }

        .alien.dead .alien-sprite {
            opacity: 0.3;
            filter: grayscale(100%);
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
            background-color: rgba(100, 100, 100, 0.5);
        }

        .alien.dead .hp-display {
            border-color: #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        }

        .alien.dead .alien-id {
            color: #ff4757;
            text-shadow: 0 0 10px #ff4757;
        }

        .alien.dead .points-display {
            border-color: #ff4757;
            box-shadow: 0 0 20px rgba(255, 71, 87, 0.5);
        }

        .alien.dead .points-label {
            color: #ff4757;
            text-shadow: 0 0 10px #ff4757;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .alien {
            animation: float 4s ease-in-out infinite;
        }

        .alien:nth-child(even) {
            animation-delay: 2s;
        }

        .monster-icon {
            font-size: 60px;
        }

        /* 控制按鈕 */
        .controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }

        .btn {
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
        }

        /* 星星背景 */
        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 3s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        /* 戰鬥結果顯示 */
        .battle-result {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            border: 3px solid #00ff88;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
            z-index: 2000;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.8);
            display: none;
        }

        .result-title {
            color: #00ff88;
            font-size: 2em;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #00ff88;
        }

        .result-content {
            color: #fff;
            font-size: 1.2em;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .result-close {
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
        }

        /* 競技場地圖選擇器樣式 */
        .arena-map-selector {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b35;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
        }

        .arena-map-title {
            color: #ff6b35;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ff6b35;
        }

        .arena-map-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .arena-map-option {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #666;
            border-radius: 12px;
            padding: 15px 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .arena-map-option:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: translateY(-3px);
        }

        .arena-map-option.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.3);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);
        }

        .arena-map-icon {
            font-size: 2em;
            margin-bottom: 8px;
        }

        .arena-map-name {
            color: #fff;
            font-size: 0.9em;
            font-weight: bold;
            line-height: 1.2;
        }

        .arena-map-effects {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid #ff6b35;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            display: none;
        }

        .arena-map-effects.visible {
            display: block;
        }

        .arena-map-effects-title {
            color: #ff6b35;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }

        .arena-effect-item {
            color: #fff;
            font-size: 0.9em;
            margin-bottom: 5px;
            padding: 5px 8px;
            border-radius: 5px;
            line-height: 1.4;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .arena-effect-zero {
            background: rgba(255, 71, 87, 0.3);
            border-left: 3px solid #ff4757;
        }

        .arena-effect-nerf {
            background: rgba(255, 193, 7, 0.3);
            border-left: 3px solid #ffc107;
        }

        .arena-effect-boost {
            background: rgba(0, 255, 136, 0.3);
            border-left: 3px solid #00ff88;
        }

        /* 響應式設計 - 競技場地圖 */
        @media (max-width: 1200px) {
            .arena-map-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .arena-map-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .arena-map-option {
                min-height: 80px;
                padding: 10px 5px;
            }
            
            .arena-map-icon {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .arena-map-name {
                font-size: 0.8em;
            }
        }
        @media (max-width: 1200px) {
            .battle-controls {
                width: 250px;
            }
            
            .battlefield {
                margin-left: 270px;
                width: calc(100% - 270px);
            }
            
            .alien-2 { left: 50%; }
            .alien-4 { left: 65%; }
            .alien-6 { left: 35%; }
            .alien-8 { left: 55%; }
            .alien-10 { left: 70%; }
        }

        @media (max-width: 768px) {
            .main-title {
                font-size: 2em;
            }
            
            .squads-container {
                grid-template-columns: 1fr;
            }
            
            .battle-controls {
                position: static;
                width: 100%;
                margin-bottom: 20px;
            }
            
            .battlefield {
                margin-left: 0;
                width: 100%;
                padding-right: 10px;
            }
            
            .alien-1 { top: 10%; left: 5%; }
            .alien-2 { top: 10%; left: 55%; }
            .alien-3 { top: 25%; left: 30%; }
            .alien-4 { top: 25%; left: 75%; }
            .alien-5 { top: 40%; left: 5%; }
            .alien-6 { top: 40%; left: 55%; }
            .alien-7 { top: 55%; left: 30%; }
            .alien-8 { top: 55%; left: 75%; }
            .alien-9 { top: 70%; left: 15%; }
            .alien-10 { top: 70%; left: 65%; }
            
            .alien-sprite {
                width: 80px;
                height: 80px;
            }
            
            .hp-display {
                top: 90px;
                padding: 6px 12px;
                min-width: 100px;
            }

            .points-display {
                top: 155px;
            }
            
            .hp-input, .points-input {
                font-size: 1em;
                width: 70px;
            }

            .monster-icon {
                font-size: 50px;
            }
        }

        /* 競技場頁面樣式 */
        .arena-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 30px;
            align-items: start;
        }

        /* 小隊選擇區域 */
        .squad-selector-arena {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .selector-title {
            color: #00ff88;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff88;
        }

        .squad-options {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .squad-option {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .squad-option:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #00ff88;
        }

        .squad-option.selected {
            background: rgba(0, 255, 136, 0.3);
            border-color: #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .squad-name {
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .squad-total {
            color: #ffd700;
            font-size: 1em;
            font-weight: bold;
        }

        /* 戰鬥區域 */
        .battle-area-arena {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ff4757;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(255, 71, 87, 0.5);
            min-height: 600px;
        }

        .battle-title-arena {
            color: #ff4757;
            font-size: 2em;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 15px #ff4757;
        }

        .vs-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
        }

        .squad-display {
            text-align: center;
            flex: 1;
        }

        .squad-display-name {
            color: #00ffff;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 0 10px #00ffff;
        }

        .squad-display-total {
            color: #ffd700;
            font-size: 1.2em;
            font-weight: bold;
        }

        .vs-text {
            color: #ff4757;
            font-size: 3em;
            font-weight: bold;
            text-shadow: 0 0 20px #ff4757;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #ff4757; }
            to { text-shadow: 0 0 30px #ff4757, 0 0 40px #ff4757; }
        }

        .battle-button-arena {
            width: 100%;
            background: linear-gradient(45deg, #ff4757 0%, #ff3742 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(255, 71, 87, 0.3);
        }

        .battle-button-arena:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 71, 87, 0.5);
        }

        .battle-button-arena:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* 比較結果顯示 */
        .comparison-results {
            display: none;
        }

        .comparison-results.active {
            display: block;
        }

        .attribute-comparison {
            display: grid;
            grid-template-columns: 1fr auto 1fr auto 1fr;
            gap: 15px;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .attribute-comparison.winner {
            background: rgba(0, 255, 136, 0.2);
            border-color: #00ff88;
        }

        .attribute-name {
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            font-size: 1.1em;
        }

        .attribute-value {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 10px;
            text-align: center;
            color: #fff;
            font-weight: bold;
            font-size: 1.2em;
        }

        .attribute-value.winner {
            border-color: #00ff88;
            color: #00ff88;
            text-shadow: 0 0 10px #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }

        .attribute-value.loser {
            border-color: #ff4757;
            color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .vs-icon {
            color: #ff4757;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
        }

        /* 最終結果 */
        .final-result {
            margin-top: 30px;
            padding: 25px;
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.2) 0%, rgba(0, 255, 136, 0.2) 100%);
            border-radius: 15px;
            border: 3px solid #ffd700;
            text-align: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .final-result-title {
            color: #ffd700;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 15px #ffd700;
        }

        .score-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
        }

        .score-item {
            text-align: center;
        }

        .score-label {
            color: #00ffff;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .score-value {
            color: #fff;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 10px #fff;
        }

        .winner-announcement {
            color: #00ff88;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 20px #00ff88;
            animation: victory 1s ease-in-out infinite alternate;
        }

        @keyframes victory {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* 重置按鈕 */
        .reset-button-arena {
            width: 100%;
            background: linear-gradient(45deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .reset-button-arena:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        /* 總能力值比較樣式 */
        .total-comparison {
            background: linear-gradient(45deg, rgba(255, 71, 87, 0.1) 0%, rgba(0, 255, 136, 0.1) 100%);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 25px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .total-comparison-title {
            color: #ffd700;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 25px;
            text-shadow: 0 0 15px #ffd700;
        }

        .total-vs-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .total-squad-info {
            text-align: center;
            flex: 1;
        }

        .total-squad-name {
            color: #00ffff;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #00ffff;
        }

        .total-value {
            font-size: 3em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 20px #fff;
            background: rgba(0, 0, 0, 0.5);
            border: 3px solid #666;
            border-radius: 15px;
            padding: 20px;
            display: inline-block;
            min-width: 120px;
        }

        .total-value.winner {
            color: #00ff88;
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            text-shadow: 0 0 25px #00ff88;
            animation: totalWinnerGlow 2s ease-in-out infinite alternate;
        }

        .total-value.loser {
            color: #ff4757;
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
            opacity: 0.8;
        }

        @keyframes totalWinnerGlow {
            from { 
                box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
                transform: scale(1);
            }
            to { 
                box-shadow: 0 0 40px rgba(0, 255, 136, 0.8);
                transform: scale(1.05);
            }
        }

        .total-vs-text {
            color: #ff4757;
            font-size: 2.5em;
            font-weight: bold;
            text-shadow: 0 0 20px #ff4757;
            margin: 0 20px;
        }

        .total-difference {
            text-align: center;
            color: #ffd700;
            font-size: 1.2em;
            font-weight: bold;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 10px;
            padding: 15px;
            text-shadow: 0 0 10px #ffd700;
        }

        /* 詳細屬性比較樣式 */
        .attribute-details {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid #666;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .details-title {
            color: #00ffff;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ffff;
        }

        .details-grid {
            display: grid;
            gap: 8px;
        }

        .detail-row {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 15px;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .detail-value {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 8px;
            text-align: center;
            color: #fff;
            font-weight: bold;
        }

        .detail-value.detail-winner {
            border-color: #00ff88;
            color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
            text-shadow: 0 0 8px #00ff88;
        }

        .detail-attr {
            color: #ffd700;
            font-weight: bold;
            text-align: center;
            font-size: 1em;
        }

        /* 最終結果樣式調整 */
        .victory-details, .tie-details {
            color: #fff;
            font-size: 1.1em;
            margin-top: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            line-height: 1.6;
        }

        /* 響應式設計 - 總能力值比較 */
        @media (max-width: 768px) {
            .total-vs-display {
                flex-direction: column;
                gap: 20px;
            }
            
            .total-vs-text {
                order: 2;
                font-size: 2em;
                margin: 10px 0;
            }
            
            .total-value {
                font-size: 2.5em;
                min-width: 100px;
                padding: 15px;
            }
            
            .detail-row {
                grid-template-columns: 1fr;
                gap: 8px;
                text-align: center;
            }
        }

        /* 道具牆頁面樣式 */
        .items-container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 30px;
        }

        .items-wall {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ff6b35;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(255, 107, 53, 0.3);
        }

        .items-wall-title {
            color: #ff6b35;
            font-size: 1.8em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 15px #ff6b35;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .item-card:hover {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.2);
            transform: translateY(-3px);
        }

        .item-card.taken {
            background: rgba(255, 71, 87, 0.3);
            border-color: #ff4757;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .item-card.taken:hover {
            transform: none;
        }

        .item-name {
            color: #fff;
            font-size: 1em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-taken-by {
            color: #ff4757;
            font-size: 0.8em;
        }

        .squad-selection-panel {
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #00ff88;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .selection-title {
            color: #00ff88;
            font-size: 1.5em;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #00ff88;
        }

        .squad-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .squad-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            color: #fff;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .squad-btn:hover {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
        }

        .squad-btn.selected {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 15px rgba(0, 255, 136, 0.5);
        }

        .selected-item-display {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #666;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .no-selection {
            color: #888;
            font-style: italic;
        }

        .selected-item-name {
            color: #ff6b35;
            font-size: 1.2em;
            font-weight: bold;
            text-shadow: 0 0 10px #ff6b35;
        }

        .assign-btn {
            width: 100%;
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .assign-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.5);
        }

        .assign-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
            transform: none;
            box-shadow: none;
        }
        
        .undo-btn {
            width: 100%;
            background: linear-gradient(45deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s ease;
            margin-top: 10px;
        }
        
        .undo-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.5);
        }
        
        .undo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
            transform: none;
            box-shadow: none;
        }

        /* 下注系統樣式 */
        .betting-system {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .betting-system.active {
            display: block;
        }

        .betting-title {
            color: #ffd700;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ffd700;
        }

        .betting-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .betting-matchup {
            color: #00ffff;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .betting-reward {
            color: #ffd700;
            font-size: 1em;
            font-weight: bold;
        }

        .betting-options {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .betting-side {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #666;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .betting-side:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.1);
        }

        .betting-side.selected {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        .betting-squad-name {
            color: #00ffff;
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .betting-odds {
            color: #ffd700;
            font-size: 1.1em;
            font-weight: bold;
        }

        .betting-vs {
            color: #ff4757;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 0 15px #ff4757;
        }

        .betting-participants {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .betting-participants-title {
            color: #00ffff;
            font-size: 1.1em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .betting-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .betting-squad-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid #666;
            border-radius: 8px;
            padding: 10px 5px;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 0.9em;
            font-weight: bold;
        }

        .betting-squad-btn:hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
        }

        .betting-squad-btn.bet-a {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }

        .betting-squad-btn.bet-b {
            border-color: #ff4757;
            background: rgba(255, 71, 87, 0.2);
            color: #ff4757;
        }

        .betting-squad-btn.fighting {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .betting-summary {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .betting-summary-side {
            text-align: center;
        }

        .betting-count {
            color: #ffd700;
            font-size: 1.5em;
            font-weight: bold;
        }

        .betting-label {
            color: #ccc;
            font-size: 0.9em;
            margin-top: 5px;
        }

        .betting-summary-vs {
            color: #ff4757;
            font-size: 1.5em;
            font-weight: bold;
        }

        .betting-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .betting-btn {
            background: linear-gradient(45deg, #ffd700 0%, #ffed4e 100%);
            color: #000;
            border: none;
            padding: 12px 25px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .betting-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 215, 0, 0.4);
        }

        .betting-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #666;
            color: #ccc;
            transform: none;
            box-shadow: none;
        }

        .clear-bets-btn {
            background: linear-gradient(45deg, #ff4757 0%, #ff3742 100%);
            color: white;
        }

        .betting-results {
            background: rgba(255, 215, 0, 0.1);
            border: 2px solid #ffd700;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            display: none;
        }

        .betting-results.active {
            display: block;
        }

        .betting-results-title {
            color: #ffd700;
            font-size: 1.5em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px #ffd700;
        }

        .betting-winner-announcement {
            background: rgba(0, 255, 136, 0.2);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }

        .betting-winner-text {
            color: #00ff88;
            font-size: 1.3em;
            font-weight: bold;
            text-shadow: 0 0 10px #00ff88;
        }

        .betting-rewards-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
        }

        .betting-rewards-title {
            color: #ffd700;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }

        .betting-reward-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            margin-bottom: 8px;
            background: rgba(255, 215, 0, 0.1);
            border-radius: 8px;
            border-left: 4px solid #ffd700;
        }

        .betting-reward-squad {
            color: #00ffff;
            font-weight: bold;
        }

        .betting-reward-points {
            color: #ffd700;
            font-size: 1.1em;
            font-weight: bold;
        }
        .rankings-container {
            max-width: 1000px;
            margin: 0 auto;
        }

        .rankings-board {
            background: rgba(0, 0, 0, 0.9);
            border: 3px solid #ffd700;
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.5);
        }

        .rankings-title {
            color: #ffd700;
            font-size: 2.5em;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #ffd700;
        }

        .rankings-list {
            display: grid;
            gap: 15px;
        }

        .ranking-item {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.1) 0%, rgba(255, 215, 0, 0.05) 100%);
            border: 2px solid #666;
            border-radius: 15px;
            padding: 20px;
            display: grid;
            grid-template-columns: 80px 1fr 120px 120px;
            gap: 20px;
            align-items: center;
            transition: all 0.3s ease;
        }

        .ranking-item:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .ranking-item.rank-1 {
            border-color: #ffd700;
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.3) 0%, rgba(255, 215, 0, 0.1) 100%);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
        }

        .ranking-item.rank-2 {
            border-color: #c0c0c0;
            background: linear-gradient(45deg, rgba(192, 192, 192, 0.2) 0%, rgba(192, 192, 192, 0.05) 100%);
        }

        .ranking-item.rank-3 {
            border-color: #cd7f32;
            background: linear-gradient(45deg, rgba(205, 127, 50, 0.2) 0%, rgba(205, 127, 50, 0.05) 100%);
        }

        .rank-number {
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            color: #ffd700;
            text-shadow: 0 0 10px #ffd700;
        }

        .rank-1 .rank-number {
            color: #ffd700;
            font-size: 2.5em;
        }

        .rank-2 .rank-number {
            color: #c0c0c0;
        }

        .rank-3 .rank-number {
            color: #cd7f32;
        }

        .squad-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .squad-rank-name {
            color: #00ffff;
            font-size: 1.3em;
            font-weight: bold;
        }

        .squad-skills {
            color: #888;
            font-size: 0.9em;
        }

        .squad-score {
            color: #fff;
            font-size: 1.8em;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 10px #fff;
        }
        
        .squad-score-container {
        display: flex;
        align-items: center;
        gap: 5px;
        }
        
        .squad-score-input {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            border-radius: 8px;
            color: #fff;
            font-size: 1.6em;
            font-weight: bold;
            text-align: center;
            text-shadow: 0 0 10px #fff;
            width: 100px;
            padding: 5px;
            transition: all 0.3s ease;
        }
        
        .squad-score-input:focus {
            outline: none;
            border-color: #ffed4e;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
            color: #ffd700;
        }
        
        .score-update-btn {
            background: linear-gradient(45deg, #00ff88 0%, #00cc6a 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .score-update-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }
        
        .squad-power {
            color: #ffd700;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
        }

        /* 被動技能選擇樣式 */
        .passive-skill-selector {
            background: rgba(138, 43, 226, 0.2);
            border: 2px solid #8a2be2;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
        }

        .passive-skill-title {
            color: #8a2be2;
            font-size: 1.2em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #8a2be2;
        }

        .passive-skill-dropdown {
            width: 100%;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #8a2be2;
            border-radius: 8px;
            color: #fff;
            padding: 10px;
            font-size: 1em;
            font-weight: bold;
        }

        .passive-skill-dropdown:focus {
            outline: none;
            border-color: #ba55d3;
            box-shadow: 0 0 15px rgba(138, 43, 226, 0.8);
        }

        .current-passive-skill {
            color: #8a2be2;
            font-size: 1em;
            text-align: center;
            margin-top: 10px;
            font-weight: bold;
            text-shadow: 0 0 10px #8a2be2;
        }

        /* 技能顯示樣式 */
        .skill-display {
            background: rgba(255, 107, 53, 0.1);
            border: 1px solid #ff6b35;
            border-radius: 8px;
            padding: 8px;
            margin-top: 5px;
        }

        .skill-name {
            color: #ff6b35;
            font-size: 0.9em;
            font-weight: bold;
        }

        .reveal-skills-btn {
            width: 100%;
            background: linear-gradient(45deg, #8a2be2 0%, #9370db 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(138, 43, 226, 0.3);
        }

        .reveal-skills-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(138, 43, 226, 0.5);
        }

        .reveal-skills-btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .skills-revealed {
            background: rgba(138, 43, 226, 0.1);
            border: 2px solid #8a2be2;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .skills-revealed-title {
            color: #8a2be2;
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 0 10px #8a2be2;
        }

        .squad-skill-info {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .squad-skill-name {
            color: #00ffff;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .skill-details {
            margin-bottom: 10px;
        }

        .skill-type {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .skill-description {
            color: #fff;
            font-size: 0.9em;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .skill-effect {
            color: #ff6b35;
            font-weight: bold;
            font-size: 0.9em;
        }

        /* 新增CSS動畫 */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
        
        .item-card.selected {
            border-color: #ff6b35;
            background: rgba(255, 107, 53, 0.4);
            box-shadow: 0 0 20px rgba(255, 107, 53, 0.8);
            transform: translateY(-5px);
        }
        
        .squad-btn.has-item {
            background: rgba(255, 107, 53, 0.2);
            border-color: #ff6b35;
        }
        
        @media (max-width: 768px) {
            .page-switch {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .switch-btn {
                font-size: 0.9em;
                padding: 10px 15px;
            }
            
            .items-container {
                grid-template-columns: 1fr;
            }
            
            .items-grid {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            }
            
            .item-card {
                min-height: 140px;
                font-size: 0.9em;
            }
            
            .rankings-list .ranking-item {
                grid-template-columns: 60px 1fr 80px;
                gap: 10px;
            }
            
            .squad-power {
                display: none;
            }
            
            .arena-container {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .selected-item-display {
                min-height: 180px;
                font-size: 0.9em;
            }
            
            /* 下注系統響應式 */
            .betting-options {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .betting-vs {
                order: -1;
                font-size: 1.5em;
            }
            
            .betting-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }
            
            .betting-squad-btn {
                font-size: 0.8em;
                padding: 8px 4px;
            }
            
            .betting-summary {
                grid-template-columns: 1fr;
                gap: 10px;
                text-align: center;
            }
            
            .betting-summary-vs {
                order: -1;
            }
            
            .betting-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .betting-btn {
                width: 100%;
                padding: 15px;
            }
            
            .betting-reward-item {
                flex-direction: column;
                text-align: center;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <!-- 頁面切換按鈕 -->
    <div class="page-switch">
        <button class="switch-btn active" onclick="switchPage('squads')">小隊管理</button>
        <button class="switch-btn" onclick="switchPage('battlefield')">戰場</button>
        <button class="switch-btn" onclick="switchPage('arena')">競技場</button>
        <button class="switch-btn" onclick="switchPage('items')">道具牆</button>
        <button class="switch-btn" onclick="switchPage('rankings')">積分排行</button>
    </div>

    <!-- 小隊管理頁面 -->
    <div class="page active" id="squads-page">
        <h1 class="main-title">🎮 小隊能力值管理系統 🎮</h1>
        
        <div class="controls">
            <button class="btn" onclick="resetAllSquads()">重置所有小隊</button>
            <button class="btn" onclick="randomizeAllSquads()">隨機屬性</button>
            <button class="btn" onclick="showStatistics()">統計數據</button>
        </div>

        <div class="squads-container" id="squads-container">
            <!-- 小隊卡片將在這裡動態生成 -->
        </div>
    </div>

    <!-- 道具牆頁面 -->
    <div class="page" id="items-page">
        <h1 class="main-title">🎁 道具牆 🎁</h1>
        
        <div class="items-container">
            <!-- 道具牆 -->
            <div class="items-wall">
                <h2 class="items-wall-title">💎 技能卡道具牆</h2>
                <div class="items-grid" id="items-grid">
                    <!-- 技能卡將在這裡動態生成 -->
                </div>
            </div>

            <!-- 小隊選擇面板 -->
            <div class="squad-selection-panel">
                <h2 class="selection-title">選擇小隊</h2>
                
                <div class="selected-item-display" id="selected-item-display">
                    <div class="no-selection">請先選擇一個技能卡</div>
                </div>
                
                <div class="squad-buttons" id="squad-buttons">
                    <!-- 小隊按鈕將在這裡動態生成 -->
                </div>
                
                <button class="assign-btn" id="assign-btn" onclick="assignItemToSquad()" disabled>
                    分配技能卡
                </button>
                <button class="undo-btn" id="undo-btn" onclick="undoLastAssignment()" disabled>
                    ↩️ 撤銷上一步
                </button>
            </div>
        </div>
    </div>

    <!-- 積分排行頁面 -->
    <div class="page" id="rankings-page">
        <h1 class="main-title">🏆 積分排行榜 🏆</h1>
        
        <div class="rankings-container">
            <div class="rankings-board">
                <h2 class="rankings-title">小隊積分排行</h2>
                <div class="rankings-list" id="rankings-list">
                    <!-- 排行榜將在這裡動態生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 戰場頁面 -->
    <div class="page" id="battlefield-page">
        <!-- 戰鬥控制面板 -->
        <div class="battle-controls">
            <div class="battle-title">⚔️ 戰鬥控制 ⚔️</div>
            
            <div class="squad-selector">
                <label>選擇攻擊小隊:</label>
                <div class="squad-checkboxes" id="squad-checkboxes">
                    <!-- 小隊選擇框將在這裡生成 -->
                </div>
            </div>
            
            <div class="target-selector">
                <label>選擇目標外星人:</label>
                <div class="alien-buttons">
                    <button class="alien-btn" onclick="selectTarget(1)">
                        👾
                        <span class="alien-btn-text">#1</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(2)">
                        👹
                        <span class="alien-btn-text">#2</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(3)">
                        👺
                        <span class="alien-btn-text">#3</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(4)">
                        😼
                        <span class="alien-btn-text">#4</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(5)">
                        👻
                        <span class="alien-btn-text">#5</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(6)">
                        🎃
                        <span class="alien-btn-text">#6</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(7)">
                        🤡
                        <span class="alien-btn-text">#7</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(8)">
                        💀
                        <span class="alien-btn-text">#8</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(9)">
                        🦖
                        <span class="alien-btn-text">#9</span>
                    </button>
                    <button class="alien-btn" onclick="selectTarget(10)">
                        🐙
                        <span class="alien-btn-text">#10</span>
                    </button>
                </div>
            </div>
            
            <button class="attack-btn" id="attack-btn" onclick="executeAttack()" disabled>
                發動攻擊
            </button>

            <div class="battle-info" id="battle-info">
                選擇小隊和目標開始戰鬥
            </div>

            <!-- 血量調整工具 -->
            <div class="hp-adjustment-tool">
                <div class="tool-title">🩸 血量調整工具</div>
                <div class="hp-controls">
                    <label>選擇外星人:</label>
                    <select id="hp-alien-select" class="alien-select">
                        <option value="">選擇外星人</option>
                        <option value="1">外星人 #1 (👾)</option>
                        <option value="2">外星人 #2 (👹)</option>
                        <option value="3">外星人 #3 (👺)</option>
                        <option value="4">外星人 #4 (😼)</option>
                        <option value="5">外星人 #5 (👻)</option>
                        <option value="6">外星人 #6 (🎃)</option>
                        <option value="7">外星人 #7 (🤡)</option>
                        <option value="8">外星人 #8 (💀)</option>
                        <option value="9">外星人 #9 (🦖)</option>
                        <option value="10">外星人 #10 (🐙)</option>
                    </select>
                    
                    <label>設定血量:</label>
                    <input type="number" id="hp-value-input" placeholder="輸入血量" min="0" max="9999" class="hp-value-input">
                    
                    <button class="hp-set-btn" onclick="setAlienHp()">設定血量</button>
                </div>
                
                <div class="quick-hp-buttons">
                    <button class="quick-hp-btn" onclick="setAllAliensHp('max')">全部滿血</button>
                    <button class="quick-hp-btn" onclick="setAllAliensHp('half')">全部半血</button>
                    <button class="quick-hp-btn" onclick="setAllAliensHp('zero')">全部歸零</button>
                </div>
            </div>

            <!-- 攻擊次數調整工具 -->
            <div class="attack-count-tool">
                <div class="tool-title">⚡ 攻擊次數管理</div>
                <div class="attack-controls">
                    <label>選擇小隊:</label>
                    <select id="attack-squad-select" class="squad-select">
                        <option value="">選擇小隊</option>
                        <option value="1">小隊 #1</option>
                        <option value="2">小隊 #2</option>
                        <option value="3">小隊 #3</option>
                        <option value="4">小隊 #4</option>
                        <option value="5">小隊 #5</option>
                        <option value="6">小隊 #6</option>
                        <option value="7">小隊 #7</option>
                        <option value="8">小隊 #8</option>
                        <option value="9">小隊 #9</option>
                        <option value="10">小隊 #10</option>
                    </select>
                    
                    <label>設定攻擊次數:</label>
                    <input type="number" id="attack-count-input" placeholder="輸入次數" min="0" max="99" class="attack-count-input">
                    
                    <button class="attack-set-btn" onclick="setSquadAttackCount()">設定次數</button>
                </div>
                
                <div class="quick-attack-buttons">
                    <button class="quick-attack-btn" onclick="setAllSquadsAttackCount(1)">全部設為1次</button>
                    <button class="quick-attack-btn" onclick="setAllSquadsAttackCount(3)">全部設為3次</button>
                    <button class="quick-attack-btn" onclick="setAllSquadsAttackCount(5)">全部設為5次</button>
                </div>
                
                <div class="reset-attacks-section">
                    <button class="reset-attacks-btn" onclick="resetAllAttackCounts()">重置所有攻擊次數</button>
                </div>
            </div>

            <div class="points-adjustment-tool">
                <div class="tool-title">💰 點數調整工具</div>
                <div class="points-controls">
                    <label>選擇外星人:</label>
                    <select id="points-alien-select" class="alien-select">
                        <option value="">選擇外星人</option>
                        <option value="1">外星人 #1 (👾)</option>
                        <option value="2">外星人 #2 (👹)</option>
                        <option value="3">外星人 #3 (👺)</option>
                        <option value="4">外星人 #4 (😼)</option>
                        <option value="5">外星人 #5 (👻)</option>
                        <option value="6">外星人 #6 (🎃)</option>
                        <option value="7">外星人 #7 (🤡)</option>
                        <option value="8">外星人 #8 (💀)</option>
                        <option value="9">外星人 #9 (🦖)</option>
                        <option value="10">外星人 #10 (🐙)</option>
                    </select>
                    
                    <label>設定獲得點數:</label>
                    <input type="number" id="points-value-input" placeholder="輸入點數" min="0" max="9999" class="points-value-input">
                    
                    <button class="points-set-btn" onclick="setAlienPoints()">設定點數</button>
                </div>
                
                <div class="quick-points-buttons">
                    <button class="quick-points-btn" onclick="setAllAliensPoints(50)">全部設為50</button>
                    <button class="quick-points-btn" onclick="setAllAliensPoints(100)">全部設為100</button>
                    <button class="quick-points-btn" onclick="setAllAliensPoints(200)">全部設為200</button>
                </div>
            </div>

            <!-- 小隊點數顯示工具 -->
            <div class="squad-points-tool">
                <div class="tool-title">💎 小隊獲得點數</div>
                
                <div class="squad-points-grid" id="squad-points-grid">
                    <!-- 小隊點數將在這裡動態生成 -->
                </div>
                
                <div class="squad-points-controls">
                    <button class="reset-squad-points-btn" onclick="resetAllSquadPoints()">全部歸零</button>
                    <button class="add-points-btn" onclick="addPointsToAll()">測試加點</button>
                </div>
            </div>
        </div>

        <div class="battlefield">
            <h1 class="main-title">🛸 外星人戰場 🛸</h1>
            
            <div class="controls">
                <button class="btn" onclick="randomizeAliens()">隨機血量</button>
                <button class="btn" onclick="calculateTotalPoints()">計算總點數</button>
                <button class="btn" onclick="resetBattle()">重置戰鬥</button>
            </div>

            <!-- 外星人們 -->
            <div class="alien alien-1" data-id="1">
                <div class="alien-sprite">
                    <span class="monster-icon">👾</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #1</div>
                    <input type="number" class="hp-input" value="300" min="0" oninput="updateHp(1, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="100" min="0">
                </div>
            </div>

            <div class="alien alien-2" data-id="2">
                <div class="alien-sprite">
                    <span class="monster-icon">👹</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #2</div>
                    <input type="number" class="hp-input" value="300" min="0" oninput="updateHp(2, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="80" min="0">
                </div>
            </div>

            <div class="alien alien-3" data-id="3">
                <div class="alien-sprite">
                    <span class="monster-icon">👺</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #3</div>
                    <input type="number" class="hp-input" value="400" min="0" oninput="updateHp(3, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="150" min="0">
                </div>
            </div>

            <div class="alien alien-4" data-id="4">
                <div class="alien-sprite">
                    <span class="monster-icon">😼</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #4</div>
                    <input type="number" class="hp-input" value="300" min="0" oninput="updateHp(4, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="60" min="0">
                </div>
            </div>

            <div class="alien alien-5" data-id="5">
                <div class="alien-sprite">
                    <span class="monster-icon">👻</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #5</div>
                    <input type="number" class="hp-input" value="400" min="0" oninput="updateHp(5, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="120" min="0">
                </div>
            </div>

            <div class="alien alien-6" data-id="6">
                <div class="alien-sprite">
                    <span class="monster-icon">🎃</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #6</div>
                    <input type="number" class="hp-input" value="300" min="0" oninput="updateHp(6, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="70" min="0">
                </div>
            </div>

            <div class="alien alien-7" data-id="7">
                <div class="alien-sprite">
                    <span class="monster-icon">🤡</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #7</div>
                    <input type="number" class="hp-input" value="400" min="0" oninput="updateHp(7, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="90" min="0">
                </div>
            </div>

            <div class="alien alien-8" data-id="8">
                <div class="alien-sprite">
                    <span class="monster-icon">💀</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #8</div>
                    <input type="number" class="hp-input" value="400" min="0" oninput="updateHp(8, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="110" min="0">
                </div>
            </div>

            <div class="alien alien-9" data-id="9">
                <div class="alien-sprite">
                    <span class="monster-icon">🦖</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #9</div>
                    <input type="number" class="hp-input" value="300" min="0" oninput="updateHp(9, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="50" min="0">
                </div>
            </div>

            <div class="alien alien-10" data-id="10">
                <div class="alien-sprite">
                    <span class="monster-icon">🐙</span>
                </div>
                <div class="hp-display">
                    <div class="alien-id">外星人 #10</div>
                    <input type="number" class="hp-input" value="450" min="0" oninput="updateHp(10, this.value)">
                    <div class="hp-bar">
                        <div class="hp-fill" style="width: 100%"></div>
                    </div>
                </div>
                <div class="points-display">
                    <div class="points-label">獲得點數</div>
                    <input type="number" class="points-input" value="200" min="0">
                </div>
            </div>
        </div>
    </div>

    <!-- 競技場頁面 -->
    <div class="page" id="arena-page">
        <h1 class="main-title">⚔️ 小隊競技場 ⚔️</h1>
        
        <!-- 地圖選擇區域 -->
        <div class="arena-map-selector">
            <h2 class="arena-map-title">🗺️ 選擇戰鬥地圖</h2>
            <div class="arena-map-grid" id="arena-map-grid">
                <!-- 地圖選項將在這裡動態生成 -->
            </div>
            <div class="arena-map-effects" id="arena-map-effects">
                <div class="arena-map-effects-title">地圖效果</div>
                <div id="arena-map-effects-content">
                    <!-- 地圖效果將在這裡顯示 -->
                </div>
            </div>
        </div>
        
        <div class="arena-container">
            <!-- 左側小隊選擇 -->
            <div class="squad-selector-arena">
                <h2 class="selector-title">選擇小隊 A</h2>
                <div class="squad-options" id="squad-a-options">
                    <!-- 小隊選項將在這裡生成 -->
                </div>
            </div>

            <!-- 中央戰鬥區域 -->
            <div class="battle-area-arena">
                <h2 class="battle-title-arena">🏟️ 競技場對戰 🏟️</h2>
                
                <div class="vs-display">
                    <div class="squad-display">
                        <div class="squad-display-name" id="squad-a-name">選擇小隊 A</div>
                        <div class="squad-display-total" id="squad-a-total">總點數: --</div>
                        <div class="skill-display" id="squad-a-skills" style="display: none;">
                            <div class="skill-name">技能卡: 未選擇</div>
                        </div>
                    </div>
                    
                    <div class="vs-text">VS</div>
                    
                    <div class="squad-display">
                        <div class="squad-display-name" id="squad-b-name">選擇小隊 B</div>
                        <div class="squad-display-total" id="squad-b-total">總點數: --</div>
                        <div class="skill-display" id="squad-b-skills" style="display: none;">
                            <div class="skill-name">技能卡: 未選擇</div>
                        </div>
                    </div>
                </div>

                <!-- 下注系統 -->
                <div class="betting-system" id="betting-system">
                    <div class="betting-title">💰 下注系統 💰</div>
                    
                    <div class="betting-info">
                        <div class="betting-matchup" id="betting-matchup">
                            請選擇對戰雙方後開始下注
                        </div>
                        <div class="betting-reward">
                            基礎獎勵: 20 積分 × (1 + 對方下注隊伍數 ÷ 總下注隊伍數)
                        </div>
                    </div>

                    <div class="betting-options" id="betting-options" style="display: none;">
                        <div class="betting-side" id="betting-side-a" onclick="selectBettingSide('A')">
                            <div class="betting-squad-name" id="betting-squad-a">小隊 A</div>
                            <div class="betting-odds" id="betting-odds-a">等待計算賠率</div>
                        </div>
                        
                        <div class="betting-vs">VS</div>
                        
                        <div class="betting-side" id="betting-side-b" onclick="selectBettingSide('B')">
                            <div class="betting-squad-name" id="betting-squad-b">小隊 B</div>
                            <div class="betting-odds" id="betting-odds-b">等待計算賠率</div>
                        </div>
                    </div>

                    <div class="betting-participants" id="betting-participants" style="display: none;">
                        <div class="betting-participants-title">💎 下注參與者 💎</div>
                        <div class="betting-grid" id="betting-grid">
                            <!-- 下注參與者將在這裡顯示 -->
                        </div>
                    </div>

                    <div class="betting-summary" id="betting-summary" style="display: none;">
                        <div class="betting-summary-side">
                            <div class="betting-count" id="betting-count-a">0</div>
                            <div class="betting-label">押小隊 A</div>
                        </div>
                        
                        <div class="betting-summary-vs">VS</div>
                        
                        <div class="betting-summary-side">
                            <div class="betting-count" id="betting-count-b">0</div>
                            <div class="betting-label">押小隊 B</div>
                        </div>
                    </div>

                    <div class="betting-controls">
                        <button class="betting-btn" id="start-betting-btn" onclick="startBetting()" disabled>
                            開始下注
                        </button>
                        <button class="betting-btn clear-bets-btn" id="clear-bets-btn" onclick="clearAllBets()" disabled>
                            清空下注
                        </button>
                    </div>
                </div>

                <!-- 下注結果 -->
                <div class="betting-results" id="betting-results">
                    <div class="betting-results-title">🎰 下注結算 🎰</div>
                    
                    <div class="betting-winner-announcement" id="betting-winner-announcement">
                        <div class="betting-winner-text" id="betting-winner-text">
                            等待戰鬥結果...
                        </div>
                    </div>

                    <div class="betting-rewards-list" id="betting-rewards-list">
                        <div class="betting-rewards-title">💰 積分獎勵</div>
                        <div id="betting-rewards-content">
                            <!-- 獎勵詳情將在這裡顯示 -->
                        </div>
                    </div>
                </div>

                <button class="reveal-skills-btn" id="reveal-skills-btn" onclick="revealSkills()" disabled>
                    🔍 公布技能並開始對戰
                </button>

                <div class="skills-revealed" id="skills-revealed" style="display: none;">
                    <!-- 技能公布內容將在這裡顯示 -->
                </div>

                <button class="battle-button-arena" id="arena-battle-btn" onclick="startArenaBattle()" disabled>
                    開始對戰
                </button>

                <div class="comparison-results" id="comparison-results">
                    <!-- 比較結果將在這裡顯示 -->
                </div>

                <button class="reset-button-arena" onclick="resetArenaBattle()">重置對戰</button>
            </div>

            <!-- 右側小隊選擇 -->
            <div class="squad-selector-arena">
                <h2 class="selector-title">選擇小隊 B</h2>
                <div class="squad-options" id="squad-b-options">
                    <!-- 小隊選項將在這裡生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 戰鬥結果彈窗 -->
    <div class="battle-result" id="battle-result">
        <div class="result-title">🎯 戰鬥結果 🎯</div>
        <div class="result-content" id="result-content">
            <!-- 結果內容將在這裡顯示 -->
        </div>
        <button class="result-close" onclick="closeBattleResult()">確定</button>
    </div>

    <script>
        // 全域變數
        let selectedSquads = [];
        let selectedTarget = null;
        let squadData = {};
        let squadAttackCounts = {};
        let squadPoints = {};
        let isGoldCoinRetry = false; // 是否為大金幣重打狀態
        let goldCoinRetrySquad = null; // 使用大金幣重打的隊伍
        let permanentlyUsedItems = {}; // 永久使用過的道具卡 { itemKey: true }
        let battleParticipatedSquads = {}; // 已參與戰鬥的小隊 { squadId: true }
        // 新增的全域變數
        let squadPassiveSkills = {}; // 小隊被動技能
        let squadItemCards = {}; // 小隊技能卡
        let squadScores = {}; // 小隊積分
        let takenItems = {}; // 已被選擇的技能卡
        let selectedItemCard = null; // 當前選中的技能卡
        let selectedSquadForItem = null; // 當前選中要分配技能卡的小隊
        let usedGoldCoins = {};
        let itemAssignmentHistory = [];
        // 新增下注相關變數
        let bettingSystem = {
            enabled: false,
            bets: {}, // squadId: 'A' or 'B'
            baseReward: 20 // 基礎下注獎勵
        };
        
        
        // 競技場變數
        let selectedSquadA = null;
        let selectedSquadB = null;
        let selectedArenaMap = null;
        
        // 競技場地圖定義
        const arenaMaps = {
            'gravity_field': {
                name: '10倍重力場',
                icon: '🌍',
                effects: {
                    lowerLimb: 0,      // 下肢 → 0
                    chest: 0.5,        // 胸部 ×0.5
                    hearing: 1.5,      // 聽覺 ×1.5
                    abdomen: 1.5       // 腹部 ×1.5
                }
            },
            'vacuum_ridge': {
                name: '高空真空嶺',
                icon: '⛰️',
                effects: {
                    chest: 0,          // 胸部 → 0
                    hearing: 0.5,      // 聽覺 ×0.5
                    vision: 1.5,       // 視覺 ×1.5
                    upperLimb: 1.5     // 上肢 ×1.5
                }
            },
            'mind_interference': {
                name: '心智干擾區',
                icon: '🧠',
                effects: {
                    intelligence: 0,   // 智力 → 0
                    vision: 0.5,       // 視覺 ×0.5
                    upperLimb: 1.5,    // 上肢 ×1.5
                    hearing: 1.5       // 聽覺 ×1.5
                }
            },
            'sterile_chamber': {
                name: '無味滅菌艙',
                icon: '🧪',
                effects: {
                    smell: 0,          // 嗅覺 → 0
                    lowerLimb: 0.5,    // 下肢 ×0.5
                    chest: 1.5,        // 胸部 ×1.5
                    intelligence: 1.5  // 智力 ×1.5
                }
            },
            'silent_swamp': {
                name: '寂靜沼澤',
                icon: '🏞️',
                effects: {
                    hearing: 0,        // 聽覺 → 0
                    vision: 0.5,       // 視覺 ×0.5
                    lowerLimb: 1.5,    // 下肢 ×1.5
                    smell: 1.5         // 嗅覺 ×1.5
                }
            },
            'electromagnetic_city': {
                name: '電磁枷鎖城',
                icon: '🌆',
                effects: {
                    upperLimb: 0,      // 上肢 → 0
                    abdomen: 0.5,      // 腹部 ×0.5
                    intelligence: 1.5, // 智力 ×1.5
                    chest: 1.5         // 胸部 ×1.5
                }
            },
            'misty_illusion': {
                name: '迷霧幻境',
                icon: '🌫️',
                effects: {
                    vision: 0,         // 視覺 → 0
                    smell: 0.5,        // 嗅覺 ×0.5
                    abdomen: 1.5,      // 腹部 ×1.5
                    upperLimb: 1.5     // 上肢 ×1.5
                }
            },
            'poison_garden': {
                name: '毒花園',
                icon: '🌺',
                effects: {
                    abdomen: 0,        // 腹部 → 0
                    intelligence: 0.5, // 智力 ×0.5
                    smell: 1.5,        // 嗅覺 ×1.5
                    vision: 1.5        // 視覺 ×1.5
                }
            }
        };
        
        // 被動技能定義
        const passiveSkills = {
            'berserker_lung': {
                name: '狂暴肺活量',
                effects: { chest: 2.5 }
            },
            'night_vision': {
                name: '夜視',
                effects: { vision: 2.5 }
            },
            'third_leg': {
                name: '第三隻腳蕉',
                effects: { lowerLimb: 2.5 }
            },
            'smell_sense': {
                name: '聞香',
                effects: { smell: 2.5 }
            },
            'muscle_enhance': {
                name: '筋肉強化',
                effects: { chest: 2, upperLimb: 2 }
            },
            'weird_brain': {
                name: '詭異腦迴路',
                effects: { intelligence: 2.5 }
            },
            'random_touch': {
                name: '亂摸',
                effects: { upperLimb: 2.5 }
            },
            'sound_location': {
                name: '聽音辨位',
                effects: { hearing: 2.5 }
            },
            'big_belly': {
                name: '大肚',
                effects: { abdomen: 2.5 }
            },
            'poison_bomb': {
                name: '毒氣炸彈',
                effects: { opponent_all: 0.7 }
            }
        };

        // 技能卡定義
        const itemCards = {
            'super_protein': {
                name: '超級蛋白粉',
                description: '吃完後肌力大增，瘋狂健身，但只練上身，忘記練腿',
                effects: { chest: 2, abdomen: 1.5, lowerLimb: 0.3 },
                type: 'attribute'
            },
            'jackson_guitar': {
                name: '賣口傑克森的吉他',
                description: '獲得絕對音感，和超絕舞步',
                effects: { hearing: 3, upperLimb: 1.5, lowerLimb: 1.5 },
                type: 'attribute'
            },
            'ice_water': {
                name: '真冰涼氣泡水',
                description: '喝完真冰涼，眼睛直接亮起來，頭腦也清醒過來',
                effects: { vision: 2, intelligence: 1.5 },
                type: 'attribute'
            },
            'unsafe_helmet': {
                name: '不安全的安全帽',
                description: '都不安全了還選？脖子以上毫無保護',
                effects: { intelligence: 0, hearing: 0.5, vision: 0.5, smell: 0.5 },
                type: 'attribute'
            },
            'big_bed': {
                name: '超大雙人床',
                description: '真低舒服，腰部以下受到前所未有的呵護',
                effects: { abdomen: 2.5, lowerLimb: 1.5 },
                type: 'attribute'
            },
            'nmixx_ticket': {
                name: 'Nmixx演唱會門票',
                description: '視覺聽覺一大享受',
                effects: { vision: 2, hearing: 1.5 },
                type: 'attribute'
            },
            'big_gun': {
                name: '超大手槍',
                description: '手槍太大，不符合人體工學，所以後座力超大',
                effects: { upperLimb: 0, chest: 0.5, abdomen: 0.5 },
                type: 'attribute'
            },
            'magic_conch': {
                name: '神奇海螺',
                description: '就很神奇',
                effects: { intelligence: 1.5, hearing: 1.5, vision: 1.5, smell: 1.5, chest: 1.5, abdomen: 1.5, lowerLimb: 1.5, upperLimb: 1.5 },
                type: 'attribute'
            },
            'old_tea': {
                name: '古早味紅茶',
                description: '賣紅茶的阿嬤糖加太多 變成胖子',
                effects: { abdomen: 0.3, lowerLimb: 0.5, upperLimb: 0.5 },
                type: 'attribute'
            },
            'bluetooth_earphone': {
                name: '超 無線藍芽耳機',
                description: '前所未有的聽覺盛宴',
                effects: { hearing: 2.5, intelligence: 1.5 },
                type: 'attribute'
            },
            'bitter_tea': {
                name: '超健康苦茶',
                description: '靠北苦，苦到嗅覺消失',
                effects: { smell: 0, chest: 0.5 },
                type: 'attribute'
            },
            'heavy_dumbbell': {
                name: '80公斤啞鈴',
                description: '你以為你舉得起來？太自以為是結果砸到腳，手還扭到',
                effects: { upperLimb: 0.5, lowerLimb: 0 },
                type: 'attribute'
            },
            'apple_watch': {
                name: '欸波watch',
                description: '一直舉手看手錶 想不到練成了麒麟臂',
                effects: { upperLimb: 2, vision: 1.5 },
                type: 'attribute'
            },
            'glasses_300': {
                name: '300度近視眼鏡',
                description: '瞬間視力達到2.0，但副作用是頭痛',
                effects: { vision: 2.5, intelligence: 0.5 },
                type: 'attribute'
            },
            'alcohol_58': {
                name: '58度金門高粱',
                description: '喝完後胸悶難耐 腹部灼燒 但聽力變異常敏銳',
                effects: { chest: 0.5, abdomen: 0.5, hearing: 1.5 },
                type: 'attribute'
            },
            'gold_coin': {
    name: '大金幣',
    description: '神奇金幣，擁有神奇技能，此次對戰後不管勝敗，都可以自行選擇地圖再打一次',
    effects: { all: 1.1 },
    type: 'special',
    special: 'retry_battle'  // 改變特殊效果標記
},
            'mystery_balance': {
                name: '神秘的天平',
                description: '神秘的天平，將一切事物平等分配，擁有此卡，戰鬥時可以選擇其中一項能力點數兩隊相加後平分',
                effects: { all: 1.1 },
                type: 'special',
                special: 'balance_attribute'
            },
            'smelly_sock': {
                name: '超臭襪子',
                description: '超級臭，害兩邊都失去思考能力，輸的一方變成勝者',
                effects: {},
                type: 'special',
                special: 'reverse_result'
            },
            'dirty_clothes': {
                name: '十天沒洗的衣服',
                description: '穿上衣服後，髒到沒人敢靠近，防禦力點滿，可以選擇避戰，選擇還沒打架過的隊伍當對手',
                effects: { all: 1.1 },
                type: 'special',
                special: 'choose_opponent'
            },
            'magic_book': {
                name: '古老的魔法書',
                description: '因為太古老，所以根本看不懂，只能拿來墊泡麵',
                effects: {},
                type: 'attribute'
            },
            'iphone18': {
                name: 'Iphone18',
                description: '充滿未來科技，擁有超強能力，自行選擇將對手一項能力歸0',
                effects: { all: 1.1 },
                type: 'special',
                special: 'zero_max_attribute'
            },
            'fake_shoes': {
    name: 'Adidos跑鞋',
    description: '高仿盜版，戰鬥結束可以盜取對方其中一個部位能力點，直到自己為100或對方為0',
    effects: { all: 1.1 },
    type: 'special',
    special: 'steal_attribute'
},
            'lazy_chair': {
                name: '充氣懶骨頭',
                description: '看似攤在椅子上毫無戰意，實則內功運轉，準備反打，若本回合能力點數原本低於對方，自身點數乘1.5倍',
                effects: {},
                type: 'special',
                special: 'underdog_boost'
            },
            'air_jordan': {
                name: 'AIR JORDAN 1',
                description: '變身成為籃球之神，彈跳力驚人，跳過本輪對戰，獲得勝者積分',
                effects: {},
                type: 'special',
                special: 'skip_battle'
            },
            'sticky_tape': {
                name: '很黏的膠帶',
                description: '超級黏，黏到把對面技能卡給黏過來了，本次對戰將對方技能卡占為己有',
                effects: {},
                type: 'special',
                special: 'steal_item'
            },
            'big_doll': {
                name: '超大絨毛玩偶',
                description: '可可愛愛，散發愛的能量，如果雙方都同意，兩隊皆獲得120分',
                effects: {},
                type: 'special',
                special: 'mutual_score'
            },
            'lightning_whip': {
                name: '閃電五連鞭',
                description: '充滿能量的鞭子，殺傷力滿滿滿，戰鬥後必定減少對方每個能力各15點',
                effects: { all: 1.1 },
                type: 'special',
                special: 'reduce_opponent'
            },
            'rtx_5090': {
    name: '5090ti顯卡',
    description: '效能大增，畫質8k，但電腦可能燒壞，若獲勝，則獲得200點積分，若輸，則所有能力值永久-10點',
    effects: { all: 1.1 },
    type: 'special',
    special: 'high_risk_reward'
},
            'big_umbrella': {
                name: '超大雨傘',
                description: '傘大遮天，一傘擋之，本次對戰消除對方被動技能的效果',
                effects: { all: 1.1 },
                type: 'special',
                special: 'disable_passive'
            },
            'baseball_bat': {
                name: '超大根球棒',
                description: '不是用來打球，是用來打亂局勢的！兩方被動技能互換',
                effects: { all: 1.1 },
                type: 'special',
                special: 'swap_passive'
            }
        };
        
        // 屬性定義
        const attributes = ['intelligence', 'vision', 'hearing', 'smell', 'upperLimb', 'lowerLimb', 'chest', 'abdomen'];
        const attributeNames = {
            intelligence: '智力',
            vision: '視覺',
            hearing: '聽覺',
            smell: '嗅覺',
            upperLimb: '上肢',
            lowerLimb: '下肢',
            chest: '胸',
            abdomen: '腹'
        };
        const attributeIcons = {
            intelligence: '🧠',
            vision: '👁️',
            hearing: '👂',
            smell: '👃',
            upperLimb: '💪',
            lowerLimb: '🦵',
            chest: '🫁',
            abdomen: '🎯'
        };

        const maxHp = {
            1: 300, 2: 300, 3: 400, 4: 300, 5: 400,
            6: 300, 7: 400, 8: 400, 9: 300, 10: 450
        };

        const initialHp = {
            1: 300, 2: 300, 3: 400, 4: 300, 5: 400,
            6: 300, 7: 400, 8: 400, 9: 300, 10: 450
        };

        // 頁面切換
        function switchPage(pageName) {
            console.log('Switching to page:', pageName);
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.switch-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const targetPage = document.getElementById(pageName + '-page');
            const targetBtn = event ? event.target : null;
            
            if (targetPage) {
                targetPage.classList.add('active');
                console.log('Page activated:', pageName);
            } else {
                console.error('Page not found:', pageName + '-page');
            }
            
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // 頁面切換後的初始化
            setTimeout(() => {
                if (pageName === 'battlefield') {
                    syncSquadData();
                    updateSquadCheckboxes();
                } else if (pageName === 'squads') {
                    updateSquadPointsDisplay();
                    updatePassiveSkillOptions();
                } else if (pageName === 'arena') {
                    console.log('Switching to arena, syncing data...');
                    syncSquadData();
                    updateArenaSquadOptions();
                    initializeArenaMaps();
                } else if (pageName === 'items') {
                    initializeItemsWall();
                    updateSelectedItemDisplay();
                    updateUndoButton();// 新增這行
                } else if (pageName === 'rankings') {
                    updateRankings();
                }
            }, 50);
        }

        // 初始化小隊卡片
        function initializeSquads() {
            const container = document.getElementById('squads-container');
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                const squadCard = createSquadCard(squadId);
                container.appendChild(squadCard);
                
                squadData[squadId] = {
                    intelligence: 5, vision: 5, hearing: 5, smell: 5,
                    upperLimb: 5, lowerLimb: 5, chest: 5, abdomen: 5,
                    total: 40
                };
                
                squadAttackCounts[squadId] = 3;
                squadPoints[squadId] = 0;
                squadPassiveSkills[squadId] = null;
                squadItemCards[squadId] = null;
                squadScores[squadId] = 0;
            }
            
            // 延遲初始化被動技能選項
            setTimeout(() => {
                updatePassiveSkillOptions();
            }, 100);
        }

        // 創建小隊卡片
        function createSquadCard(squadId) {
            const card = document.createElement('div');
            card.className = 'squad-card';
            card.setAttribute('data-squad', squadId);
            
            let attributesHTML = '';
            attributes.forEach(attr => {
                attributesHTML += `
                    <div class="attribute">
                        <div class="attribute-label">
                            <span class="attribute-icon">${attributeIcons[attr]}</span>
                            ${attributeNames[attr]}
                        </div>
                        <input type="number" class="attribute-input" data-attr="${attr}" value="5" min="0" max="100" oninput="updateAttribute(${squadId}, '${attr}', this.value)">
                        <div class="attribute-bar">
                            <div class="attribute-fill" style="width: 5%"></div>
                        </div>
                        <div class="point-controls">
                            <button class="point-btn" onclick="addPointToAttribute(${squadId}, '${attr}', -5)" title="減少5點">-5</button>
                            <button class="point-btn" onclick="addPointToAttribute(${squadId}, '${attr}', -1)" title="減少1點">-1</button>
                            <input type="number" class="point-input" placeholder="點數" min="1" max="100" onkeypress="handlePointInputEnter(event, ${squadId}, '${attr}')">
                            <button class="point-btn" onclick="addPointToAttribute(${squadId}, '${attr}', 1)" title="增加1點">+1</button>
                            <button class="point-btn" onclick="addPointToAttribute(${squadId}, '${attr}', 5)" title="增加5點">+5</button>
                        </div>
                    </div>
                `;
            });
            
            card.innerHTML = `
                <h2 class="squad-title">
                    <span class="squad-icon">⚔️</span>
                    小隊 #${squadId}
                </h2>
                
                <div class="available-points">
                    <div class="points-label">可用點數</div>
                    <div class="points-value-container">
                        <input type="number" class="points-value-input" id="squad-${squadId}-points-input" value="0" min="0" max="9999">
                        <button class="points-set-button" onclick="setSquadPoints(${squadId})">設定</button>
                    </div>
                </div>
                
                <div class="attributes-grid">
                    ${attributesHTML}
                </div>
                
                <!-- 被動技能選擇 -->
                <div class="passive-skill-selector">
                    <div class="passive-skill-title">⚡ 被動技能</div>
                    <select class="passive-skill-dropdown" id="passive-skill-${squadId}" onchange="assignPassiveSkill(${squadId}, this.value)">
                        <option value="">選擇被動技能</option>
                    </select>
                    <div class="current-passive-skill" id="current-passive-${squadId}">
                        未選擇被動技能
                    </div>
                </div>
                
                <div class="total-points">總點數: <span class="total-value">40</span> / 800</div>
            `;
            
            return card;
        }

        // 更新屬性
        function updateAttribute(squadId, attribute, value) {
            const squad = document.querySelector(`[data-squad="${squadId}"]`);
            if (!squad) return;
            
            const input = squad.querySelector(`[data-attr="${attribute}"]`);
            const bar = input.nextElementSibling.querySelector('.attribute-fill');
            
            const numValue = Math.max(0, Math.min(100, parseInt(value) || 0));
            input.value = numValue;
            
            squadData[squadId][attribute] = numValue;
            
            const percentage = (numValue / 100) * 100;
            bar.style.width = percentage + '%';
            
            if (percentage < 20) {
                bar.style.background = 'linear-gradient(90deg, #ff4757 0%, #ff6348 100%)';
            } else if (percentage < 60) {
                bar.style.background = 'linear-gradient(90deg, #ffa502 0%, #ff7675 100%)';
            } else {
                bar.style.background = 'linear-gradient(90deg, #2ed573 0%, #26de81 100%)';
            }
            
            updateTotalPoints(squadId);
        }

        // 更新總點數
        function updateTotalPoints(squadId) {
            const squad = document.querySelector(`[data-squad="${squadId}"]`);
            if (!squad) return;
            
            let total = 0;
            attributes.forEach(attr => {
                total += squadData[squadId][attr] || 0;
            });
            
            squadData[squadId].total = total;
            squad.querySelector('.total-value').textContent = total;
            
            updateSquadCheckboxes();
        }

        // 同步小隊資料到戰場
        function syncSquadData() {
            for (let squadId = 1; squadId <= 10; squadId++) {
                const squad = document.querySelector(`[data-squad="${squadId}"]`);
                if (squad) {
                    let total = 0;
                    squad.querySelectorAll('.attribute-input').forEach(input => {
                        const attr = input.getAttribute('data-attr');
                        const value = parseInt(input.value) || 0;
                        squadData[squadId][attr] = value;
                        total += value;
                    });
                    squadData[squadId].total = total;
                }
            }
        }

        // 更新小隊點數顯示
        function updateSquadPointsDisplay() {
            const grid = document.getElementById('squad-points-grid');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                const points = squadPoints[squadId] || 0;
                
                const item = document.createElement('div');
                item.className = 'squad-points-item';
                item.innerHTML = `
                    <div class="squad-points-label">小隊 #${squadId}</div>
                    <div class="squad-points-value">${points}</div>
                `;
                
                grid.appendChild(item);
                
                const squadPointsInput = document.getElementById(`squad-${squadId}-points-input`);
                if (squadPointsInput) {
                    squadPointsInput.value = points;
                }
            }
        }

        // 設定小隊可用點數
        function setSquadPoints(squadId) {
            const inputElement = document.getElementById(`squad-${squadId}-points-input`);
            const newPoints = parseInt(inputElement.value);
            
            if (isNaN(newPoints) || newPoints < 0) {
                alert('請輸入有效的點數值（0或更多）！');
                inputElement.value = squadPoints[squadId] || 0;
                return;
            }
            
            squadPoints[squadId] = newPoints;
            updateSquadPointsDisplay();
            
            const message = `小隊 #${squadId} 可用點數已設定為 ${newPoints} 點`;
            alert(message);
        }

        // 使用點數來增加屬性值
        function addPointToAttribute(squadId, attribute, amount) {
            const availablePoints = squadPoints[squadId] || 0;
            const currentValue = squadData[squadId][attribute] || 5;
            
            if (amount > 0 && availablePoints < amount) {
                alert(`小隊 #${squadId} 可用點數不足！當前可用: ${availablePoints} 點`);
                return;
            }
            
            const newValue = currentValue + amount;
            if (newValue < 0 || newValue > 100) {
                alert(`屬性值必須在 0-100 之間！`);
                return;
            }
            
            if (amount < 0) {
                squadPoints[squadId] = availablePoints + Math.abs(amount);
            } else {
                squadPoints[squadId] = availablePoints - amount;
            }
            
            squadData[squadId][attribute] = newValue;
            const squad = document.querySelector(`[data-squad="${squadId}"]`);
            const input = squad.querySelector(`[data-attr="${attribute}"]`);
            input.value = newValue;
            
            updateAttribute(squadId, attribute, newValue);
            updateSquadPointsDisplay();
        }

        // 處理手動輸入點數
        function handlePointInputEnter(event, squadId, attribute) {
            if (event.key === 'Enter') {
                const inputValue = parseInt(event.target.value);
                if (isNaN(inputValue) || inputValue <= 0) {
                    alert('請輸入有效的正整數！');
                    event.target.value = '';
                    return;
                }
                
                addPointToAttribute(squadId, attribute, inputValue);
                event.target.value = '';
            }
        }

        // 更新小隊選擇框
        function updateSquadCheckboxes() {
            const container = document.getElementById('squad-checkboxes');
            if (!container) return;
            
            container.innerHTML = '';
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                const checkbox = document.createElement('div');
                checkbox.className = 'squad-checkbox';
                const attacksLeft = squadAttackCounts[squadId] || 0;
                
                if (attacksLeft <= 0) {
                    checkbox.classList.add('no-attacks');
                }
                
                checkbox.onclick = () => toggleSquadSelection(squadId);
                
                checkbox.innerHTML = `
                    <input type="checkbox" id="squad-${squadId}">
                    <div class="squad-label">小隊 #${squadId}</div>
                    <div class="squad-points">${squadData[squadId]?.total || 40} 點</div>
                    <div class="squad-attacks">攻擊次數: ${attacksLeft}</div>
                `;
                
                container.appendChild(checkbox);
            }
        }

        // 切換小隊選擇
        function toggleSquadSelection(squadId) {
            const checkbox = document.querySelector(`#squad-${squadId}`);
            if (!checkbox) return;
            
            const checkboxDiv = checkbox.parentElement;
            const isSelected = selectedSquads.includes(squadId);
            const attacksLeft = squadAttackCounts[squadId] || 0;
            
            if (!isSelected && attacksLeft <= 0) {
                alert(`小隊 #${squadId} 沒有剩餘攻擊次數！`);
                return;
            }
            
            if (isSelected) {
                selectedSquads = selectedSquads.filter(id => id !== squadId);
                checkboxDiv.classList.remove('selected');
            } else {
                selectedSquads.push(squadId);
                checkboxDiv.classList.add('selected');
            }
            
            updateBattleInfo();
            updateAttackButton();
        }

        // 選擇目標
        function selectTarget(alienId) {
            document.querySelectorAll('.alien-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            document.querySelectorAll('.alien').forEach(alien => {
                alien.classList.remove('targeted');
            });
            
            selectedTarget = alienId;
            event.target.closest('.alien-btn').classList.add('selected');
            const targetAlien = document.querySelector(`.alien-${alienId}`);
            if (targetAlien) {
                targetAlien.classList.add('targeted');
            }
            
            updateBattleInfo();
            updateAttackButton();
        }

        // 更新戰鬥資訊
        function updateBattleInfo() {
            const infoDiv = document.getElementById('battle-info');
            if (!infoDiv) return;
            
            if (selectedSquads.length === 0 && !selectedTarget) {
                infoDiv.innerHTML = '選擇小隊和目標開始戰鬥';
                return;
            }
            
            let info = '';
            
            if (selectedSquads.length > 0) {
                const totalDamage = selectedSquads.reduce((sum, squadId) => {
                    return sum + (squadData[squadId]?.total || 0);
                }, 0);
                
                const attacksInfo = selectedSquads.map(squadId => {
                    const attacks = squadAttackCounts[squadId] || 0;
                    return `#${squadId}(${attacks}次)`;
                }).join(', ');
                
                info += `已選擇小隊: ${attacksInfo}<br>`;
                info += `總傷害: ${totalDamage} 點<br>`;
            }
            
            if (selectedTarget) {
                const targetHpInput = document.querySelector(`.alien-${selectedTarget} .hp-input`);
                const targetHp = targetHpInput ? targetHpInput.value : '--';
                info += `目標: 外星人 #${selectedTarget}<br>`;
                info += `目標血量: ${targetHp} HP`;
            }
            
            infoDiv.innerHTML = info;
        }

        // 更新攻擊按鈕狀態
        function updateAttackButton() {
            const attackBtn = document.getElementById('attack-btn');
            if (!attackBtn) return;
            
            const canAttack = selectedSquads.length > 0 && selectedTarget !== null;
            
            attackBtn.disabled = !canAttack;
            
            if (canAttack) {
                attackBtn.textContent = '發動攻擊';
            } else {
                attackBtn.textContent = '選擇小隊和目標';
            }
        }

        // 執行攻擊
        function executeAttack() {
            if (selectedSquads.length === 0 || !selectedTarget) return;
            
            const invalidSquads = selectedSquads.filter(squadId => (squadAttackCounts[squadId] || 0) <= 0);
            if (invalidSquads.length > 0) {
                alert(`小隊 ${invalidSquads.map(id => `#${id}`).join(', ')} 沒有剩餘攻擊次數！`);
                return;
            }
            
            const totalDamage = selectedSquads.reduce((sum, squadId) => {
                return sum + (squadData[squadId]?.total || 0);
            }, 0);
            
            const targetAlien = document.querySelector(`.alien-${selectedTarget}`);
            if (!targetAlien) return;
            
            const hpInput = targetAlien.querySelector('.hp-input');
            const currentHp = parseInt(hpInput.value) || 0;
            const pointsInput = targetAlien.querySelector('.points-input');
            const rewardPoints = parseInt(pointsInput.value) || 0;
            
            const newHp = Math.max(0, currentHp - totalDamage);
            hpInput.value = newHp;
            
            updateHpInBattle(selectedTarget, newHp, currentHp);
            
            selectedSquads.forEach(squadId => {
                squadAttackCounts[squadId] = Math.max(0, (squadAttackCounts[squadId] || 0) - 1);
            });
            
            updateSquadCheckboxes();
            
            let resultMessage = `⚔️ 戰鬥結果 ⚔️\n\n`;
            resultMessage += `攻擊小隊: ${selectedSquads.map(id => `#${id}`).join(', ')}\n`;
            resultMessage += `造成傷害: ${totalDamage} 點\n`;
            resultMessage += `外星人 #${selectedTarget}: ${currentHp} → ${newHp} HP\n\n`;
            
            resultMessage += `剩餘攻擊次數:\n`;
            selectedSquads.forEach(squadId => {
                resultMessage += `小隊 #${squadId}: ${squadAttackCounts[squadId]} 次\n`;
            });
            resultMessage += `\n`;
            
            if (newHp <= 0) {
                const pointsPerSquad = Math.floor(rewardPoints / selectedSquads.length);
                
                selectedSquads.forEach((squadId) => {
                    squadPoints[squadId] = (squadPoints[squadId] || 0) + pointsPerSquad;
                });
                
                updateSquadPointsDisplay();
                
                resultMessage += `🎉 外星人 #${selectedTarget} 被擊敗！\n\n`;
                resultMessage += `獎勵分配:\n`;
                
                selectedSquads.forEach((squadId) => {
                    resultMessage += `小隊 #${squadId}: +${pointsPerSquad} 點\n`;
                });
                
                const totalDistributed = pointsPerSquad * selectedSquads.length;
                const remainder = rewardPoints - totalDistributed;
                if (remainder > 0) {
                    resultMessage += `\n(剩餘 ${remainder} 點未分配)`;
                }
            } else {
                resultMessage += `外星人 #${selectedTarget} 還有 ${newHp} HP`;
            }
            
            showBattleResult(resultMessage);
            clearSelections();
        }

        // 戰鬥時的血量更新
        function updateHpInBattle(id, newHp, originalMaxHp) {
            const alien = document.querySelector(`.alien-${id}`);
            if (!alien) return;
            
            const hpBar = alien.querySelector('.hp-fill');
            const hpInput = alien.querySelector('.hp-input');
            
            const validHp = Math.max(0, newHp);
            hpInput.value = validHp;
            
            const percentage = Math.max(0, Math.min(100, (validHp / originalMaxHp) * 100));
            hpBar.style.width = percentage + '%';
            
            if (validHp <= 0) {
                alien.classList.add('dead');
            } else {
                alien.classList.remove('dead');
            }
            
            if (percentage > 60) {
                hpBar.style.background = 'linear-gradient(90deg, #2ed573 0%, #26de81 100%)';
            } else if (percentage > 30) {
                hpBar.style.background = 'linear-gradient(90deg, #ffa502 0%, #ff7675 100%)';
            } else {
                hpBar.style.background = 'linear-gradient(90deg, #ff4757 0%, #ee5a6f 100%)';
            }
        }

        // 顯示戰鬥結果
        function showBattleResult(message) {
            const resultDiv = document.getElementById('battle-result');
            const contentDiv = document.getElementById('result-content');
            
            if (resultDiv && contentDiv) {
                contentDiv.innerHTML = message.replace(/\n/g, '<br>');
                resultDiv.style.display = 'block';
            }
        }

        // 關閉戰鬥結果
        function closeBattleResult() {
            const resultDiv = document.getElementById('battle-result');
            if (resultDiv) {
                resultDiv.style.display = 'none';
            }
        }

        // 清除選擇
        function clearSelections() {
            selectedSquads = [];
            selectedTarget = null;
            
            document.querySelectorAll('.squad-checkbox').forEach(checkbox => {
                checkbox.classList.remove('selected');
            });
            
            document.querySelectorAll('.alien-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            document.querySelectorAll('.alien').forEach(alien => {
                alien.classList.remove('targeted');
            });
            
            updateBattleInfo();
            updateAttackButton();
        }

        // 更新外星人血量
        function updateHp(id, value) {
            const alien = document.querySelector(`.alien-${id}`);
            if (!alien) return;
            
            const hpBar = alien.querySelector('.hp-fill');
            const hpInput = alien.querySelector('.hp-input');
            const currentHp = parseInt(value) || 0;
            
            const validHp = Math.max(0, currentHp);
            if (hpInput.value !== value) {
                hpInput.value = validHp;
            }
            
            maxHp[id] = validHp;
            
            const percentage = validHp > 0 ? 100 : 0;
            hpBar.style.width = percentage + '%';
            
            if (validHp <= 0) {
                alien.classList.add('dead');
                hpBar.style.background = 'linear-gradient(90deg, #ff4757 0%, #ee5a6f 100%)';
            } else {
                alien.classList.remove('dead');
                hpBar.style.background = 'linear-gradient(90deg, #2ed573 0%, #26de81 100%)';
            }
        }

        // 重置所有小隊
        function resetAllSquads() {
            for (let squadId = 1; squadId <= 10; squadId++) {
                const squad = document.querySelector(`[data-squad="${squadId}"]`);
                if (!squad) continue;
                
                squad.querySelectorAll('.attribute-input').forEach(input => {
                    input.value = 5;
                    updateAttribute(squadId, input.getAttribute('data-attr'), 5);
                });
            }
        }

        // 隨機分配屬性
        function randomizeAllSquads() {
            for (let squadId = 1; squadId <= 10; squadId++) {
                const squad = document.querySelector(`[data-squad="${squadId}"]`);
                if (!squad) continue;
                
                squad.querySelectorAll('.attribute-input').forEach(input => {
                    const randomValue = Math.floor(Math.random() * 46) + 5;
                    input.value = randomValue;
                    updateAttribute(squadId, input.getAttribute('data-attr'), randomValue);
                });
            }
        }

        // 顯示統計數據
        function showStatistics() {
            let totalPoints = 0;
            let squadStats = [];
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                const squadTotal = squadData[squadId]?.total || 0;
                totalPoints += squadTotal;
                squadStats.push(`小隊 #${squadId}: ${squadTotal} 點`);
            }
            
            alert(`===== 統計數據 =====\n\n${squadStats.join('\n')}\n\n總計: ${totalPoints} 點\n平均: ${(totalPoints/10).toFixed(1)} 點/小隊`);
        }

        // 隨機血量
        function randomizeAliens() {
            for (let i = 1; i <= 10; i++) {
                const randomHp = Math.floor(Math.random() * maxHp[i]);
                const input = document.querySelector(`.alien-${i} .hp-input`);
                if (input) {
                    input.value = randomHp;
                    updateHp(i, randomHp);
                }
            }
        }

        // 計算總點數
        function calculateTotalPoints() {
            let totalPoints = 0;
            let defeatedCount = 0;
            
            for (let i = 1; i <= 10; i++) {
                const hpInput = document.querySelector(`.alien-${i} .hp-input`);
                const pointsInput = document.querySelector(`.alien-${i} .points-input`);
                
                if (hpInput && pointsInput) {
                    const hp = parseInt(hpInput.value) || 0;
                    const points = parseInt(pointsInput.value) || 0;
                    
                    if (hp <= 0) {
                        totalPoints += points;
                        defeatedCount++;
                    }
                }
            }
            
            alert(`已擊敗 ${defeatedCount} 隻外星人\n獲得總點數: ${totalPoints} 點`);
        }

        // 重置戰鬥
        function resetBattle() {
            for (let i = 1; i <= 10; i++) {
                const input = document.querySelector(`.alien-${i} .hp-input`);
                if (input) {
                    input.value = initialHp[i];
                    updateHp(i, initialHp[i]);
                }
            }
            
            clearSelections();
            alert('戰鬥已重置！所有外星人血量已恢復滿血狀態。');
        }

        // 重置所有小隊點數
        function resetAllSquadPoints() {
            for (let squadId = 1; squadId <= 10; squadId++) {
                squadPoints[squadId] = 0;
            }
            updateSquadPointsDisplay();
            alert('所有小隊點數已歸零！');
        }

        // 測試功能：給所有小隊加點數
        function addPointsToAll() {
            const points = parseInt(prompt('給每個小隊加多少點數？', '50'));
            if (isNaN(points) || points <= 0) {
                alert('請輸入有效的點數！');
                return;
            }
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                squadPoints[squadId] = (squadPoints[squadId] || 0) + points;
            }
            updateSquadPointsDisplay();
            alert(`已給所有小隊各增加 ${points} 點！`);
        }

        // 設定單一外星人血量
        function setAlienHp() {
            const selectElement = document.getElementById('hp-alien-select');
            const inputElement = document.getElementById('hp-value-input');
            
            const alienId = selectElement.value;
            const hpValue = parseInt(inputElement.value);
            
            if (!alienId) {
                alert('請選擇一個外星人！');
                return;
            }
            
            if (isNaN(hpValue) || hpValue < 0) {
                alert('請輸入有效的血量值！');
                return;
            }
            
            const hpInput = document.querySelector(`.alien-${alienId} .hp-input`);
            if (hpInput) {
                hpInput.value = hpValue;
                updateHp(alienId, hpValue);
                
                inputElement.value = '';
                selectElement.value = '';
                
                alert(`外星人 #${alienId} 血量已設定為 ${hpValue} HP`);
            }
        }

        // 批量設定外星人血量
        function setAllAliensHp(type) {
            let targetHp;
            let actionName;
            
            switch(type) {
                case 'max':
                    actionName = '滿血';
                    break;
                case 'half':
                    actionName = '半血';
                    break;
                case 'zero':
                    targetHp = 0;
                    actionName = '歸零';
                    break;
                default:
                    return;
            }
            
            for (let i = 1; i <= 10; i++) {
                if (type === 'max') {
                    targetHp = initialHp[i];
                } else if (type === 'half') {
                    targetHp = Math.floor(initialHp[i] / 2);
                }
                
                const hpInput = document.querySelector(`.alien-${i} .hp-input`);
                if (hpInput) {
                    hpInput.value = targetHp;
                    updateHp(i, targetHp);
                }
            }
            
            alert(`所有外星人血量已設定為${actionName}狀態！`);
        }

        // 設定單一外星人點數
        function setAlienPoints() {
            const selectElement = document.getElementById('points-alien-select');
            const inputElement = document.getElementById('points-value-input');
            
            const alienId = selectElement.value;
            const pointsValue = parseInt(inputElement.value);
            
            if (!alienId) {
                alert('請選擇一個外星人！');
                return;
            }
            
            if (isNaN(pointsValue) || pointsValue < 0) {
                alert('請輸入有效的點數值！');
                return;
            }
            
            const pointsInput = document.querySelector(`.alien-${alienId} .points-input`);
            if (pointsInput) {
                pointsInput.value = pointsValue;
                
                inputElement.value = '';
                selectElement.value = '';
                
                alert(`外星人 #${alienId} 獲得點數已設定為 ${pointsValue} 點`);
            }
        }

        // 批量設定外星人點數
        function setAllAliensPoints(pointsValue) {
            for (let i = 1; i <= 10; i++) {
                const pointsInput = document.querySelector(`.alien-${i} .points-input`);
                if (pointsInput) {
                    pointsInput.value = pointsValue;
                }
            }
            
            alert(`所有外星人獲得點數已設定為 ${pointsValue} 點！`);
        }

        // 設定單一小隊攻擊次數
        function setSquadAttackCount() {
            const selectElement = document.getElementById('attack-squad-select');
            const inputElement = document.getElementById('attack-count-input');
            
            const squadId = parseInt(selectElement.value);
            const attackCount = parseInt(inputElement.value);
            
            if (!squadId) {
                alert('請選擇一個小隊！');
                return;
            }
            
            if (isNaN(attackCount) || attackCount < 0) {
                alert('請輸入有效的攻擊次數！');
                return;
            }
            
            squadAttackCounts[squadId] = attackCount;
            updateSquadCheckboxes();
            
            inputElement.value = '';
            selectElement.value = '';
            
            alert(`小隊 #${squadId} 攻擊次數已設定為 ${attackCount} 次`);
        }

        // 批量設定小隊攻擊次數
        function setAllSquadsAttackCount(attackCount) {
            for (let i = 1; i <= 10; i++) {
                squadAttackCounts[i] = attackCount;
            }
            
            updateSquadCheckboxes();
            alert(`所有小隊攻擊次數已設定為 ${attackCount} 次！`);
        }

        // 重置所有攻擊次數
        function resetAllAttackCounts() {
            for (let i = 1; i <= 10; i++) {
                squadAttackCounts[i] = 3;
            }
            
            updateSquadCheckboxes();
            clearSelections();
            alert('所有小隊攻擊次數已重置為 3 次！');
        }

        // ======== 競技場地圖相關函數 ========
        
        // 初始化競技場地圖選擇器
        function initializeArenaMaps() {
            const mapGrid = document.getElementById('arena-map-grid');
            if (!mapGrid) return;
            
            mapGrid.innerHTML = '';
            
            Object.keys(arenaMaps).forEach(mapId => {
                const map = arenaMaps[mapId];
                const mapOption = document.createElement('div');
                mapOption.className = 'arena-map-option';
                mapOption.setAttribute('data-map-id', mapId);
                mapOption.onclick = () => selectArenaMap(mapId);
                
                mapOption.innerHTML = `
                    <div class="arena-map-icon">${map.icon}</div>
                    <div class="arena-map-name">${map.name}</div>
                `;
                
                mapGrid.appendChild(mapOption);
            });
        }

        // 選擇競技場地圖
        function selectArenaMap(mapId) {
            // 清除之前的選擇
            document.querySelectorAll('.arena-map-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 設置新選擇
            selectedArenaMap = mapId;
            const selectedOption = document.querySelector(`[data-map-id="${mapId}"]`);
            if (selectedOption) {
                selectedOption.classList.add('selected');
            }
            
            // 顯示地圖效果
            showArenaMapEffects(mapId);
            
            // 更新小隊選項列表（顯示地圖效果後的能力值）
            updateArenaSquadOptions();
            
            // 重新選擇已選中的小隊（更新選中狀態）
            if (selectedSquadA) {
                const optionA = document.querySelector(`#squad-a-options .squad-option[data-squad-id="${selectedSquadA}"]`);
                if (optionA) optionA.classList.add('selected');
            }
            if (selectedSquadB) {
                const optionB = document.querySelector(`#squad-b-options .squad-option[data-squad-id="${selectedSquadB}"]`);
                if (optionB) optionB.classList.add('selected');
            }
            
            // 更新已選擇小隊的能力值顯示
            updateSquadDisplays();
            
            // 更新戰鬥按鈕狀態
            updateArenaBattleButton();
        }

        // 更新小隊顯示（考慮地圖效果）
        function updateSquadDisplays() {
            // 更新小隊A顯示
            if (selectedSquadA) {
                updateSquadDisplay('A', selectedSquadA);
            }
            
            // 更新小隊B顯示
            if (selectedSquadB) {
                updateSquadDisplay('B', selectedSquadB);
            }
        }

        // 更新單個小隊顯示
        function updateSquadDisplay(side, squadId) {
            const originalData = squadData[squadId];
            if (!originalData) return;
            
            const nameElement = document.getElementById(`squad-${side.toLowerCase()}-name`);
            const totalElement = document.getElementById(`squad-${side.toLowerCase()}-total`);
            const skillsElement = document.getElementById(`squad-${side.toLowerCase()}-skills`);
            
            if (!nameElement || !totalElement || !skillsElement) return;
            
            let displayTotal = originalData.total;
            let displayText = `總點數: ${displayTotal}`;
            
            // 如果選擇了地圖，計算修正後的能力值
            if (selectedArenaMap) {
                const modifiedData = applyMapEffects(originalData, selectedArenaMap);
                displayTotal = modifiedData.total;
                
                if (displayTotal !== originalData.total) {
                    displayText = `總點數: ${originalData.total} → ${displayTotal}`;
                    totalElement.style.color = displayTotal > originalData.total ? '#00ff88' : '#ff4757';
                } else {
                    displayText = `總點數: ${displayTotal}`;
                    totalElement.style.color = '#ffd700';
                }
            } else {
                totalElement.style.color = '#ffd700';
            }
            
            nameElement.textContent = `小隊 #${squadId}`;
            totalElement.textContent = displayText;
            
            // 顯示技能卡
            if (squadItemCards[squadId]) {
                const itemName = itemCards[squadItemCards[squadId]].name;
                skillsElement.innerHTML = `<div class="skill-name">技能卡: ${itemName}</div>`;
                skillsElement.style.display = 'block';
            } else {
                skillsElement.innerHTML = `<div class="skill-name">技能卡: 未選擇</div>`;
                skillsElement.style.display = 'block';
            }
        }

        // 顯示競技場地圖效果
        function showArenaMapEffects(mapId) {
            const map = arenaMaps[mapId];
            const effectsContainer = document.getElementById('arena-map-effects');
            const effectsContent = document.getElementById('arena-map-effects-content');
            
            if (!map || !effectsContainer || !effectsContent) return;
            
            effectsContent.innerHTML = '';
            
            Object.keys(map.effects).forEach(attrKey => {
                const multiplier = map.effects[attrKey];
                const attrName = attributeNames[attrKey];
                const attrIcon = attributeIcons[attrKey];
                
                if (!attrName || !attrIcon) return;
                
                const effectItem = document.createElement('div');
                let effectClass = '';
                let effectText = '';
                
                if (multiplier === 0) {
                    effectClass = 'arena-effect-zero';
                    effectText = `${attrIcon} ${attrName} → 0`;
                } else if (multiplier < 1) {
                    effectClass = 'arena-effect-nerf';
                    effectText = `${attrIcon} ${attrName} ×${multiplier}`;
                } else if (multiplier > 1) {
                    effectClass = 'arena-effect-boost';
                    effectText = `${attrIcon} ${attrName} ×${multiplier}`;
                }
                
                effectItem.className = `arena-effect-item ${effectClass}`;
                effectItem.innerHTML = effectText;
                effectsContent.appendChild(effectItem);
            });
            
            effectsContainer.classList.add('visible');
        }

// 修復 applyMapEffects 函數 - 確保返回新對象
function applyMapEffects(squadData, mapId) {
    if (!mapId || !arenaMaps[mapId]) {
        console.log('沒有地圖效果，返回原始數據');
        return deepCopy(squadData);
    }
    
    const map = arenaMaps[mapId];
    console.log(`應用地圖效果: ${map.name}`);
    
    // 深拷貝所有屬性
    const modifiedData = deepCopy(squadData);
    
    // 應用地圖效果
    Object.keys(map.effects).forEach(attrKey => {
        if (modifiedData[attrKey] !== undefined) {
            const multiplier = map.effects[attrKey];
            const oldValue = modifiedData[attrKey];
            
            if (multiplier === 0) {
                modifiedData[attrKey] = 0;
            } else {
                modifiedData[attrKey] = Math.round(modifiedData[attrKey] * multiplier);
            }
            
            console.log(`地圖效果 ${attrKey}: ${oldValue} → ${modifiedData[attrKey]} (×${multiplier})`);
        }
    });
    
    // 重新計算總點數
    recalculateTotal(modifiedData);
    console.log(`地圖效果後總點數: ${modifiedData.total}`);
    
    return modifiedData;
}

        // 更新競技場戰鬥按鈕狀態
        function updateArenaBattleButton() {
            const battleBtn = document.getElementById('arena-battle-btn');
            const revealBtn = document.getElementById('reveal-skills-btn');
            const startBettingBtn = document.getElementById('start-betting-btn');
            
            if (!battleBtn || !revealBtn) return;
            
            const canBattle = selectedSquadA && selectedSquadB && selectedSquadA !== selectedSquadB && selectedArenaMap;
            
            battleBtn.disabled = true; // 先隱藏原戰鬥按鈕
            battleBtn.style.display = 'none';
            
            revealBtn.disabled = !canBattle;
            
            // 更新下注按鈕狀態
            if (startBettingBtn) {
                startBettingBtn.disabled = !canBattle || bettingSystem.enabled;
            }
            
            if (canBattle) {
                revealBtn.textContent = '🔍 公布技能並開始對戰';
                
                // 顯示下注系統
                const bettingSystemDiv = document.getElementById('betting-system');
                if (bettingSystemDiv && !bettingSystem.enabled) {
                    bettingSystemDiv.classList.add('active');
                    updateBettingInfo();
                }
            } else if (!selectedArenaMap) {
                revealBtn.textContent = '請選擇地圖';
            } else if (!selectedSquadA || !selectedSquadB) {
                revealBtn.textContent = '請選擇兩支小隊';
            } else if (selectedSquadA === selectedSquadB) {
                revealBtn.textContent = '不能選擇同一小隊';
            } else {
                revealBtn.textContent = '請選擇地圖和小隊';
            }
        }

        // 更新競技場小隊選項
        function updateArenaSquadOptions() {
            console.log('Updating arena squad options...');
            
            const squadAContainer = document.getElementById('squad-a-options');
            const squadBContainer = document.getElementById('squad-b-options');
            
            if (!squadAContainer || !squadBContainer) {
                console.error('Arena containers not found!');
                return;
            }
            
            squadAContainer.innerHTML = '';
            squadBContainer.innerHTML = '';
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                const data = squadData[squadId];
                if (!data) continue;
                
                // 計算顯示的總點數（考慮地圖效果）
                let displayTotal = data.total;
                let totalText = `總點數: ${displayTotal}`;
                let totalStyle = 'color: #ffd700;';
                
                if (selectedArenaMap) {
                    const modifiedData = applyMapEffects(data, selectedArenaMap);
                    if (modifiedData.total !== data.total) {
                        displayTotal = modifiedData.total;
                        totalText = `總點數: ${data.total} → ${displayTotal}`;
                        totalStyle = displayTotal > data.total ? 'color: #00ff88;' : 'color: #ff4757;';
                    }
                }
                
                // 創建小隊A選項
                const optionA = document.createElement('div');
                optionA.className = 'squad-option';
                optionA.setAttribute('data-squad-id', squadId);
                optionA.setAttribute('data-side', 'A');
                optionA.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectArenaSquad('A', squadId);
                });
                optionA.innerHTML = `
                    <div class="squad-name">小隊 #${squadId}</div>
                    <div class="squad-total" style="${totalStyle}">${totalText}</div>
                `;
                squadAContainer.appendChild(optionA);
                
                // 創建小隊B選項
                const optionB = document.createElement('div');
                optionB.className = 'squad-option';
                optionB.setAttribute('data-squad-id', squadId);
                optionB.setAttribute('data-side', 'B');
                optionB.addEventListener('click', function(e) {
                    e.preventDefault();
                    selectArenaSquad('B', squadId);
                });
                optionB.innerHTML = `
                    <div class="squad-name">小隊 #${squadId}</div>
                    <div class="squad-total" style="${totalStyle}">${totalText}</div>
                `;
                squadBContainer.appendChild(optionB);
            }
        }

        // 選擇競技場小隊
        function selectArenaSquad(side, squadId) {
            try {
                if (side === 'A') {
                    // 清除之前的選擇
                    document.querySelectorAll('#squad-a-options .squad-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // 設置新選擇
                    selectedSquadA = squadId;
                    const clickedOption = document.querySelector(`#squad-a-options .squad-option[data-squad-id="${squadId}"]`);
                    if (clickedOption) {
                        clickedOption.classList.add('selected');
                    }
                    
                    // 更新顯示（考慮地圖效果）
                    updateSquadDisplay('A', squadId);
                    
                } else if (side === 'B') {
                    // 清除之前的選擇
                    document.querySelectorAll('#squad-b-options .squad-option').forEach(option => {
                        option.classList.remove('selected');
                    });
                    
                    // 設置新選擇
                    selectedSquadB = squadId;
                    const clickedOption = document.querySelector(`#squad-b-options .squad-option[data-squad-id="${squadId}"]`);
                    if (clickedOption) {
                        clickedOption.classList.add('selected');
                    }
                    
                    // 更新顯示（考慮地圖效果）
                    updateSquadDisplay('B', squadId);
                }
                
                // 檢查是否可以開始戰鬥
                updateArenaBattleButton();
            } catch (error) {
                console.error('Error in selectArenaSquad:', error);
            }
        }

function startEnhancedArenaBattle() {
    if (!selectedSquadA || !selectedSquadB || selectedSquadA === selectedSquadB || !selectedArenaMap) {
        alert('請選擇兩支不同的小隊和一個地圖！');
        return;
    }
    
    // 處理特殊技能卡（戰鬥前）
    const specialResults = handlePreBattleSpecialCards();
    
    // 🆕 修改：完整處理跳過戰鬥的情況
    if (specialResults && specialResults.skipBattle) {
        // 標記參戰小隊
        battleParticipatedSquads[selectedSquadA] = true;
        battleParticipatedSquads[selectedSquadB] = true;
        
        // 保存技能卡資訊
        const usedCardA = squadItemCards[selectedSquadA];
        const usedCardB = squadItemCards[selectedSquadB];
        
        // 確定使用 AIR JORDAN 的隊伍
        let airJordanUser = null;
        let airJordanOpponent = null;
        if (squadItemCards[selectedSquadA] === 'air_jordan') {
            airJordanUser = selectedSquadA;
            airJordanOpponent = selectedSquadB;
        } else if (squadItemCards[selectedSquadB] === 'air_jordan') {
            airJordanUser = selectedSquadB;
            airJordanOpponent = selectedSquadA;
        }
        
        // 處理下注結算（如果有）
        if (bettingSystem.enabled && airJordanUser) {
            const winner = airJordanUser === selectedSquadA ? 'A' : 'B';
            const bettingResults = calculateBettingRewards(winner);
            displayBettingResults(bettingResults);
        }
        
        // 顯示戰鬥結果
        const resultsContainer = document.getElementById('comparison-results');
        if (resultsContainer && airJordanUser) {
            resultsContainer.innerHTML = `
                <div class="final-result">
                    <div class="final-result-title">🏀 AIR JORDAN 1 發動！ 🏀</div>
                    <div class="winner-announcement">
                        🏆 小隊 #${airJordanUser} 使用 AIR JORDAN 1 直接獲勝！ 🏆
                    </div>
                    <div class="score-display">
                        <div class="score-item">
                            <div class="score-label">小隊 #${airJordanUser}</div>
                            <div class="score-value">+100</div>
                        </div>
                        <div class="score-item">
                            <div class="score-label">小隊 #${airJordanOpponent}</div>
                            <div class="score-value">+0</div>
                        </div>
                    </div>
                    <div class="victory-details">
                        變身成為籃球之神，跳過本輪對戰，直接成為勝利者！
                    </div>
                    ${bettingSystem.enabled ? 
                        '<div class="victory-details">💰 下注系統已結算，詳見上方結果！</div>' : ''
                    }
                </div>
            `;
            resultsContainer.classList.add('active');
        }
        
        // 清理技能卡
        if (usedCardA) {
            permanentlyUsedItems[usedCardA] = true;
            delete takenItems[usedCardA];
            delete squadItemCards[selectedSquadA];
        }
        
        if (usedCardB) {
            permanentlyUsedItems[usedCardB] = true;
            delete takenItems[usedCardB];
            delete squadItemCards[selectedSquadB];
        }
        
        // 如果在道具牆頁面，更新顯示
        const currentPage = document.querySelector('.page.active');
        if (currentPage && currentPage.id === 'items-page') {
            initializeItemsWall();
            updateSquadButtonsForItems();
        }
        
        // 隱藏戰鬥按鈕
        const skillsRevealed = document.getElementById('skills-revealed');
        const battleBtn = skillsRevealed ? skillsRevealed.querySelector('.battle-button-arena') : null;
        if (battleBtn) {
            battleBtn.disabled = true;
            battleBtn.textContent = '戰鬥已完成';
        }
        
        // 更新積分排行榜
        updateRankings();
        return;  // 結束函數，不繼續執行後續戰鬥邏輯
    }
    
    // ⚠️ 重要修改：如果更換了對手，需要重新獲取數據
    if (specialResults && specialResults.changedOpponent) {
        // 重新更新顯示以反映新的對手
        updateSquadDisplay('A', selectedSquadA);
        updateSquadDisplay('B', selectedSquadB);
        updateBettingInfo();
    }
    
    // 標記參戰小隊（但先不刪除技能卡！）
    battleParticipatedSquads[selectedSquadA] = true;
    battleParticipatedSquads[selectedSquadB] = true;
    
    // ⚠️ 重要：先保存技能卡資訊，戰鬥後再刪除
    const usedCardA = squadItemCards[selectedSquadA];
    const usedCardB = squadItemCards[selectedSquadB];
    
    // 獲取原始數據
    const originalSquadA = {...squadData[selectedSquadA]};
    const originalSquadB = {...squadData[selectedSquadB]};
    
    // 計算戰鬥結果（此時技能卡還在！）
    const battleResult = calculateBattleResult(originalSquadA, originalSquadB);
    
    // 處理戰後特殊效果
    const finalResult = handlePostBattleSpecialCards(
        battleResult.winner, 
        battleResult.winnerSquadId, 
        battleResult.loserSquadId, 
        battleResult.finalSquadA.total, 
        battleResult.finalSquadB.total
    );
    
    // 如果需要重打
    if (finalResult && finalResult.retryBattle) {
        handleRetryBattle(finalResult.retrySquadId);
        return;
    }
    
    // 確定最終勝者
    let finalWinner = finalResult && finalResult.newWinner !== null ? finalResult.newWinner : battleResult.winner;
    let finalWinnerSquadId = finalResult && finalResult.newWinnerSquadId !== null ? finalResult.newWinnerSquadId : battleResult.winnerSquadId;
    let finalLoserSquadId = finalResult && finalResult.newLoserSquadId !== null ? finalResult.newLoserSquadId : battleResult.loserSquadId;
    
    // 計算積分
    const scores = calculateBattleScores(finalWinner, finalResult);
    
    // 更新積分
    addSquadScore(selectedSquadA, scores.scoreA);
    addSquadScore(selectedSquadB, scores.scoreB);
    
    // 顯示戰鬥結果
    displayBattleResults(battleResult, finalWinner, scores, finalResult || {});
    
    handlePostBattleEffects(selectedSquadA, selectedSquadB, finalWinnerSquadId, finalLoserSquadId);
    
    // ⚠️ 戰鬥完成後才清理技能卡
    if (usedCardA) {
        permanentlyUsedItems[usedCardA] = true;
        delete takenItems[usedCardA];
        delete squadItemCards[selectedSquadA];
    }
    if (usedCardB) {
        permanentlyUsedItems[usedCardB] = true;
        delete takenItems[usedCardB];
        delete squadItemCards[selectedSquadB];
    }
    
    // 如果在道具牆頁面，立即更新顯示
    const currentPage = document.querySelector('.page.active');
    if (currentPage && currentPage.id === 'items-page') {
        initializeItemsWall();
        updateSquadButtonsForItems();
    }
    
    // 更新積分排行榜
    updateRankings();
}

// 🆕 新增：獲取被動技能名稱
function getPassiveSkillName(skillKey) {
    if (!skillKey) return '無';
    const skill = passiveSkills[skillKey];
    return skill ? skill.name : '無';
}

// 🆕 新增：使用指定被動技能應用效果
function applyPassiveSkillEffectsWithOverride(squadData, selfSquadId, opponentSquadId, overridePassiveSkill) {
    console.log(`應用被動技能效果 - 小隊 #${selfSquadId}`);
    console.log('輸入總點數:', squadData.total);
    
    // 確保深拷貝
    let modifiedData = deepCopy(squadData);
    
    // 檢查是否被超大雨傘消除
    const opponentItem = squadItemCards[opponentSquadId];
    if (opponentItem === 'big_umbrella') {
        console.log('被動技能被超大雨傘消除');
        return modifiedData;
    }
    
    const passiveSkill = overridePassiveSkill;  // 使用傳入的被動技能
    if (!passiveSkill) {
        console.log('沒有被動技能');
        return modifiedData;
    }
    
    const skill = passiveSkills[passiveSkill];
    if (!skill) {
        console.log('被動技能數據無效');
        return modifiedData;
    }
    
    console.log(`使用被動技能: ${skill.name}`);
    
    // 應用被動技能效果
    Object.keys(skill.effects).forEach(attr => {
        const multiplier = skill.effects[attr];
        if (attr === 'opponent_all') {
            console.log('毒氣炸彈效果會在後續處理');
            return;
        } else if (modifiedData[attr] !== undefined) {
            const oldValue = modifiedData[attr];
            modifiedData[attr] = Math.round(modifiedData[attr] * multiplier);
            console.log(`被動技能 ${attr}: ${oldValue} → ${modifiedData[attr]} (×${multiplier})`);
        }
    });
    
    // 重新計算總點數
    recalculateTotal(modifiedData);
    console.log(`被動技能後總點數: ${modifiedData.total}`);
    
    return modifiedData;
}

function calculateBattleResult(originalSquadA, originalSquadB) {
    console.log('=== 開始計算戰鬥結果 ===');
    console.log('輸入原始數據:');
    console.log('  小隊A原始:', originalSquadA.total);
    console.log('  小隊B原始:', originalSquadB.total);
    
    // ⚠️ 關鍵修復：確保每個階段都使用正確的輸入數據
    
    // 階段1：應用地圖效果（使用原始數據）
    let stage1SquadA = applyMapEffects(originalSquadA, selectedArenaMap);
    let stage1SquadB = applyMapEffects(originalSquadB, selectedArenaMap);
    
    console.log('階段1 - 地圖效果後:');
    console.log('  小隊A:', originalSquadA.total, '→', stage1SquadA.total);
    console.log('  小隊B:', originalSquadB.total, '→', stage1SquadB.total);
    
    // 🆕 新增：檢查是否有超大根球棒，如果有則交換被動技能
    let actualPassiveA = squadPassiveSkills[selectedSquadA];
    let actualPassiveB = squadPassiveSkills[selectedSquadB];
    let passiveSwapped = false;
    
    if (squadItemCards[selectedSquadA] === 'baseball_bat' || squadItemCards[selectedSquadB] === 'baseball_bat') {
        // 交換被動技能
        const tempPassive = actualPassiveA;
        actualPassiveA = actualPassiveB;
        actualPassiveB = tempPassive;
        passiveSwapped = true;
        
        const userSquad = squadItemCards[selectedSquadA] === 'baseball_bat' ? selectedSquadA : selectedSquadB;
        
        console.log('超大根球棒發動！被動技能互換');
        alert(
            `⚾ 超大根球棒發動！ ⚾\n\n` +
            `小隊 #${userSquad} 使用超大根球棒！\n` +
            `雙方被動技能已互換！\n\n` +
            `小隊 #${selectedSquadA}: ${getPassiveSkillName(squadPassiveSkills[selectedSquadA])} → ${getPassiveSkillName(actualPassiveA)}\n` +
            `小隊 #${selectedSquadB}: ${getPassiveSkillName(squadPassiveSkills[selectedSquadB])} → ${getPassiveSkillName(actualPassiveB)}`
        );
    }
    
    
   // 階段2：應用被動技能效果（使用階段1的結果和可能交換的被動技能）
let stage2SquadA = applyPassiveSkillEffectsWithOverride(deepCopy(stage1SquadA), selectedSquadA, selectedSquadB, actualPassiveA);
let stage2SquadB = applyPassiveSkillEffectsWithOverride(deepCopy(stage1SquadB), selectedSquadB, selectedSquadA, actualPassiveB);

    
    console.log('階段2 - 被動技能後:');
    console.log('  小隊A:', stage1SquadA.total, '→', stage2SquadA.total);
    console.log('  小隊B:', stage1SquadB.total, '→', stage2SquadB.total);
    
    // 階段3：應用技能卡效果（使用階段2的結果）⚠️ 這裡是關鍵
    console.log('準備進入技能卡階段，輸入數據:');
    console.log('  stage2SquadA.total:', stage2SquadA.total);
    console.log('  stage2SquadB.total:', stage2SquadB.total);
    
    const cardResults = applyItemCardEffects(deepCopy(stage2SquadA), deepCopy(stage2SquadB), selectedSquadA, selectedSquadB);
    let finalSquadA = cardResults.squadA;
    let finalSquadB = cardResults.squadB;
    
    console.log('階段3 - 技能卡效果後:');
    console.log('  小隊A:', stage2SquadA.total, '→', finalSquadA.total);
    console.log('  小隊B:', stage2SquadB.total, '→', finalSquadB.total);
    
    // ⚠️ 關鍵檢查：確保最終結果是正確的
    console.log('=== 最終數據檢查 ===');
    console.log('finalSquadA.total:', finalSquadA.total);
    console.log('finalSquadB.total:', finalSquadB.total);
    
    // 判斷勝者
    let winner = '';
    let winnerSquadId = null;
    let loserSquadId = null;
    
    if (finalSquadA.total > finalSquadB.total) {
        winner = 'A';
        winnerSquadId = selectedSquadA;
        loserSquadId = selectedSquadB;
    } else if (finalSquadB.total > finalSquadA.total) {
        winner = 'B';
        winnerSquadId = selectedSquadB;
        loserSquadId = selectedSquadA;
    } else {
        winner = 'tie';
        winnerSquadId = null;
        loserSquadId = null;
    }
    
    console.log('戰鬥結果:', winner, '勝者ID:', winnerSquadId);
    
    return {
        originalSquadA: originalSquadA,
        originalSquadB: originalSquadB,
        stage1SquadA: stage1SquadA,
        stage1SquadB: stage1SquadB,
        stage2SquadA: stage2SquadA,
        stage2SquadB: stage2SquadB,
        finalSquadA: finalSquadA,  // ⚠️ 確保這個是正確的
        finalSquadB: finalSquadB,  // ⚠️ 確保這個是正確的
        winner: winner,
        winnerSquadId: winnerSquadId,
        loserSquadId: loserSquadId,
        passiveSwapped: passiveSwapped  // 🆕 記錄是否交換了被動技能
    };
}

// 新增深拷貝函數 - 確保數據不被意外修改
function deepCopy(obj) {
    if (obj === null || typeof obj !== 'object') return obj;
    
    const copy = {};
    for (const key in obj) {
        if (obj.hasOwnProperty(key)) {
            copy[key] = obj[key];
        }
    }
    return copy;
}

// 新增：計算戰鬥積分
function calculateBattleScores(winner, specialResults) {
    let scoreA = 0, scoreB = 0;
    
    // 檢查是否有特殊積分規則
    if (specialResults && specialResults.specialScoring) {
        scoreA = specialResults.scoreA || 0;
        scoreB = specialResults.scoreB || 0;
    } else {
        // 普通積分規則
        if (winner === 'A') {
            scoreA = 100;
            scoreB = 0;
        } else if (winner === 'B') {
            scoreA = 0;
            scoreB = 100;
        } else {
            // 平手
            scoreA = 50;
            scoreB = 50;
        }
    }
    
    return { scoreA: scoreA, scoreB: scoreB };
}

// 新增：處理重打邏輯
function handleRetryBattle(retrySquadId) {
    alert(`小隊 #${retrySquadId} 使用大金幣能力！請重新選擇地圖進行戰鬥。\n注意：大金幣只能使用一次！`);  // ← 修改提示文字
    
    // 重置地圖選擇
    selectedArenaMap = null;
    document.querySelectorAll('.arena-map-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    const mapEffects = document.getElementById('arena-map-effects');
    if (mapEffects) {
        mapEffects.classList.remove('visible');
    }
    
    // 重置下注系統
    if (bettingSystem.enabled) {
        bettingSystem.enabled = false;
        bettingSystem.bets = {};
        const bettingSystemDiv = document.getElementById('betting-system');
        if (bettingSystemDiv) {
            bettingSystemDiv.classList.remove('active');
        }
    }
    
    // 顯示重打結果
    const resultsContainer = document.getElementById('comparison-results');
    if (resultsContainer) {
        resultsContainer.innerHTML = `
            <div class="final-result">
                <div class="final-result-title">🪙 大金幣發動！ 🪙</div>
                <div class="winner-announcement">小隊 #${retrySquadId} 戰敗但使用大金幣重新挑戰！</div>
                <div class="victory-details">請重新選擇地圖，所有能力值將獲得 ×1.1 加成</div>
            </div>
        `;
        resultsContainer.classList.add('active');
    }
    
    // 重置按鈕狀態
    const revealBtn = document.getElementById('reveal-skills-btn');
    if (revealBtn) {
        revealBtn.style.display = 'block';
        revealBtn.disabled = true;
        revealBtn.textContent = '請選擇地圖後重新戰鬥';
    }
    
    const skillsRevealed = document.getElementById('skills-revealed');
    if (skillsRevealed) {
        skillsRevealed.style.display = 'none';
    }
}


        // 處理戰鬥前特殊技能卡
        function handlePreBattleSpecialCards() {
            let skipBattle = false;
            let changedOpponent = false;
            let processedCards = []; // 新增：記錄已處理的卡片
            
            // 檢查並處理兩隊的特殊卡
            if (squadItemCards[selectedSquadA]) {
                const itemA = itemCards[squadItemCards[selectedSquadA]];
                if (itemA && itemA.type === 'special') {
                    processedCards.push({squad: selectedSquadA, card: squadItemCards[selectedSquadA]});
                }
            }
            
            if (squadItemCards[selectedSquadB]) {
                const itemB = itemCards[squadItemCards[selectedSquadB]];
                if (itemB && itemB.type === 'special') {
                    processedCards.push({squad: selectedSquadB, card: squadItemCards[selectedSquadB]});
                }
            }
            
            // 處理所有特殊卡
            for (const cardInfo of processedCards) {
                const squadId = cardInfo.squad;
                const cardKey = cardInfo.card;
                
                // 🆕 新增：處理很黏的膠帶
                if (cardKey === 'sticky_tape') {
                    const opponentSquadId = squadId === selectedSquadA ? selectedSquadB : selectedSquadA;
                    const opponentCard = squadItemCards[opponentSquadId];
                    
                    if (opponentCard) {
                        const opponentCardName = itemCards[opponentCard].name;
                        const shouldSteal = confirm(
                            `小隊 #${squadId} 使用很黏的膠帶！\n\n` +
                            `是否要奪取小隊 #${opponentSquadId} 的技能卡「${opponentCardName}」？\n\n` +
                            `選擇「確定」將奪取對方技能卡\n` +
                            `選擇「取消」將保留自己的膠帶`
                        );
                        
                        if (shouldSteal) {
                            // 執行奪取
                            const originalCard = squadItemCards[squadId];
                            
                            // 將對方的技能卡給自己
                            squadItemCards[squadId] = opponentCard;
                            delete takenItems[originalCard]; // 釋放原本的膠帶
                            takenItems[opponentCard] = squadId; // 標記新卡片歸屬
                            
                            // 對方失去技能卡
                            delete squadItemCards[opponentSquadId];
                            
                            alert(
                                `🎯 奪取成功！\n\n` +
                                `小隊 #${squadId} 成功奪取了「${opponentCardName}」！\n` +
                                `小隊 #${opponentSquadId} 失去了技能卡！`
                            );
                            
                            // 更新顯示
                            updateSquadDisplay('A', selectedSquadA);
                            updateSquadDisplay('B', selectedSquadB);
                            
                            // 如果被奪取的卡片也有特殊效果，需要重新處理
                            const stolenItem = itemCards[opponentCard];
                            if (stolenItem && stolenItem.type === 'special' && stolenItem.special !== 'steal_item') {
                                // 將被奪取的卡片加入待處理列表
                                processedCards.push({squad: squadId, card: opponentCard});
                            }
                        } else {
                            alert(`小隊 #${squadId} 選擇保留很黏的膠帶，不奪取對方技能卡。`);
                        }
                    } else {
                        alert(`小隊 #${squadId} 使用很黏的膠帶，但對方沒有技能卡可以奪取！`);
                    }
                }
                
                // 處理 dirty_clothes（十天沒洗的衣服）
                if (cardKey === 'dirty_clothes' && !changedOpponent) {
                    const otherSquad = squadId === selectedSquadA ? selectedSquadB : selectedSquadA;
                    
                    // 找出所有可選擇的隊伍（除了自己）
                    const availableSquads = [];
                    for (let id = 1; id <= 10; id++) {
                        if (id !== squadId) {
                            availableSquads.push(id);
                        }
                    }
                    
                    const squadList = availableSquads.map(id => `${id}`).join(', ');
                    const shouldChange = confirm(`小隊 #${squadId} 擁有十天沒洗的衣服！\n是否要選擇其他隊伍當對手？\n\n可選擇的隊伍：${squadList}\n\n目前對手：小隊 #${otherSquad}`);
                    
                    if (shouldChange) {
                        const newOpponent = prompt(`請輸入要挑戰的隊伍編號（可選：${squadList}）：`);
                        const newOpponentId = parseInt(newOpponent);
                        
                        if (availableSquads.includes(newOpponentId)) {
                            // 更換對手
                            if (squadId === selectedSquadA) {
                                selectedSquadB = newOpponentId;
                            } else {
                                selectedSquadA = newOpponentId;
                            }
                            
                            alert(`對手已更換為小隊 #${newOpponentId}！`);
                            changedOpponent = true;
                            
                            // 更新顯示
                            updateSquadDisplay('A', selectedSquadA);
                            updateSquadDisplay('B', selectedSquadB);
                            updateBettingInfo();
                            // ⚠️ 新增：重新更新技能公布內容
                            updateSkillsRevealed();  // 新增這行
                            
                            // 重置下注系統
                            if (bettingSystem.enabled) {
                                bettingSystem.enabled = false;
                                bettingSystem.bets = {};
                                const bettingSystemDiv = document.getElementById('betting-system');
                                if (bettingSystemDiv) {
                                    bettingSystemDiv.classList.remove('active');
                                }
                            }
                            
                            // 中斷處理，因為對手已更換
                            break;
                        } else {
                            alert('輸入的隊伍編號無效！');
                        }
                    }
                }
                
                // 處理 AIR JORDAN 1（跳過戰鬥）
                if (cardKey === 'air_jordan') {
                    addSquadScore(squadId, 100);
                    alert(`小隊 #${squadId} 使用 AIR JORDAN 1，直接成為勝利者！`);
                    skipBattle = true;
                }
            }
            
            // 檢查超大絨毛玩偶（雙方同意）- 只需檢查一次
            if ((squadItemCards[selectedSquadA] === 'big_doll' || squadItemCards[selectedSquadB] === 'big_doll') && !skipBattle) {
                const agree = confirm('使用超大絨毛玩偶：雙方是否同意各得120分？');
                if (agree) {
                    addSquadScore(selectedSquadA, 120);
                    addSquadScore(selectedSquadB, 120);
                    alert('雙方都獲得了120分！');
                    skipBattle = true;
                }
            }
            
            return { skipBattle: skipBattle, changedOpponent: changedOpponent };
        }

// 修復 applyPassiveSkillEffects 函數 - 確保返回新對象
function applyPassiveSkillEffects(squadData, selfSquadId, opponentSquadId) {
    console.log(`應用被動技能效果 - 小隊 #${selfSquadId}`);
    console.log('輸入總點數:', squadData.total);
    
    // 確保深拷貝
    let modifiedData = deepCopy(squadData);
    
    // 檢查是否被超大雨傘消除
    const opponentItem = squadItemCards[opponentSquadId];
    if (opponentItem === 'big_umbrella') {
        console.log('被動技能被超大雨傘消除');
        return modifiedData;
    }
    
    const passiveSkill = squadPassiveSkills[selfSquadId];
    if (!passiveSkill) {
        console.log('沒有被動技能');
        return modifiedData;
    }
    
    const skill = passiveSkills[passiveSkill];
    if (!skill) {
        console.log('被動技能數據無效');
        return modifiedData;
    }
    
    console.log(`使用被動技能: ${skill.name}`);
    
    // 應用被動技能效果
    Object.keys(skill.effects).forEach(attr => {
        const multiplier = skill.effects[attr];
        if (attr === 'opponent_all') {
            console.log('毒氣炸彈效果會在後續處理');
            return;
        } else if (modifiedData[attr] !== undefined) {
            const oldValue = modifiedData[attr];
            modifiedData[attr] = Math.round(modifiedData[attr] * multiplier);
            console.log(`被動技能 ${attr}: ${oldValue} → ${modifiedData[attr]} (×${multiplier})`);
        }
    });
    
    // 重新計算總點數
    recalculateTotal(modifiedData);
    console.log(`被動技能後總點數: ${modifiedData.total}`);
    
    return modifiedData;
}

function applyItemCardEffects(squadAData, squadBData, squadAId, squadBId) {
    console.log('=== 開始應用技能卡效果 ===');
    console.log('輸入數據 - 小隊A:', squadAData.total, '小隊B:', squadBData.total);
    
    // 深拷貝所有屬性 - 確保不影響原始數據
    let modifiedSquadA = {};
    let modifiedSquadB = {};
    
    attributes.forEach(attr => {
        modifiedSquadA[attr] = squadAData[attr];
        modifiedSquadB[attr] = squadBData[attr];
    });
    modifiedSquadA.total = squadAData.total;
    modifiedSquadB.total = squadBData.total;
    
    
    console.log('深拷貝後 - 小隊A:', modifiedSquadA.total, '小隊B:', modifiedSquadB.total);
    
    // 🆕 新增：先檢查充氣懶骨頭效果（需要在應用其他效果前判斷原始總點數）
    const squadAOriginalTotal = squadData[squadAId].total;
    const squadBOriginalTotal = squadData[squadBId].total;
    
    // 處理小隊A的充氣懶骨頭
    if (squadItemCards[squadAId] === 'lazy_chair' && squadAOriginalTotal < squadBOriginalTotal) {
        console.log(`小隊A使用充氣懶骨頭，原始總點數 ${squadAOriginalTotal} < ${squadBOriginalTotal}`);
        attributes.forEach(attr => {
            const oldValue = modifiedSquadA[attr];
            modifiedSquadA[attr] = Math.round(modifiedSquadA[attr] * 1.5);
            console.log(`充氣懶骨頭效果 - ${attr}: ${oldValue} → ${modifiedSquadA[attr]}`);
        });
        recalculateTotal(modifiedSquadA);
        console.log(`小隊A充氣懶骨頭效果後總點數: ${modifiedSquadA.total}`);
    }
    
    // 處理小隊B的充氣懶骨頭
    if (squadItemCards[squadBId] === 'lazy_chair' && squadBOriginalTotal < squadAOriginalTotal) {
        console.log(`小隊B使用充氣懶骨頭，原始總點數 ${squadBOriginalTotal} < ${squadAOriginalTotal}`);
        attributes.forEach(attr => {
            const oldValue = modifiedSquadB[attr];
            modifiedSquadB[attr] = Math.round(modifiedSquadB[attr] * 1.5);
            console.log(`充氣懶骨頭效果 - ${attr}: ${oldValue} → ${modifiedSquadB[attr]}`);
        });
        recalculateTotal(modifiedSquadB);
        console.log(`小隊B充氣懶骨頭效果後總點數: ${modifiedSquadB.total}`);
    }
    
    // 先處理普通屬性效果（確保按順序處理）
    if (squadItemCards[squadAId] && squadItemCards[squadAId] !== 'lazy_chair') {
        const cardKey = squadItemCards[squadAId];
        const card = itemCards[cardKey];
        console.log(`小隊A使用技能卡: ${card.name} (${cardKey})`);
        
        // 應用技能卡效果到小隊A
        modifiedSquadA = applyItemCardToSquad(modifiedSquadA, card, modifiedSquadB, squadAId, squadBId);
        console.log(`小隊A技能卡效果後:`, modifiedSquadA.total);
    }
    
    if (squadItemCards[squadBId] && squadItemCards[squadBId] !== 'lazy_chair') {
        const cardKey = squadItemCards[squadBId];
        const card = itemCards[cardKey];
        console.log(`小隊B使用技能卡: ${card.name} (${cardKey})`);
        
        // 應用技能卡效果到小隊B
        modifiedSquadB = applyItemCardToSquad(modifiedSquadB, card, modifiedSquadA, squadBId, squadAId);
        console.log(`小隊B技能卡效果後:`, modifiedSquadB.total);
    }
    
    // 處理需要互動的特殊效果（iPhone18等）
    const interactiveEffects = [];
    
    if (squadItemCards[squadAId] === 'iphone18') {
        interactiveEffects.push({
            squad: squadAId,
            target: squadBId,
            type: 'iphone18'
        });
    }
    
    if (squadItemCards[squadBId] === 'iphone18') {
        interactiveEffects.push({
            squad: squadBId,
            target: squadAId,
            type: 'iphone18'
        });
    }
    
    // 🆕 新增：神秘的天平檢查
    if (squadItemCards[squadAId] === 'mystery_balance') {
        interactiveEffects.push({
            squad: squadAId,
            target: squadBId,
            type: 'mystery_balance'
        });
    }
    
    if (squadItemCards[squadBId] === 'mystery_balance') {
        interactiveEffects.push({
            squad: squadBId,
            target: squadAId,
            type: 'mystery_balance'
        });
    }
    
    // 處理所有互動效果
    for (const effect of interactiveEffects) {
        if (effect.type === 'iphone18') {
            console.log(`處理小隊 #${effect.squad} 的iPhone18效果`);
            
            const attrNames = Object.values(attributeNames);
            const attrKeys = Object.keys(attributeNames);
            
            const targetData = effect.target === squadAId ? modifiedSquadA : modifiedSquadB;
            
            const choice = prompt(
                `小隊 #${effect.squad} 使用 iPhone18！\n` +
                `選擇要將小隊 #${effect.target} 的哪個能力歸零：\n\n` +
                attrKeys.map((key, index) => `${index + 1}. ${attributeIcons[key]} ${attrNames[index]} (目前: ${targetData[key]})`).join('\n')
            );
            
            const choiceIndex = parseInt(choice) - 1;
            if (choiceIndex >= 0 && choiceIndex < attrKeys.length) {
                const attrKey = attrKeys[choiceIndex];
                const originalValue = targetData[attrKey];
                targetData[attrKey] = 0;
                
                if (effect.target === squadAId) {
                    recalculateTotal(modifiedSquadA);
                    console.log(`iPhone18效果後，小隊A總點數: ${modifiedSquadA.total}`);
                } else {
                    recalculateTotal(modifiedSquadB);
                    console.log(`iPhone18效果後，小隊B總點數: ${modifiedSquadB.total}`);
                }
                
                alert(`小隊 #${effect.target} 的${attrNames[choiceIndex]}從 ${originalValue} 歸零！`);
            }
        }
        
        // 🆕 新增：處理神秘的天平效果
        if (effect.type === 'mystery_balance') {
            console.log(`處理小隊 #${effect.squad} 的神秘天平效果`);
            
            const attrNames = Object.values(attributeNames);
            const attrKeys = Object.keys(attributeNames);
            
            const squadData = effect.squad === squadAId ? modifiedSquadA : modifiedSquadB;
            const targetData = effect.target === squadAId ? modifiedSquadA : modifiedSquadB;
            
            const choice = prompt(
                `小隊 #${effect.squad} 使用神秘的天平！\n` +
                `選擇要平分的能力：\n\n` +
                attrKeys.map((key, index) => 
                    `${index + 1}. ${attributeIcons[key]} ${attrNames[index]} ` +
                    `(你的: ${squadData[key]}, 對方: ${targetData[key]})`
                ).join('\n')
            );
            
            const choiceIndex = parseInt(choice) - 1;
            if (choiceIndex >= 0 && choiceIndex < attrKeys.length) {
                const attrKey = attrKeys[choiceIndex];
                const totalValue = squadData[attrKey] + targetData[attrKey];
                const averageValue = Math.round(totalValue / 2);
                
                const originalSquadValue = squadData[attrKey];
                const originalTargetValue = targetData[attrKey];
                
                // 設定平均值
                squadData[attrKey] = averageValue;
                targetData[attrKey] = averageValue;
                
                // 重新計算總點數
                recalculateTotal(modifiedSquadA);
                recalculateTotal(modifiedSquadB);
                
                console.log(`神秘天平效果 - ${attrKey}: 小隊${effect.squad} ${originalSquadValue}→${averageValue}, 小隊${effect.target} ${originalTargetValue}→${averageValue}`);
                console.log(`神秘天平效果後 - 小隊A總點數: ${modifiedSquadA.total}, 小隊B總點數: ${modifiedSquadB.total}`);
                
                alert(
                    `⚖️ 神秘的天平發動！ ⚖️\n\n` +
                    `${attrNames[choiceIndex]}能力已平分：\n` +
                    `小隊 #${effect.squad}: ${originalSquadValue} → ${averageValue}\n` +
                    `小隊 #${effect.target}: ${originalTargetValue} → ${averageValue}\n\n` +
                    `總和 ${totalValue} 點平均分配！`
                );
            }
        }
    }
    
    console.log('=== 技能卡效果計算完成 ===');
    console.log('最終結果 - 小隊A:', modifiedSquadA.total, '小隊B:', modifiedSquadB.total);
    
    return { squadA: modifiedSquadA, squadB: modifiedSquadB };
}


// 修復單個技能卡應用函數 - 需要完全替換原有的 applyItemCardToSquad 函數
function applyItemCardToSquad(squadData, card, opponentData, selfSquadId, opponentSquadId) {
    if (!card) {
        console.log('沒有技能卡，返回原始數據');
        return squadData;
    }
    
    console.log(`應用技能卡: ${card.name}, 類型: ${card.type}`);
    console.log('應用前總點數:', squadData.total);
    
    // 深拷貝所有屬性
    let modifiedData = {};
    attributes.forEach(attr => {
        modifiedData[attr] = squadData[attr];
    });
    modifiedData.total = squadData.total;
    
    if (card.type === 'attribute') {
        console.log('處理屬性類型技能卡');
        
        // 普通屬性調整
        Object.keys(card.effects).forEach(attr => {
            const multiplier = card.effects[attr];
            console.log(`處理屬性 ${attr}, 倍數: ${multiplier}`);
            
            if (attr === 'all') {
                // 所有屬性乘以倍數
                console.log('應用全屬性效果');
                attributes.forEach(attribute => {
                    const oldValue = modifiedData[attribute];
                    modifiedData[attribute] = Math.round(modifiedData[attribute] * multiplier);
                    console.log(`${attribute}: ${oldValue} → ${modifiedData[attribute]}`);
                });
            } else if (modifiedData[attr] !== undefined) {
                const oldValue = modifiedData[attr];
                if (multiplier === 0) {
                    modifiedData[attr] = 0;
                } else {
                    modifiedData[attr] = Math.round(modifiedData[attr] * multiplier);
                }
                console.log(`${attr}: ${oldValue} → ${modifiedData[attr]}`);
            }
        });
        
        recalculateTotal(modifiedData);
        console.log('屬性調整後總點數:', modifiedData.total);
        
    } else if (card.type === 'special') {
        console.log('處理特殊類型技能卡');
        
        // 特殊效果卡片仍需要處理 all 屬性加成
        if (card.effects && card.effects.all) {
            console.log(`應用特殊卡片的全屬性效果: ×${card.effects.all}`);
            attributes.forEach(attr => {
                const oldValue = modifiedData[attr];
                modifiedData[attr] = Math.round(modifiedData[attr] * card.effects.all);
                console.log(`${attr}: ${oldValue} → ${modifiedData[attr]}`);
            });
            recalculateTotal(modifiedData);
            console.log('特殊卡片屬性調整後總點數:', modifiedData.total);
        }
    }
    
    return modifiedData;
}

    
// 確保 recalculateTotal 函數正確運作
function recalculateTotal(squadData) {
    let total = 0;
    attributes.forEach(attr => {
        total += squadData[attr] || 0;
    });
    const oldTotal = squadData.total;
    squadData.total = total;
    
    if (oldTotal !== total) {
        console.log(`重新計算總點數: ${oldTotal} → ${total}`);
    }
}

        // 處理戰鬥後特殊技能卡
// 修改：處理戰鬥後特殊技能卡 - 簡化邏輯
function handlePostBattleSpecialCards(originalWinner, winnerSquadId, loserSquadId, totalA, totalB) {
    let newWinner = null;
    let newWinnerSquadId = null;
    let newLoserSquadId = null;
    let specialScoring = false;
    let scoreA = 0, scoreB = 0;
    let retryBattle = false;
    let retrySquadId = null;
    
    console.log('處理戰後特殊效果:', { originalWinner, winnerSquadId, loserSquadId, totalA, totalB });
    
// 檢查雙方是否有大金幣（不管輸贏）
const checkGoldCoin = (squadId) => {
    if (squadItemCards[squadId] === 'gold_coin' && !usedGoldCoins[squadId]) {
        const result = originalWinner === 'tie' ? '平手' : 
                      (squadId === winnerSquadId ? '獲勝' : '戰敗');
        const shouldRetry = confirm(
            `小隊 #${squadId} ${result}！\n` +
            `擁有大金幣，是否要更換地圖重新戰鬥？\n` +
            `（之前的下注和積分將不計算）`
        );
        if (shouldRetry) {
            usedGoldCoins[squadId] = true;
            return true;
        }
    } else if (squadItemCards[squadId] === 'gold_coin' && usedGoldCoins[squadId]) {
        alert(`小隊 #${squadId} 的大金幣已經使用過一次，無法再次使用！`);
    }
    return false;
};

// 檢查小隊A
if (checkGoldCoin(selectedSquadA)) {
    return { 
        retryBattle: true, 
        retrySquadId: selectedSquadA,
        skipScoring: true
    };
}

// 檢查小隊B
if (checkGoldCoin(selectedSquadB)) {
    return { 
        retryBattle: true, 
        retrySquadId: selectedSquadB,
        skipScoring: true
    };
}
    
    // 檢查超臭襪子（顛倒勝負）
    const hasSmellySock = squadItemCards[selectedSquadA] === 'smelly_sock' || squadItemCards[selectedSquadB] === 'smelly_sock';
    if (hasSmellySock && originalWinner !== 'tie') {
        newWinner = originalWinner === 'A' ? 'B' : 'A';
        newWinnerSquadId = originalWinner === 'A' ? selectedSquadB : selectedSquadA;
        newLoserSquadId = originalWinner === 'A' ? selectedSquadA : selectedSquadB;
        
        const sockUser = squadItemCards[selectedSquadA] === 'smelly_sock' ? selectedSquadA : selectedSquadB;
        alert(`小隊 #${sockUser} 因為超臭襪子，顛倒勝負！`);
    }
    

// 檢查5090ti顯卡（高風險高回報）
const finalWinner = newWinner || originalWinner;

if (squadItemCards[selectedSquadA] === 'rtx_5090') {
    const isWinner = finalWinner === 'A';
    if (isWinner) {
        scoreA = 200;
        specialScoring = true;
        alert(`🎮 5090ti顯卡效能全開！小隊 #${selectedSquadA} 獲得200積分！`);
    } else {
        // 🆕 修改：記錄減少前的數值
        const beforeStats = {};
        attributes.forEach(attr => {
            beforeStats[attr] = squadData[selectedSquadA][attr];
        });
        const beforeTotal = squadData[selectedSquadA].total;
        
        // 失敗減少所有能力10點（永久效果）
        attributes.forEach(attr => {
            squadData[selectedSquadA][attr] = Math.max(0, squadData[selectedSquadA][attr] - 10);
        });
        updateTotalPoints(selectedSquadA);
        
        // 🆕 新增：構建詳細報告
        let detailReport = '';
        attributes.forEach(attr => {
            const before = beforeStats[attr];
            const after = squadData[selectedSquadA][attr];
            if (before !== after) {
                detailReport += `${attributeIcons[attr]} ${attributeNames[attr]}: ${before} → ${after}\n`;
            }
        });
        
        alert(
            `💥 5090ti顯卡燒壞了！ 💥\n\n` +
            `小隊 #${selectedSquadA} 戰敗導致顯卡過熱！\n\n` +
            `永久能力值損失：\n${detailReport}\n` +
            `總點數：${beforeTotal} → ${squadData[selectedSquadA].total}\n\n` +
            `此效果為永久有效！`
        );
        
        // 🆕 新增：強制更新所有頁面的顯示
        updateAllDisplays(selectedSquadA, selectedSquadA);
    }
}

if (squadItemCards[selectedSquadB] === 'rtx_5090') {
    const isWinner = finalWinner === 'B';
    if (isWinner) {
        scoreB = 200;
        specialScoring = true;
        alert(`🎮 5090ti顯卡效能全開！小隊 #${selectedSquadB} 獲得200積分！`);
    } else {
        // 🆕 修改：記錄減少前的數值
        const beforeStats = {};
        attributes.forEach(attr => {
            beforeStats[attr] = squadData[selectedSquadB][attr];
        });
        const beforeTotal = squadData[selectedSquadB].total;
        
        // 失敗減少所有能力10點（永久效果）
        attributes.forEach(attr => {
            squadData[selectedSquadB][attr] = Math.max(0, squadData[selectedSquadB][attr] - 10);
        });
        updateTotalPoints(selectedSquadB);
        
        // 🆕 新增：構建詳細報告
        let detailReport = '';
        attributes.forEach(attr => {
            const before = beforeStats[attr];
            const after = squadData[selectedSquadB][attr];
            if (before !== after) {
                detailReport += `${attributeIcons[attr]} ${attributeNames[attr]}: ${before} → ${after}\n`;
            }
        });
        
        alert(
            `💥 5090ti顯卡燒壞了！ 💥\n\n` +
            `小隊 #${selectedSquadB} 戰敗導致顯卡過熱！\n\n` +
            `永久能力值損失：\n${detailReport}\n` +
            `總點數：${beforeTotal} → ${squadData[selectedSquadB].total}\n\n` +
            `此效果為永久有效！`
        );
        
        // 🆕 新增：強制更新所有頁面的顯示
        updateAllDisplays(selectedSquadB, selectedSquadB);
    }
}
    
    console.log('戰後特殊效果結果:', { newWinner, newWinnerSquadId, newLoserSquadId, specialScoring, scoreA, scoreB });
    
    return { 
        newWinner: newWinner, 
        newWinnerSquadId: newWinnerSquadId, 
        newLoserSquadId: newLoserSquadId, 
        specialScoring: specialScoring, 
        scoreA: scoreA, 
        scoreB: scoreB 
    };
}

       // 處理戰後效果
function handlePostBattleEffects(squadAId, squadBId, winnerId, loserId) {
    // 🆕 修改：閃電五連鞭效果（不管輸贏都能發動）
    const checkAndExecuteLightningWhip = (ownerId, targetId) => {
        if (squadItemCards[ownerId] === 'lightning_whip') {
            console.log(`小隊 #${ownerId} 使用閃電五連鞭攻擊小隊 #${targetId}`);
            
            // 記錄減少前的數值
            const beforeStats = {};
            attributes.forEach(attr => {
                beforeStats[attr] = squadData[targetId][attr];
            });
            const beforeTotal = squadData[targetId].total;
            
            // 對每個屬性減少15點
            attributes.forEach(attr => {
                squadData[targetId][attr] = Math.max(0, squadData[targetId][attr] - 15);
            });
            
            // 重新計算總點數
            updateTotalPoints(targetId);
            
            // 構建詳細報告
            let detailReport = '';
            attributes.forEach(attr => {
                const before = beforeStats[attr];
                const after = squadData[targetId][attr];
                if (before !== after) {
                    detailReport += `${attributeIcons[attr]} ${attributeNames[attr]}: ${before} → ${after}\n`;
                }
            });
            
            alert(
                `⚡ 閃電五連鞭發動！ ⚡\n\n` +
                `小隊 #${ownerId} 的閃電五連鞭攻擊了小隊 #${targetId}！\n\n` +
                `能力值變化：\n${detailReport}\n` +
                `總點數：${beforeTotal} → ${squadData[targetId].total}\n\n` +
                `此效果為永久有效！`
            );
            
            // 強制更新所有頁面的顯示
            updateAllDisplays(ownerId, targetId);
        }
    };
    
    // 🆕 檢查雙方是否有閃電五連鞭（不管輸贏）
    checkAndExecuteLightningWhip(squadAId, squadBId);
    checkAndExecuteLightningWhip(squadBId, squadAId);
    
    // Adidos跑鞋效果 - 不管勝負都能發動
    const checkAndExecuteAdidasEffect = (ownerId, targetId) => {
        if (squadItemCards[ownerId] === 'fake_shoes') {
            // 讓玩家選擇要盜取哪個屬性
            const attrNames = Object.values(attributeNames);
            const attrKeys = Object.keys(attributeNames);
            const isWinner = ownerId === winnerId;
            const statusText = isWinner ? '（勝者）' : '（敗者）';
            
            const choice = prompt(
                `小隊 #${ownerId} ${statusText} 使用 Adidos跑鞋！\n` +
                `選擇要盜取小隊 #${targetId} 的屬性（盜取到自己100或對方0為止）：\n\n` +
                attrKeys.map((key, index) => 
                    `${index + 1}. ${attributeIcons[key]} ${attrNames[index]} ` +
                    `(你的: ${squadData[ownerId][key]}, 對方: ${squadData[targetId][key]})`
                ).join('\n')
            );
            const choiceIndex = parseInt(choice) - 1;
            
            if (choiceIndex >= 0 && choiceIndex < attrKeys.length) {
                const attrKey = attrKeys[choiceIndex];
                const ownerCurrent = squadData[ownerId][attrKey];
                const targetCurrent = squadData[targetId][attrKey];
                
                // 計算可以盜取的點數
                const maxCanSteal = Math.min(
                    100 - ownerCurrent,  // 自己最多到100
                    targetCurrent        // 對方最多到0
                );
                
                const stolenPoints = Math.max(0, maxCanSteal);
                
                if (stolenPoints > 0) {
                    // 執行盜取
                    squadData[targetId][attrKey] = targetCurrent - stolenPoints;
                    squadData[ownerId][attrKey] = ownerCurrent + stolenPoints;
                    
                    // 更新總點數
                    updateTotalPoints(ownerId);
                    updateTotalPoints(targetId);
                    
                    // 強制更新所有頁面的顯示
                    updateAllDisplays(ownerId, targetId, attrKey);
                    
                    alert(
                        `🦶 Adidos跑鞋發動！高仿盜版的力量！\n\n` +
                        `小隊 #${ownerId} ${statusText} 成功盜取了小隊 #${targetId} 的${attrNames[choiceIndex]} ${stolenPoints}點！\n\n` +
                        `小隊 #${ownerId} ${attrNames[choiceIndex]}: ${ownerCurrent} → ${squadData[ownerId][attrKey]}\n` +
                        `小隊 #${targetId} ${attrNames[choiceIndex]}: ${targetCurrent} → ${squadData[targetId][attrKey]}\n\n` +
                        `此效果為永久有效！`
                    );
                } else {
                    alert(`無法盜取！你的${attrNames[choiceIndex]}已達100或對方已經是0！`);
                }
            }
        }
    };
    
    // 檢查雙方是否有Adidos跑鞋
    checkAndExecuteAdidasEffect(squadAId, squadBId);
    checkAndExecuteAdidasEffect(squadBId, squadAId);
}

// 更新所有頁面的顯示
function updateAllDisplays(squadId1, squadId2, changedAttr = null) {
    // 更新小隊管理頁面
    [squadId1, squadId2].forEach(squadId => {
        const squad = document.querySelector(`[data-squad="${squadId}"]`);
        if (squad) {
            // 🆕 如果沒有指定特定屬性，更新所有屬性
            if (!changedAttr) {
                attributes.forEach(attr => {
                    const attrInput = squad.querySelector(`[data-attr="${attr}"]`);
                    if (attrInput) {
                        attrInput.value = squadData[squadId][attr];
                        updateAttribute(squadId, attr, squadData[squadId][attr]);
                    }
                });
            } else {
                // 更新特定屬性
                const attrInput = squad.querySelector(`[data-attr="${changedAttr}"]`);
                if (attrInput) {
                    attrInput.value = squadData[squadId][changedAttr];
                    updateAttribute(squadId, changedAttr, squadData[squadId][changedAttr]);
                }
            }
            
            // 更新總點數顯示
            const totalElement = squad.querySelector('.total-value');
            if (totalElement) {
                totalElement.textContent = squadData[squadId].total;
            }
        }
    });
    
    // 更新競技場頁面的小隊選項
    const currentPage = document.querySelector('.page.active');
    if (currentPage && currentPage.id === 'arena-page') {
        updateArenaSquadOptions();
        // 如果已選擇的小隊受到影響，更新顯示
        if (selectedSquadA === squadId1 || selectedSquadA === squadId2) {
            updateSquadDisplay('A', selectedSquadA);
        }
        if (selectedSquadB === squadId1 || selectedSquadB === squadId2) {
            updateSquadDisplay('B', selectedSquadB);
        }
    }
    
    // 更新戰場頁面的小隊選擇框
    if (currentPage && currentPage.id === 'battlefield-page') {
        updateSquadCheckboxes();
    }
    
    // 更新積分排行榜
    if (currentPage && currentPage.id === 'rankings-page') {
        updateRankings();
    }
}

// 確保 displayBattleResults 使用正確的數據
function displayBattleResults(battleResult, finalWinner, scores, specialResults) {
    console.log('=== 顯示戰鬥結果 ===');
    console.log('battleResult.finalSquadA.total:', battleResult.finalSquadA.total);
    console.log('battleResult.finalSquadB.total:', battleResult.finalSquadB.total);
    console.log('finalWinner:', finalWinner);
    
    const resultsContainer = document.getElementById('comparison-results');
    if (!resultsContainer) return;
    
    resultsContainer.innerHTML = '';
    
    const selectedMap = arenaMaps[selectedArenaMap];
    
    // 確定勝者文字
    let winnerText = '';
    if (finalWinner === 'A') {
        winnerText = `🏆 小隊 #${selectedSquadA} 獲勝！ 🏆`;
    } else if (finalWinner === 'B') {
        winnerText = `🏆 小隊 #${selectedSquadB} 獲勝！ 🏆`;
    } else {
        winnerText = '🤝 平手！ 🤝';
    }
    
    // 處理下注結算
    if (bettingSystem.enabled) {
        const bettingResults = calculateBettingRewards(finalWinner);
        displayBettingResults(bettingResults);
        updateRankings();
    }
    
    // 顯示地圖信息
    const mapInfoDiv = document.createElement('div');
    mapInfoDiv.className = 'arena-map-selector';
    mapInfoDiv.style.marginBottom = '20px';
    mapInfoDiv.innerHTML = `
        <div class="arena-map-title">🗺️ 戰鬥地圖: ${selectedMap.icon} ${selectedMap.name}</div>
        <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
            ${Object.keys(selectedMap.effects).map(attrKey => {
                const multiplier = selectedMap.effects[attrKey];
                const attrName = attributeNames[attrKey];
                const attrIcon = attributeIcons[attrKey];
                let effectClass = '';
                let effectText = '';
                
                if (multiplier === 0) {
                    effectClass = 'arena-effect-zero';
                    effectText = `${attrIcon} ${attrName} → 0`;
                } else if (multiplier < 1) {
                    effectClass = 'arena-effect-nerf';
                    effectText = `${attrIcon} ${attrName} ×${multiplier}`;
                } else if (multiplier > 1) {
                    effectClass = 'arena-effect-boost';
                    effectText = `${attrIcon} ${attrName} ×${multiplier}`;
                }
                
                return `<div class="arena-effect-item ${effectClass}" style="margin: 5px;">${effectText}</div>`;
            }).join('')}
        </div>
    `;
    resultsContainer.appendChild(mapInfoDiv);
    
    // ⚠️ 關鍵修復：確保使用正確的最終數值
    const finalTotalA = battleResult.finalSquadA.total;
    const finalTotalB = battleResult.finalSquadB.total;
    
    console.log('顯示用的最終數值 - A:', finalTotalA, 'B:', finalTotalB);
    
    // 創建總能力值比較顯示
    const totalComparisonDiv = document.createElement('div');
    totalComparisonDiv.className = 'total-comparison';
    totalComparisonDiv.innerHTML = `
        <div class="total-comparison-title">⚔️ 最終戰鬥結果 ⚔️</div>
        <div class="total-vs-display">
            <div class="total-squad-info">
                <div class="total-squad-name">小隊 #${selectedSquadA}</div>
                <div style="color: #ffd700; font-size: 1em; margin: 5px 0;">
                    原始: ${battleResult.originalSquadA.total} → 最終: ${finalTotalA}
                </div>
                <div class="total-value ${finalWinner === 'A' ? 'winner' : (finalWinner === 'B' ? 'loser' : '')}">${finalTotalA}</div>
            </div>
            
            <div class="total-vs-text">VS</div>
            
            <div class="total-squad-info">
                <div class="total-squad-name">小隊 #${selectedSquadB}</div>
                <div style="color: #ffd700; font-size: 1em; margin: 5px 0;">
                    原始: ${battleResult.originalSquadB.total} → 最終: ${finalTotalB}
                </div>
                <div class="total-value ${finalWinner === 'B' ? 'winner' : (finalWinner === 'A' ? 'loser' : '')}">${finalTotalB}</div>
            </div>
        </div>
        
        <div class="total-difference">
            ${finalWinner !== 'tie' ? `最終能力值差距: ${Math.abs(finalTotalA - finalTotalB)} 點` : '實力相當！'}
        </div>
    `;
    resultsContainer.appendChild(totalComparisonDiv);
    
    // 創建詳細計算過程顯示
    const detailsDiv = createBattleCalculationDetails(battleResult);
    resultsContainer.appendChild(detailsDiv);
    
    // 顯示積分獲得情況
    const scoreDiv = document.createElement('div');
    scoreDiv.className = 'final-result';
    scoreDiv.innerHTML = `
        <div class="final-result-title">🏆 戰鬥結果 🏆</div>
        <div class="winner-announcement">${winnerText}</div>
        <div class="score-display">
            <div class="score-item">
                <div class="score-label">小隊 #${selectedSquadA}</div>
                <div class="score-value">+${scores.scoreA}</div>
            </div>
            <div class="score-item">
                <div class="score-label">小隊 #${selectedSquadB}</div>
                <div class="score-value">+${scores.scoreB}</div>
            </div>
        </div>
        ${specialResults && specialResults.specialScoring ? 
            '<div class="victory-details">⚡ 特殊技能卡效果影響了積分獲得！</div>' : 
            '<div class="victory-details">勝者獲得100積分，敗者獲得0積分</div>'
        }
        ${bettingSystem.enabled ? 
            '<div class="victory-details">💰 下注系統已結算，詳見上方結果！</div>' : ''
        }
    `;
    
    resultsContainer.appendChild(scoreDiv);
    resultsContainer.classList.add('active');
    
    // 隱藏戰鬥按鈕
    const skillsRevealed = document.getElementById('skills-revealed');
    const battleBtn = skillsRevealed ? skillsRevealed.querySelector('.battle-button-arena') : null;
    if (battleBtn) {
        battleBtn.disabled = true;
        battleBtn.textContent = '戰鬥已完成';
    }
}

// 新增：創建戰鬥計算詳情
function createBattleCalculationDetails(battleResult) {
    const detailsDiv = document.createElement('div');
    detailsDiv.className = 'attribute-details';
    detailsDiv.style.marginTop = '20px';
    
    detailsDiv.innerHTML = `
        <div class="details-title">📊 詳細數值變化過程</div>
        <div class="calculation-stages">
            ${createStageComparison('原始能力值', battleResult.originalSquadA, battleResult.originalSquadB)}
            ${createStageComparison('地圖效果後', battleResult.stage1SquadA, battleResult.stage1SquadB, battleResult.originalSquadA, battleResult.originalSquadB)}
            ${createStageComparison('被動技能後', battleResult.stage2SquadA, battleResult.stage2SquadB, battleResult.stage1SquadA, battleResult.stage1SquadB)}
            ${createStageComparison('技能卡效果後', battleResult.finalSquadA, battleResult.finalSquadB, battleResult.stage2SquadA, battleResult.stage2SquadB)}
        </div>
    `;
    
    return detailsDiv;
}

// 新增：創建階段比較
function createStageComparison(stageName, squadA, squadB, prevSquadA = null, prevSquadB = null) {
    return `
        <div style="background: rgba(255, 255, 255, 0.05); border-radius: 10px; padding: 15px; margin-bottom: 15px;">
            <div style="color: #ffd700; font-weight: bold; text-align: center; margin-bottom: 10px;">${stageName}</div>
            <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 15px; align-items: center;">
                <div style="text-align: center;">
                    <div style="color: #00ffff; font-weight: bold; margin-bottom: 5px;">小隊 #${selectedSquadA}</div>
                    <div style="color: #fff; font-size: 1.5em; font-weight: bold;">
                        ${prevSquadA && prevSquadA.total !== squadA.total ? `${prevSquadA.total} → ` : ''}${squadA.total}
                    </div>
                </div>
                <div style="color: #ff4757; font-size: 1.5em; font-weight: bold;">VS</div>
                <div style="text-align: center;">
                    <div style="color: #00ffff; font-weight: bold; margin-bottom: 5px;">小隊 #${selectedSquadB}</div>
                    <div style="color: #fff; font-size: 1.5em; font-weight: bold;">
                        ${prevSquadB && prevSquadB.total !== squadB.total ? `${prevSquadB.total} → ` : ''}${squadB.total}
                    </div>
                </div>
            </div>
        </div>
    `;
}


        // 增加小隊積分
        function addSquadScore(squadId, points) {
            squadScores[squadId] = (squadScores[squadId] || 0) + points;
            console.log(`小隊 #${squadId} 獲得 ${points} 積分，總積分：${squadScores[squadId]}`);
        }

        // 重置競技場戰鬥
        function resetArenaBattle() {
            selectedSquadA = null;
            selectedSquadB = null;
            selectedArenaMap = null;
            
            // 清除地圖選擇狀態
            document.querySelectorAll('.arena-map-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 清除小隊選擇狀態
            document.querySelectorAll('.squad-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // 隱藏地圖效果
            const mapEffects = document.getElementById('arena-map-effects');
            if (mapEffects) {
                mapEffects.classList.remove('visible');
            }
            
            // 重新更新小隊選項（移除地圖效果）
            updateArenaSquadOptions();
            
            // 重置顯示
            const squadAName = document.getElementById('squad-a-name');
            const squadATotal = document.getElementById('squad-a-total');
            const squadBName = document.getElementById('squad-b-name');
            const squadBTotal = document.getElementById('squad-b-total');
            const squadASkills = document.getElementById('squad-a-skills');
            const squadBSkills = document.getElementById('squad-b-skills');
            
            if (squadAName) squadAName.textContent = '選擇小隊 A';
            if (squadATotal) {
                squadATotal.textContent = '總點數: --';
                squadATotal.style.color = '#ffd700';
            }
            if (squadBName) squadBName.textContent = '選擇小隊 B';
            if (squadBTotal) {
                squadBTotal.textContent = '總點數: --';
                squadBTotal.style.color = '#ffd700';
            }
            if (squadASkills) squadASkills.style.display = 'none';
            if (squadBSkills) squadBSkills.style.display = 'none';
            
            // 重置按鈕狀態
            const revealBtn = document.getElementById('reveal-skills-btn');
            const skillsRevealed = document.getElementById('skills-revealed');
            
            if (revealBtn) {
                revealBtn.style.display = 'block';
                revealBtn.disabled = true;
                revealBtn.textContent = '🔍 公布技能並開始對戰';
            }
            
            if (skillsRevealed) {
                skillsRevealed.style.display = 'none';
                skillsRevealed.innerHTML = '';
            }
            
            // 重置戰鬥按鈕
            updateArenaBattleButton();
            
            // 隱藏結果
            const resultsContainer = document.getElementById('comparison-results');
            if (resultsContainer) {
                resultsContainer.classList.remove('active');
                resultsContainer.innerHTML = '';
            }
        }

        // 公布技能
// 公布技能
function revealSkills() {
    if (!selectedSquadA || !selectedSquadB || selectedSquadA === selectedSquadB || !selectedArenaMap) {
        alert('請選擇兩支不同的小隊和一個地圖！');
        return;
    }
    
    
    // 🆕 新增：在公布技能時就處理很黏的膠帶
    let skillsChanged = false;
    
    // 檢查小隊A是否有很黏的膠帶
    if (squadItemCards[selectedSquadA] === 'sticky_tape' && squadItemCards[selectedSquadB]) {
        const opponentCardName = itemCards[squadItemCards[selectedSquadB]].name;
        const shouldSteal = confirm(
            `小隊 #${selectedSquadA} 擁有很黏的膠帶！\n\n` +
            `是否要奪取小隊 #${selectedSquadB} 的技能卡「${opponentCardName}」？\n\n` +
            `選擇「確定」將奪取對方技能卡\n` +
            `選擇「取消」將保留自己的膠帶`
        );
        
        if (shouldSteal) {
            // 執行奪取
            delete takenItems['sticky_tape'];
            squadItemCards[selectedSquadA] = squadItemCards[selectedSquadB];
            takenItems[squadItemCards[selectedSquadB]] = selectedSquadA;
            delete squadItemCards[selectedSquadB];
            skillsChanged = true;
            
            alert(`小隊 #${selectedSquadA} 成功奪取了「${opponentCardName}」！`);
        }
    }
    
    // 檢查小隊B是否有很黏的膠帶
    if (squadItemCards[selectedSquadB] === 'sticky_tape' && squadItemCards[selectedSquadA]) {
        const opponentCardName = itemCards[squadItemCards[selectedSquadA]].name;
        const shouldSteal = confirm(
            `小隊 #${selectedSquadB} 擁有很黏的膠帶！\n\n` +
            `是否要奪取小隊 #${selectedSquadA} 的技能卡「${opponentCardName}」？\n\n` +
            `選擇「確定」將奪取對方技能卡\n` +
            `選擇「取消」將保留自己的膠帶`
        );
        
        if (shouldSteal) {
            // 執行奪取
            delete takenItems['sticky_tape'];
            squadItemCards[selectedSquadB] = squadItemCards[selectedSquadA];
            takenItems[squadItemCards[selectedSquadA]] = selectedSquadB;
            delete squadItemCards[selectedSquadA];
            skillsChanged = true;
            
            alert(`小隊 #${selectedSquadB} 成功奪取了「${opponentCardName}」！`);
        }
    }
    

    
    // 如果技能卡有變動，更新顯示
    if (skillsChanged) {
        updateSquadDisplay('A', selectedSquadA);
        updateSquadDisplay('B', selectedSquadB);
    }
    
    const skillsRevealed = document.getElementById('skills-revealed');
    if (!skillsRevealed) return;
    
    skillsRevealed.innerHTML = '';
    skillsRevealed.style.display = 'block';
    
    // 創建技能公布內容
    const revealContent = document.createElement('div');
    revealContent.innerHTML = `
        <div class="skills-revealed-title">⚡ 技能公布 ⚡</div>
    `;
    
    // 公布小隊A的技能
    const squadAInfo = createSquadSkillInfo(selectedSquadA, 'A');
    revealContent.appendChild(squadAInfo);
    
    // 公布小隊B的技能
    const squadBInfo = createSquadSkillInfo(selectedSquadB, 'B');
    revealContent.appendChild(squadBInfo);
    
    skillsRevealed.appendChild(revealContent);
    
    // 顯示詳細的數值變化過程
    const detailedCalculation = createDetailedCalculation();
    skillsRevealed.appendChild(detailedCalculation);
    
    // 創建開始戰鬥按鈕
    const startBattleBtn = document.createElement('button');
    startBattleBtn.className = 'battle-button-arena';
    startBattleBtn.textContent = '開始計算戰鬥結果';
    startBattleBtn.onclick = startEnhancedArenaBattle;
    skillsRevealed.appendChild(startBattleBtn);
    
    // 隱藏公布按鈕
    document.getElementById('reveal-skills-btn').style.display = 'none';
}


function updateSkillsRevealed() {
    const skillsRevealed = document.getElementById('skills-revealed');
    if (!skillsRevealed || skillsRevealed.style.display === 'none') return;
    
    // 清空現有內容但保留顯示狀態
    skillsRevealed.innerHTML = '';
    
    // 重新創建技能公布內容
    const revealContent = document.createElement('div');
    revealContent.innerHTML = `
        <div class="skills-revealed-title">⚡ 技能公布${bettingSystem.enabled ? '' : '（技能卡已更新）'} ⚡</div>
    `;
    
    // 公布小隊A的技能（使用最新的技能卡信息）
    const squadAInfo = createSquadSkillInfo(selectedSquadA, 'A');
    revealContent.appendChild(squadAInfo);
    
    // 公布小隊B的技能（使用最新的技能卡信息）
    const squadBInfo = createSquadSkillInfo(selectedSquadB, 'B');
    revealContent.appendChild(squadBInfo);
    
    skillsRevealed.appendChild(revealContent);
    
    // 顯示詳細的數值變化過程
    const detailedCalculation = createDetailedCalculation();
    skillsRevealed.appendChild(detailedCalculation);
    
    // 創建開始戰鬥按鈕
    const startBattleBtn = document.createElement('button');
    startBattleBtn.className = 'battle-button-arena';
    startBattleBtn.textContent = '開始計算戰鬥結果';
    startBattleBtn.onclick = startEnhancedArenaBattle;
    skillsRevealed.appendChild(startBattleBtn);
}

        // 更新技能預覽
function updateSkillPreview() {
    const previewContent = document.getElementById('skill-preview-content');
    if (!previewContent) return;
    
    try {
        // 獲取原始數據（深拷貝）
        const originalSquadA = {};
        const originalSquadB = {};
        attributes.forEach(attr => {
            originalSquadA[attr] = squadData[selectedSquadA][attr];
            originalSquadB[attr] = squadData[selectedSquadB][attr];
        });
        originalSquadA.total = squadData[selectedSquadA].total;
        originalSquadB.total = squadData[selectedSquadB].total;
        
        // 應用地圖效果
        let modifiedSquadA = applyMapEffects(originalSquadA, selectedArenaMap);
        let modifiedSquadB = applyMapEffects(originalSquadB, selectedArenaMap);
        
        // 應用被動技能效果（使用深拷貝）
        modifiedSquadA = applyPassiveSkillEffects({...modifiedSquadA}, selectedSquadA, selectedSquadB);
        modifiedSquadB = applyPassiveSkillEffects({...modifiedSquadB}, selectedSquadB, selectedSquadA);
        
        // 應用技能卡效果（使用深拷貝，與實際戰鬥計算保持一致）
        const cardResults = applyItemCardEffects({...modifiedSquadA}, {...modifiedSquadB}, selectedSquadA, selectedSquadB);
        modifiedSquadA = cardResults.squadA;
        modifiedSquadB = cardResults.squadB;
        
        // 顯示對比
        previewContent.innerHTML = `
            <div class="total-vs-display">
                <div class="total-squad-info">
                    <div class="total-squad-name">小隊 #${selectedSquadA}</div>
                    <div style="color: #ffd700; font-size: 1em; margin: 5px 0;">
                        原始: ${originalSquadA.total} → 修正後: ${modifiedSquadA.total}
                    </div>
                    <div class="total-value">${modifiedSquadA.total}</div>
                </div>
                
                <div class="total-vs-text">VS</div>
                
                <div class="total-squad-info">
                    <div class="total-squad-name">小隊 #${selectedSquadB}</div>
                    <div style="color: #ffd700; font-size: 1em; margin: 5px 0;">
                        原始: ${originalSquadB.total} → 修正後: ${modifiedSquadB.total}
                    </div>
                    <div class="total-value">${modifiedSquadB.total}</div>
                </div>
            </div>
            
            <div class="attribute-details" style="margin-top: 20px;">
                <div class="details-title">📊 詳細能力值變化</div>
                <div class="details-grid">
                    ${attributes.map(attr => {
                        const originalA = originalSquadA[attr];
                        const modifiedA = modifiedSquadA[attr];
                        const originalB = originalSquadB[attr];
                        const modifiedB = modifiedSquadB[attr];
                        
                        return `
                            <div class="detail-row">
                                <div class="detail-value">
                                    ${originalA !== modifiedA ? `${originalA}→${modifiedA}` : modifiedA}
                                </div>
                                <div class="detail-attr">${attributeIcons[attr]} ${attributeNames[attr]}</div>
                                <div class="detail-value">
                                    ${originalB !== modifiedB ? `${originalB}→${modifiedB}` : modifiedB}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
        
        console.log('Skill preview updated successfully');
        console.log('Squad A:', originalSquadA.total, '→', modifiedSquadA.total);
        console.log('Squad B:', originalSquadB.total, '→', modifiedSquadB.total);
        
    } catch (error) {
        console.error('Error updating skill preview:', error);
        previewContent.innerHTML = `<div style="color: red; text-align: center;">預覽計算錯誤: ${error.message}</div>`;
    }
}

        // 創建小隊技能信息
        function createSquadSkillInfo(squadId, side) {
            const squadInfo = document.createElement('div');
            squadInfo.className = 'squad-skill-info';
            
            let content = `<div class="squad-skill-name">小隊 #${squadId} (${side}隊)</div>`;
            // 🆕 檢查是否有超大根球棒
    const hasBaseballBat = squadItemCards[selectedSquadA] === 'baseball_bat' || squadItemCards[selectedSquadB] === 'baseball_bat';
    
            // 被動技能
            if (squadPassiveSkills[squadId]) {
                const passiveSkill = passiveSkills[squadPassiveSkills[squadId]];
                content += `
                    <div class="skill-details">
                        <div class="skill-type">🔥 被動技能</div>
                        <div class="skill-description">技能名稱：${passiveSkill.name}</div>
                        <div class="skill-effect">效果：${getPassiveSkillDescription(squadPassiveSkills[squadId])}</div>
                    </div>
                `;
            } else {
                content += `
                    <div class="skill-details">
                        <div class="skill-type">🔥 被動技能</div>
                        <div class="skill-description">無被動技能</div>
                    </div>
                `;
            }
            
            // 技能卡
            if (squadItemCards[squadId]) {
                const itemCard = itemCards[squadItemCards[squadId]];
                content += `
                    <div class="skill-details">
                        <div class="skill-type">🎯 技能卡</div>
                        <div class="skill-description">${itemCard.description}</div>
                        <div class="skill-effect">效果：${getItemCardDescription(squadItemCards[squadId])}</div>
                    </div>
                `;
            } else {
                content += `
                    <div class="skill-details">
                        <div class="skill-type">🎯 技能卡</div>
                        <div class="skill-description">無技能卡</div>
                    </div>
                `;
            }
            
            squadInfo.innerHTML = content;
            return squadInfo;
        }
        // 創建詳細計算過程顯示
function createDetailedCalculation() {
    const container = document.createElement('div');
    container.className = 'total-comparison';
    container.innerHTML = `<div class="total-comparison-title">📊 詳細數值變化過程 📊</div>`;
    
    try {
        // ⚠️ 修改：使用當前的隊伍ID獲取數據
        const originalSquadA = {...squadData[selectedSquadA]};
        const originalSquadB = {...squadData[selectedSquadB]};
        
        console.log(`創建詳細計算 - 當前對戰：小隊 #${selectedSquadA} VS 小隊 #${selectedSquadB}`);
        console.log('原始數據:', originalSquadA.total, originalSquadB.total);
        
        // 使用與實際戰鬥相同的計算邏輯
        const battleResult = calculateBattleResult(originalSquadA, originalSquadB);
        
        // 創建階段顯示
        const stagesDiv = document.createElement('div');
        stagesDiv.style.cssText = 'margin-top: 20px;';
        
        // 階段0：原始數值
        stagesDiv.appendChild(createStageDisplay('原始能力值', battleResult.originalSquadA, battleResult.originalSquadB, null, null));
        
        // 階段1：地圖效果
        const mapName = arenaMaps[selectedArenaMap].name;
        stagesDiv.appendChild(createStageDisplay(`地圖效果：${mapName}`, battleResult.stage1SquadA, battleResult.stage1SquadB, battleResult.originalSquadA, battleResult.originalSquadB));
        
        // 階段2：被動技能
        stagesDiv.appendChild(createStageDisplay(`被動技能效果`, battleResult.stage2SquadA, battleResult.stage2SquadB, battleResult.stage1SquadA, battleResult.stage1SquadB));
        
        // 階段3：技能卡效果
        stagesDiv.appendChild(createStageDisplay(`技能卡效果`, battleResult.finalSquadA, battleResult.finalSquadB, battleResult.stage2SquadA, battleResult.stage2SquadB));
        
        container.appendChild(stagesDiv);
        
        console.log('詳細計算顯示創建成功');
        
    } catch (error) {
        console.error('創建詳細計算顯示錯誤:', error);
        container.innerHTML += `<div style="color: red; text-align: center; margin-top: 20px;">計算過程顯示錯誤: ${error.message}</div>`;
    }
    
    return container;
}

// 創建階段顯示
function createStageDisplay(stageName, squadA, squadB, prevSquadA, prevSquadB) {
    const stageDiv = document.createElement('div');
    stageDiv.style.cssText = 'background: rgba(255, 255, 255, 0.05); border-radius: 15px; padding: 20px; margin-bottom: 15px; border: 1px solid rgba(255, 255, 255, 0.2);';
    
    let content = `
        <div style="color: #ffd700; font-size: 1.2em; font-weight: bold; text-align: center; margin-bottom: 15px;">
            ⚔️ ${stageName} ⚔️
        </div>
        <div style="display: grid; grid-template-columns: 1fr auto 1fr; gap: 20px; align-items: start;">
            <div>
                <div style="color: #00ffff; font-weight: bold; text-align: center; margin-bottom: 10px;">小隊 #${selectedSquadA}</div>
                ${createAttributesList(squadA, prevSquadA)}
                <div style="color: #ffd700; font-size: 1.1em; font-weight: bold; text-align: center; margin-top: 10px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                    總點數: ${prevSquadA ? `${prevSquadA.total} → ` : ''}${squadA.total}
                </div>
            </div>
            <div style="color: #ff4757; font-size: 2em; font-weight: bold; align-self: center;">VS</div>
            <div>
                <div style="color: #00ffff; font-weight: bold; text-align: center; margin-bottom: 10px;">小隊 #${selectedSquadB}</div>
                ${createAttributesList(squadB, prevSquadB)}
                <div style="color: #ffd700; font-size: 1.1em; font-weight: bold; text-align: center; margin-top: 10px; padding: 10px; background: rgba(255, 215, 0, 0.1); border-radius: 8px;">
                    總點數: ${prevSquadB ? `${prevSquadB.total} → ` : ''}${squadB.total}
                </div>
            </div>
        </div>
    `;
    
    stageDiv.innerHTML = content;
    return stageDiv;
}

// 創建屬性列表
function createAttributesList(squad, prevSquad) {
    let html = '<div style="display: grid; gap: 5px;">';
    
    attributes.forEach(attr => {
        const current = squad[attr];
        const prev = prevSquad ? prevSquad[attr] : null;
        const changed = prev !== null && prev !== current;
        
        let valueText = current.toString();
        if (changed) {
            valueText = `${prev} → ${current}`;
        }
        
        let color = '#fff';
        let bgColor = 'rgba(0, 0, 0, 0.3)';
        
        if (changed) {
            if (current > prev) {
                color = '#00ff88';
                bgColor = 'rgba(0, 255, 136, 0.1)';
            } else if (current < prev) {
                color = '#ff4757';
                bgColor = 'rgba(255, 71, 87, 0.1)';
            }
        }
        
        html += `
            <div style="display: grid; grid-template-columns: 40px 100px 100px; gap: 10px; align-items: center; padding: 5px; background: ${bgColor}; border-radius: 5px; ${changed ? 'border: 1px solid ' + color + ';' : ''}">
                <div style="text-align: center;">${attributeIcons[attr]}</div>
                <div style="color: #ccc; font-size: 0.9em;">${attributeNames[attr]}</div>
                <div style="color: ${color}; font-weight: bold; text-align: right;">${valueText}</div>
            </div>
        `;
    });
    
    html += '</div>';
    return html;
}

        // 獲取被動技能描述
        function getPassiveSkillDescription(skillKey) {
            const skill = passiveSkills[skillKey];
            if (!skill) return '無效果';
            
            let description = '';
            Object.keys(skill.effects).forEach(attr => {
                const multiplier = skill.effects[attr];
                if (attr === 'opponent_all') {
                    description += `對方所有能力值 ×${multiplier} `;
                } else {
                    const attrName = attributeNames[attr];
                    description += `${attrName} ×${multiplier} `;
                }
            });
            
            return description;
        }

        // 獲取技能卡描述
        function getItemCardDescription(itemKey) {
            const item = itemCards[itemKey];
            if (!item) return '無效果';
            
            if (item.type === 'special') {
                return getSpecialItemDescription(item);
            }
            
            let description = '';
            Object.keys(item.effects).forEach(attr => {
                const multiplier = item.effects[attr];
                if (attr === 'all') {
                    description += `所有能力值 ×${multiplier} `;
                } else {
                    const attrName = attributeNames[attr];
                    if (multiplier === 0) {
                        description += `${attrName} → 0 `;
                    } else {
                        description += `${attrName} ×${multiplier} `;
                    }
                }
            });
            
            return description;
        }

        // 獲取特殊技能卡描述
        function getSpecialItemDescription(item) {
            const special = item.special;
            let baseEffect = '';
            
            if (item.effects.all) {
                baseEffect = `所有能力值 ×${item.effects.all} + `;
            }
            
            switch (special) {
case 'retry_battle':
    return baseEffect + '戰後可重選地圖再戰';
                case 'reverse_result':
                    return '輸的一方變成勝者';
                case 'choose_opponent':
                    return baseEffect + '可選擇避戰或換對手';
                case 'zero_max_attribute':
                    return baseEffect + '自行選擇將對手一項能力歸0';
                case 'steal_attribute':
                    return baseEffect + '戰後盜取對手能力直到自己100或對方0';
                case 'underdog_boost':
                    return '原始能力總和較低時，所有個別能力值×1.5';
                case 'skip_battle':
                    return '直接成為勝利者';
                case 'balance_attribute':
                    return baseEffect + '選擇一項能力兩隊相加後平分';    
                case 'steal_item':
                    return '奪取對方技能卡';
                case 'mutual_score':
                    return '雙方同意可各得120分';
                case 'reduce_opponent':
                    return baseEffect + '戰後減少對手各能力15點';
                case 'high_risk_reward':
    return baseEffect + '勝利+200分，失敗永久-10能力';
                
                case 'disable_passive':
                    return baseEffect + '消除對方被動技能';
                case 'swap_passive':
                    return baseEffect + '交換雙方被動技能';
                default:
                    return '特殊效果';
            }
        }

        // ======== 道具牆相關函數 ========
        
        // 初始化道具牆
        function initializeItemsWall() {
            const itemsGrid = document.getElementById('items-grid');
            if (!itemsGrid) return;
            
            itemsGrid.innerHTML = '';
            
            Object.keys(itemCards).forEach(itemKey => {
                const item = itemCards[itemKey];
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.setAttribute('data-item-key', itemKey);
                
                // 檢查是否已被永久使用
                if (permanentlyUsedItems[itemKey]) {
                    itemCard.classList.add('taken');
                    itemCard.style.background = 'rgba(128, 128, 128, 0.3)';
                    itemCard.style.opacity = '0.4';
                    itemCard.onclick = () => {
                        alert('此技能卡已在戰鬥中使用過，無法再選擇！');
                    };
                    itemCard.innerHTML = `
                        <div class="item-name">${item.name}</div>
                        <div class="item-taken-by" style="color: #888;">已使用</div>
                    `;
                }
                // 檢查是否已被選擇
                else if (takenItems[itemKey]) {
                    const takenBy = takenItems[itemKey];
                    itemCard.classList.add('taken');
                    itemCard.onclick = () => {
                        alert(`此技能卡已被小隊 #${takenBy} 選擇！`);
                    };
                    itemCard.innerHTML = `
                        <div class="item-name">${item.name}</div>
                        <div class="item-taken-by">小隊 #${takenBy}</div>
                    `;
                }
                // 可選擇的道具卡
                else {
                    itemCard.onclick = () => selectItemCard(itemKey);
                    itemCard.innerHTML = `
                        <div class="item-name">${item.name}</div>
                    `;
                }
                
                itemsGrid.appendChild(itemCard);
            });
        }

        // 選擇技能卡
        function selectItemCard(itemKey) {
    // 檢查是否已被永久使用
    if (permanentlyUsedItems[itemKey]) {
        alert('此技能卡已被使用過，無法再選擇！');
        return;
    }
    
    // 檢查是否已被選擇
    if (takenItems[itemKey]) {
        alert(`此技能卡已被小隊 #${takenItems[itemKey]} 選擇！`);
        return;
    }
    
    // 清除之前的選擇
    document.querySelectorAll('.item-card').forEach(card => {
        card.classList.remove('selected');
    });
    
    // 選擇新卡片
    selectedItemCard = itemKey;
    const cardElement = document.querySelector(`[data-item-key="${itemKey}"]`);
    if (cardElement) {
        cardElement.classList.add('selected');
    }
    
    // 更新顯示
    updateSelectedItemDisplay();
    updateAssignButton();
}

        // 更新選中技能卡顯示
        function updateSelectedItemDisplay() {
    const container = document.getElementById('squad-buttons');
    if (!container) return;
    
    container.innerHTML = '';
    
    for (let squadId = 1; squadId <= 10; squadId++) {
        const button = document.createElement('button');
        button.className = 'squad-btn';
        button.setAttribute('data-squad-id', squadId);
        
        let buttonText = `小隊 #${squadId}`;
        
        // 檢查是否已參與戰鬥
        const hasBattled = battleParticipatedSquads[squadId];
        
        if (squadItemCards[squadId]) {
            const itemName = itemCards[squadItemCards[squadId]].name;
            
            if (hasBattled) {
                // 已戰鬥的小隊顯示特殊樣式，可以重新選擇
                buttonText += `\n(${itemName} - 已戰鬥)`;
                button.style.fontSize = '0.8em';
                button.style.background = 'rgba(138, 43, 226, 0.2)';
                button.style.borderColor = '#8a2be2';
                button.onclick = () => selectSquadForItem(squadId);
            } else {
                // 未戰鬥的小隊正常顯示
                buttonText += `\n(${itemName})`;
                button.style.fontSize = '0.9em';
                button.classList.add('has-item');
                button.style.opacity = '0.6';
                button.style.cursor = 'not-allowed';
                button.onclick = () => {
                    alert(`小隊 #${squadId} 已經擁有技能卡「${itemName}」！需要先參與戰鬥才能更換。`);
                };
            }
        } else {
            // 沒有道具的小隊
            if (hasBattled) {
                buttonText += '\n(可選新卡)';
                button.style.fontSize = '0.8em';
                button.style.borderColor = '#00ff88';
            }
            button.onclick = () => selectSquadForItem(squadId);
        }
        
        button.textContent = buttonText;
        container.appendChild(button);
    }
}

        // 選擇要分配技能卡的小隊
        function selectSquadForItem(squadId) {
    // 檢查小隊是否已經有道具卡且未戰鬥
    if (squadItemCards[squadId] && !battleParticipatedSquads[squadId]) {
        alert(`小隊 #${squadId} 已經擁有技能卡「${itemCards[squadItemCards[squadId]].name}」！需要先參與戰鬥才能更換。`);
        return;
    }
    
    // 清除之前的選擇
    document.querySelectorAll('.squad-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    // 選擇新小隊
    selectedSquadForItem = squadId;
    const btnElement = document.querySelector(`[data-squad-id="${squadId}"]`);
    if (btnElement) {
        btnElement.classList.add('selected');
    }
    
    updateAssignButton();
}

        // 更新分配按鈕狀態
        function updateAssignButton() {
            const assignBtn = document.getElementById('assign-btn');
            if (!assignBtn) return;
            
            const canAssign = selectedItemCard && selectedSquadForItem && !takenItems[selectedItemCard];
            
            assignBtn.disabled = !canAssign;
            
            if (canAssign) {
                assignBtn.textContent = `分配給小隊 #${selectedSquadForItem}`;
            } else {
                assignBtn.textContent = '分配技能卡';
            }
        }

        // 分配技能卡給小隊
        function assignItemToSquad() {
    if (!selectedItemCard || !selectedSquadForItem) {
        alert('請先選擇技能卡和小隊！');
        return;
    }
    
    if (permanentlyUsedItems[selectedItemCard]) {
        alert('此技能卡已被使用過，無法再選擇！');
        return;
    }
    
    if (takenItems[selectedItemCard]) {
        alert('此技能卡已被選擇！');
        return;
    }
    
    // 檢查小隊是否已經有道具卡且未戰鬥
    if (squadItemCards[selectedSquadForItem] && !battleParticipatedSquads[selectedSquadForItem]) {
        alert(`小隊 #${selectedSquadForItem} 已經擁有技能卡且尚未戰鬥，無法更換！`);
        return;
    }
    
    // 記錄操作前的狀態（新增）
    const previousItem = squadItemCards[selectedSquadForItem] || null;
    const operationRecord = {
        squadId: selectedSquadForItem,
        newItem: selectedItemCard,
        previousItem: previousItem,
        timestamp: Date.now()
    };
    
    
    itemAssignmentHistory.push(operationRecord);
    
    // 如果小隊之前有道具，先釋放它（但已戰鬥的道具會被標記為永久使用）
    if (squadItemCards[selectedSquadForItem]) {
        const oldItem = squadItemCards[selectedSquadForItem];
        delete takenItems[oldItem];
    }
    
    // 分配新技能卡
    squadItemCards[selectedSquadForItem] = selectedItemCard;
    takenItems[selectedItemCard] = selectedSquadForItem;
    
    const itemName = itemCards[selectedItemCard].name;
    alert(`小隊 #${selectedSquadForItem} 已獲得技能卡：${itemName}`);
    
    // 重置選擇
    selectedItemCard = null;
    selectedSquadForItem = null;
    
    // 更新顯示
    initializeItemsWall();
    updateSquadButtonsForItems();
    updateSelectedItemDisplay();
    updateAssignButton();
    updateUndoButton();
}
// 撤銷上一步道具分配
function undoLastAssignment() {
    if (itemAssignmentHistory.length === 0) {
        alert('沒有可以撤銷的操作！');
        return;
    }
    
    // 獲取最後一次操作
    const lastOperation = itemAssignmentHistory.pop();
    const { squadId, newItem, previousItem } = lastOperation;
    
    // 撤銷操作
    // 1. 釋放當前的道具
    delete takenItems[newItem];
    
    // 2. 恢復之前的道具（如果有）
    if (previousItem) {
        squadItemCards[squadId] = previousItem;
        takenItems[previousItem] = squadId;
    } else {
        delete squadItemCards[squadId];
    }
    
    // 顯示撤銷信息
    const undoneItemName = itemCards[newItem].name;
    if (previousItem) {
        const previousItemName = itemCards[previousItem].name;
        alert(`已撤銷：小隊 #${squadId} 的「${undoneItemName}」已移除，恢復為「${previousItemName}」`);
    } else {
        alert(`已撤銷：小隊 #${squadId} 的「${undoneItemName}」已移除`);
    }
    
    // 更新顯示
    initializeItemsWall();
    updateSquadButtonsForItems();
    updateSelectedItemDisplay();
    updateAssignButton();
    updateUndoButton();
}

// 更新 undo 按鈕狀態
function updateUndoButton() {
    const undoBtn = document.getElementById('undo-btn');
    if (!undoBtn) {
        console.warn('Undo button not found!');
        return;
    }
    
    // 只有在有操作歷史時才啟用按鈕
    undoBtn.disabled = itemAssignmentHistory.length === 0;
    
    if (itemAssignmentHistory.length > 0) {
        undoBtn.textContent = `↩️ 撤銷上一步 (${itemAssignmentHistory.length})`;
    } else {
        undoBtn.textContent = '↩️ 撤銷上一步';
    }
    
    console.log('Undo button updated, history length:', itemAssignmentHistory.length);
}
        // ======== 被動技能相關函數 ========
        
        // 更新被動技能選項
        function updatePassiveSkillOptions() {
            for (let squadId = 1; squadId <= 10; squadId++) {
                const select = document.getElementById(`passive-skill-${squadId}`);
                if (!select) continue;
                
                // 清空現有選項（保留第一個空選項）
                select.innerHTML = '<option value="">選擇被動技能</option>';
                
                // 獲取已被其他小隊選擇的技能
                const takenSkills = [];
                for (let otherId = 1; otherId <= 10; otherId++) {
                    if (otherId !== squadId && squadPassiveSkills[otherId]) {
                        takenSkills.push(squadPassiveSkills[otherId]);
                    }
                }
                
                // 添加可用的被動技能選項
                Object.keys(passiveSkills).forEach(skillKey => {
                    if (!takenSkills.includes(skillKey)) {
                        const option = document.createElement('option');
                        option.value = skillKey;
                        option.textContent = passiveSkills[skillKey].name;
                        select.appendChild(option);
                    }
                });
                
                // 設置當前選中的技能
                if (squadPassiveSkills[squadId]) {
                    select.value = squadPassiveSkills[squadId];
                }
                
                // 更新顯示
                updatePassiveSkillDisplay(squadId);
            }
        }

        // 分配被動技能
        function assignPassiveSkill(squadId, skillKey) {
            if (skillKey === '') {
                squadPassiveSkills[squadId] = null;
            } else {
                // 檢查是否已被其他小隊選擇
                for (let otherId = 1; otherId <= 10; otherId++) {
                    if (otherId !== squadId && squadPassiveSkills[otherId] === skillKey) {
                        alert(`技能「${passiveSkills[skillKey].name}」已被小隊 #${otherId} 選擇！`);
                        document.getElementById(`passive-skill-${squadId}`).value = squadPassiveSkills[squadId] || '';
                        return;
                    }
                }
                
                squadPassiveSkills[squadId] = skillKey;
                alert(`小隊 #${squadId} 已獲得被動技能：${passiveSkills[skillKey].name}`);
            }
            
            updatePassiveSkillDisplay(squadId);
            updatePassiveSkillOptions(); // 更新所有小隊的選項
        }

        // 更新被動技能顯示
        function updatePassiveSkillDisplay(squadId) {
            const display = document.getElementById(`current-passive-${squadId}`);
            if (!display) return;
            
            if (squadPassiveSkills[squadId]) {
                const skillName = passiveSkills[squadPassiveSkills[squadId]].name;
                display.textContent = `已選擇：${skillName}`;
            } else {
                display.textContent = '未選擇被動技能';
            }
        }

        // ======== 下注系統相關函數 ========
        
function startBetting() {
    if (!selectedSquadA || !selectedSquadB || selectedSquadA === selectedSquadB) {
        alert('請先選擇兩支不同的對戰小隊！');
        return;
    }
    
    bettingSystem.enabled = true;
    bettingSystem.bets = {};
    
    // 顯示下注界面 - 修改變數名稱避免衝突
    const bettingSystemDiv = document.getElementById('betting-system');
    const bettingOptions = document.getElementById('betting-options');
    const bettingParticipants = document.getElementById('betting-participants');
    const bettingSummary = document.getElementById('betting-summary');
    
    if (bettingSystemDiv) bettingSystemDiv.classList.add('active');
    if (bettingOptions) bettingOptions.style.display = 'grid';
    if (bettingParticipants) bettingParticipants.style.display = 'block';
    if (bettingSummary) bettingSummary.style.display = 'grid';
    
    // 更新下注信息
    updateBettingInfo();
    updateBettingGrid();
    updateBettingSummary();
    updateBettingOdds();
    
    // 更新按鈕狀態
    const startBtn = document.getElementById('start-betting-btn');
    const clearBtn = document.getElementById('clear-bets-btn');
    if (startBtn) startBtn.disabled = true;
    if (clearBtn) clearBtn.disabled = false;
    
    console.log('下注系統已啟動');
}

        // 更新下注信息
        function updateBettingInfo() {
            const matchupElement = document.getElementById('betting-matchup');
            const squadAElement = document.getElementById('betting-squad-a');
            const squadBElement = document.getElementById('betting-squad-b');
            
            if (matchupElement) {
                matchupElement.textContent = `小隊 #${selectedSquadA} VS 小隊 #${selectedSquadB}`;
            }
            if (squadAElement) {
                squadAElement.textContent = `小隊 #${selectedSquadA}`;
            }
            if (squadBElement) {
                squadBElement.textContent = `小隊 #${selectedSquadB}`;
            }
        }

        // 更新下注參與者網格
        function updateBettingGrid() {
            const bettingGrid = document.getElementById('betting-grid');
            if (!bettingGrid) return;
            
            bettingGrid.innerHTML = '';
            
            for (let squadId = 1; squadId <= 10; squadId++) {
                // 跳過對戰的兩支隊伍
                if (squadId === selectedSquadA || squadId === selectedSquadB) continue;
                
                const squadBtn = document.createElement('div');
                squadBtn.className = 'betting-squad-btn';
                squadBtn.setAttribute('data-squad-id', squadId);
                squadBtn.onclick = () => toggleSquadBet(squadId);
                
                const currentBet = bettingSystem.bets[squadId];
                if (currentBet === 'A') {
                    squadBtn.classList.add('bet-a');
                    squadBtn.textContent = `小隊 #${squadId}\n(押 A)`;
                } else if (currentBet === 'B') {
                    squadBtn.classList.add('bet-b');
                    squadBtn.textContent = `小隊 #${squadId}\n(押 B)`;
                } else {
                    squadBtn.textContent = `小隊 #${squadId}\n(未下注)`;
                }
                
                bettingGrid.appendChild(squadBtn);
            }
        }

        // 切換小隊下注
        function toggleSquadBet(squadId) {
            if (!bettingSystem.enabled) return;
            
            const currentBet = bettingSystem.bets[squadId];
            
            // 循環切換：未下注 -> 押A -> 押B -> 未下注
            if (!currentBet) {
                bettingSystem.bets[squadId] = 'A';
            } else if (currentBet === 'A') {
                bettingSystem.bets[squadId] = 'B';
            } else {
                delete bettingSystem.bets[squadId];
            }
            
            updateBettingGrid();
            updateBettingSummary();
            updateBettingOdds();
        }

        // 選擇下注方（點擊左右側面板時的快速下注）
        function selectBettingSide(side) {
            if (!bettingSystem.enabled) return;
            
            // 找出還沒下注的隊伍，自動幫他們下注到這一方
            for (let squadId = 1; squadId <= 10; squadId++) {
                if (squadId === selectedSquadA || squadId === selectedSquadB) continue;
                if (!bettingSystem.bets[squadId]) {
                    bettingSystem.bets[squadId] = side;
                    break; // 只幫第一個未下注的隊伍下注
                }
            }
            
            updateBettingGrid();
            updateBettingSummary();
            updateBettingOdds();
        }

        // 更新下注統計
        function updateBettingSummary() {
            let countA = 0, countB = 0;
            
            Object.values(bettingSystem.bets).forEach(bet => {
                if (bet === 'A') countA++;
                if (bet === 'B') countB++;
            });
            
            const countAElement = document.getElementById('betting-count-a');
            const countBElement = document.getElementById('betting-count-b');
            
            if (countAElement) countAElement.textContent = countA;
            if (countBElement) countBElement.textContent = countB;
        }

        // 更新下注賠率
        function updateBettingOdds() {
            let countA = 0, countB = 0;
            
            Object.values(bettingSystem.bets).forEach(bet => {
                if (bet === 'A') countA++;
                if (bet === 'B') countB++;
            });
            
            const totalBets = countA + countB;
            
            if (totalBets === 0) {
                document.getElementById('betting-odds-a').textContent = '等待下注';
                document.getElementById('betting-odds-b').textContent = '等待下注';
                return;
            }
            
            // 計算賠率：基礎積分 × (1 + 對方下注數量 ÷ 總下注數量)
            const oddsA = totalBets > 0 ? bettingSystem.baseReward * (1 + countB / totalBets) : bettingSystem.baseReward;
            const oddsB = totalBets > 0 ? bettingSystem.baseReward * (1 + countA / totalBets) : bettingSystem.baseReward;
            
            document.getElementById('betting-odds-a').textContent = `獲勝可得: ${oddsA.toFixed(1)} 分`;
            document.getElementById('betting-odds-b').textContent = `獲勝可得: ${oddsB.toFixed(1)} 分`;
        }

        // 清空所有下注
        function clearAllBets() {
            bettingSystem.bets = {};
            updateBettingGrid();
            updateBettingSummary();
            updateBettingOdds();
        }

        // 計算下注獎勵
        function calculateBettingRewards(winner) {
            if (!bettingSystem.enabled || Object.keys(bettingSystem.bets).length === 0) {
                return { rewards: [], message: '沒有下注，無需結算' };
            }
            
            let countA = 0, countB = 0;
            const bettorsA = [];
            const bettorsB = [];
            
            Object.entries(bettingSystem.bets).forEach(([squadId, bet]) => {
                if (bet === 'A') {
                    countA++;
                    bettorsA.push(parseInt(squadId));
                } else if (bet === 'B') {
                    countB++;
                    bettorsB.push(parseInt(squadId));
                }
            });
            
            const totalBets = countA + countB;
            const rewards = [];
            
            if (totalBets === 0) {
                return { rewards: [], message: '沒有有效下注' };
            }
            
            let winnerText = '';
            if (winner === 'A') {
                // 小隊A獲勝，押A的人獲得獎勵
                const rewardPerSquad = bettingSystem.baseReward * (1 + countB / totalBets);
                bettorsA.forEach(squadId => {
                    addSquadScore(squadId, Math.round(rewardPerSquad));
                    rewards.push({
                        squadId: squadId,
                        points: Math.round(rewardPerSquad),
                        bet: 'A'
                    });
                });
                winnerText = `小隊 #${selectedSquadA} 獲勝！押中的隊伍獲得獎勵！`;
            } else if (winner === 'B') {
                // 小隊B獲勝，押B的人獲得獎勵
                const rewardPerSquad = bettingSystem.baseReward * (1 + countA / totalBets);
                bettorsB.forEach(squadId => {
                    addSquadScore(squadId, Math.round(rewardPerSquad));
                    rewards.push({
                        squadId: squadId,
                        points: Math.round(rewardPerSquad),
                        bet: 'B'
                    });
                });
                winnerText = `小隊 #${selectedSquadB} 獲勝！押中的隊伍獲得獎勵！`;
            } else {
                // 平手，所有下注者獲得基礎獎勵
                [...bettorsA, ...bettorsB].forEach(squadId => {
                    addSquadScore(squadId, bettingSystem.baseReward);
                    rewards.push({
                        squadId: squadId,
                        points: bettingSystem.baseReward,
                        bet: 'tie'
                    });
                });
                winnerText = '平手！所有下注者獲得基礎獎勵！';
            }
            
            return { rewards: rewards, message: winnerText };
        }

        // 顯示下注結算結果
        function displayBettingResults(bettingResults) {
            const bettingResultsDiv = document.getElementById('betting-results');
            const winnerText = document.getElementById('betting-winner-text');
            const rewardsContent = document.getElementById('betting-rewards-content');
            
            if (!bettingResultsDiv || !winnerText || !rewardsContent) return;
            
            bettingResultsDiv.classList.add('active');
            winnerText.textContent = bettingResults.message;
            
            rewardsContent.innerHTML = '';
            
            if (bettingResults.rewards.length === 0) {
                rewardsContent.innerHTML = '<div style="text-align: center; color: #888;">無獎勵發放</div>';
                return;
            }
            
            bettingResults.rewards.forEach(reward => {
                const rewardItem = document.createElement('div');
                rewardItem.className = 'betting-reward-item';
                
                let betText = '';
                if (reward.bet === 'A') {
                    betText = `押小隊 #${selectedSquadA}`;
                } else if (reward.bet === 'B') {
                    betText = `押小隊 #${selectedSquadB}`;
                } else {
                    betText = '平手獎勵';
                }
                
                rewardItem.innerHTML = `
                    <div class="betting-reward-squad">小隊 #${reward.squadId} (${betText})</div>
                    <div class="betting-reward-points">+${reward.points} 分</div>
                `;
                
                rewardsContent.appendChild(rewardItem);
            });
        }
        
        // 更新積分排行榜
        function updateRankings() {
            const rankingsList = document.getElementById('rankings-list');
            if (!rankingsList) return;
            
            // 創建排行數組
            const rankings = [];
            for (let squadId = 1; squadId <= 10; squadId++) {
                rankings.push({
                    id: squadId,
                    score: squadScores[squadId] || 0,
                    power: squadData[squadId]?.total || 40,
                    passive: squadPassiveSkills[squadId] ? passiveSkills[squadPassiveSkills[squadId]].name : '無',
                    item: squadItemCards[squadId] ? itemCards[squadItemCards[squadId]].name : '無'
                });
            }
            
            // 按積分排序
            rankings.sort((a, b) => b.score - a.score);
            
            rankingsList.innerHTML = '';
            
            rankings.forEach((squad, index) => {
                const rank = index + 1;
                const rankingItem = document.createElement('div');
                rankingItem.className = `ranking-item rank-${rank <= 3 ? rank : 'other'}`;
                
                rankingItem.innerHTML = `
                    <div class="rank-number">${rank}</div>
                    <div class="squad-info">
                        <div class="squad-rank-name">小隊 #${squad.id}</div>
                        <div class="squad-skills">被動：${squad.passive} | 道具：${squad.item}</div>
                    </div>
                    <div class="squad-score-container">
                        <input type="number" 
                            class="squad-score-input" 
                            id="score-input-${squad.id}" 
                            value="${squad.score}" 
                            min="0" 
                            max="9999"
                            onchange="updateSquadScore(${squad.id}, this.value)">
                        <button class="score-update-btn" onclick="confirmScoreUpdate(${squad.id})">✓</button>
                    </div>
                    <div class="squad-power">${squad.power} 戰力</div>
                `;
                
                rankingsList.appendChild(rankingItem);
            });
        }
        
        function updateSquadScore(squadId, newScore) {
            const score = parseInt(newScore);
            if (isNaN(score) || score < 0) {
                alert('請輸入有效的積分（0或以上）！');
                // 恢復原值
                document.getElementById(`score-input-${squadId}`).value = squadScores[squadId] || 0;
                return;
            }
            
            // 暫時儲存新積分（尚未確認）
            document.getElementById(`score-input-${squadId}`).setAttribute('data-new-score', score);
        }
        
        // 確認積分更新
        function confirmScoreUpdate(squadId) {
            const input = document.getElementById(`score-input-${squadId}`);
            const newScore = parseInt(input.getAttribute('data-new-score') || input.value);
            
            if (isNaN(newScore) || newScore < 0) {
                alert('請輸入有效的積分！');
                return;
            }
            
            const oldScore = squadScores[squadId] || 0;
            squadScores[squadId] = newScore;
            
            alert(`小隊 #${squadId} 積分已從 ${oldScore} 更新為 ${newScore}`);
            
            // 重新排序並更新顯示
            updateRankings();
        }
        // 創建星星背景
        function createStars() {
            const starsContainer = document.getElementById('stars');
            if (!starsContainer) return;
            
            const starCount = 100;
            
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                
                const size = Math.random() * 3 + 1;
                star.style.width = size + 'px';
                star.style.height = size + 'px';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.animationDelay = Math.random() * 3 + 's';
                
                starsContainer.appendChild(star);
            }
        }

        // 初始化
        window.addEventListener('load', () => {
            console.log('Starting initialization...');
            
            // 基本初始化
            try {
                initializeSquads();
                console.log('Squads initialized');
                
                createStars();
                console.log('Stars created');
                
                updateSquadCheckboxes();
                console.log('Squad checkboxes updated');
                
                updateSquadPointsDisplay();
                console.log('Squad points display updated');
                
                initializeArenaMaps();
                console.log('Arena maps initialized');
                
                updateUndoButton();
                console.log('Undo button initialized');
                
                // 初始化外星人血量
                for (let i = 1; i <= 10; i++) {
                    const input = document.querySelector(`.alien-${i} .hp-input`);
                    if (input) {
                        updateHp(i, input.value);
                    }
                }
                console.log('Alien HP initialized');
                
                console.log('All initialization completed successfully');
            } catch (error) {
                console.error('Initialization error:', error);
            }
        });
    </script>
</body>
</html>
